# リッチテキストエディター刷新計画

## 1. 現状分析

### 1.1 利用箇所

| 利用箇所 | フィールド | 現状のUI | データ形式 |
|----------|------------|----------|------------|
| 出品者紹介編集 | intro_html | Quill（ツールバー＋編集領域） | HTML |
| キャンペーン作成/編集 | body_html | Quill（ツールバー＋編集領域） | HTML + Delta |
| 商品作成/編集 | description_raw | プレーンテキスト textarea | 生テキスト → description_html へ変換 |

### 1.2 現状の課題

- **Quill 1.3.7** の制約
  - テーブル挿入がネイティブ非対応（Quill 標準では表をブロックとして扱えない）
  - 各画面で初期化・ツールバー定義が重複
  - ツールバーが常時表示で画面占有が大きい
- **UX の問題**
  - フォーム内にエディターが埋め込まれており、入力に集中しにくい
  - 画像挿入は別モーダルで、フローが分断
  - プレビューと編集の切り替えがない
- **商品説明**
  - 現状プレーンテキストのみ。リッチテキスト（見出し・画像・表など）が必要

---

## 2. 参考：note エディターの UI/UX 特徴

note のエディターを参考にし、以下の要素を取り入れる。

### 2.1 レイアウト・操作感

- **シンプルな余白**
  - 本文エリアが広く、余計なUI を抑えたレイアウト
  - 行間・文字サイズが読みやすい
- **ブロックベース入力**
  - 行頭の `+` や `/` でブロック種別を選択（見出し・リスト・画像・表など）
  - 必要なときだけツールやメニューを表示
- **インライン フォーマット**
  - テキスト選択時にツールチップで装飾（太字・リンク・取り消し線など）

### 2.2 必須機能

- 見出し（h2, h3）
- 箇条書き・番号付きリスト（階層対応）
- 太字・斜体・下線・取り消し線
- リンク
- 画像（ドラッグ&ドロップ、複数一括、alt・キャプション）
- **テーブル挿入**
- 引用（出典元記載可能）
- 区切り線
- Markdown ショートカット（`- `, `1. `, `##`, `---`, `~~` など）
- キーボードショートカット

### 2.3 入力体験

- 編集＝プレビューに近い見た目（WYSIWYG）
- コピペ時のスタイル保持
- モバイル対応（タッチ操作）

---

## 3. アーキテクチャ方針：専用エディターページ方式

### 3.1 基本コンセプト

**「入力専用ページ」** でリッチテキストを編集し、編集結果（HTML）を呼び出し元に戻す方式を採用する。

```
[商品編集フォーム]  [出品者紹介フォーム]  [キャンペーン編集フォーム]
        |                    |                      |
        v                    v                      v
    [説明を編集] ボタン  →  共通エディターページ  ←  戻り先URL・コンテキスト
        |                    |
        |                    v
        |              [リッチテキスト入力エリア]
        |                    |
        +<-------------------+
        |
   hidden input に HTML をセット
```

### 3.2 フロー

1. 各フォームに「説明を編集」「ストーリーを編集」などのボタンを配置
2. クリックで `/editor?context=product&return=/seller/listings/xxx/edit` のように専用ページへ遷移
3. 専用ページで初期HTMLを読み込み、エディターで編集
4. 「保存して戻る」で HTML をセッション/一時保存 or POST し、戻り先 URL へリダイレクト
5. 呼び出し元フォームは hidden input に受け取った HTML をセットし、そのまま送信

### 3.3 メリット

- エディターUIを1箇所に集約し、note風の広い編集画面を実現
- 表・画像・見出しなどを一括で実装しやすい
- モバイルでもフォームと分離した編集がしやすい

---

## 4. 技術選定

### 4.1 エディター候補

| 候補 | テーブル | カスタマイズ性 | サイズ | 備考 |
|------|----------|----------------|--------|------|
| **Tiptap** | ◎ 拡張可能 | ◎ | 中 | ブロックUI・スラッシュコマンドに適する |
| **Lexical** | ◎ | ◎ | 大 | Meta製、柔軟だが導入コスト高 |
| **Quill**（現行） | △ 要拡張 | ○ | 小 | 現状利用中だがテーブルは別モジュール必要 |
| **ProseMirror** | ◎ | ◎ | 中 | Tiptap の基盤 |

**推奨：Tiptap**

- ブロックメニュー（`/` コマンド）を標準でサポート
- テーブル拡張が公式
- React なしでも Vanilla JS で利用可能
- note に近いブロックUIを組みやすい

### 4.2 データ形式

- **保存形式**：HTML（既存の description_html, intro_html, body_html と統一）
- **サニタイズ**：サーバー側で sanitize-html を使用（既存の運用を継承）

---

## 5. 実装計画

### Phase 1：専用エディターページの基盤（約1週間）

| タスク | 内容 |
|--------|------|
| 1.1 ルート追加 | `GET /editor`：エディター専用ページ |
| 1.2 パラメータ設計 | `context`, `return`, `initial`（base64 or session key） |
| 1.3 ページレイアウト | note風：余白多め、ツールバー最小限、ブロックメニュー |
| 1.4 Tiptap 導入 | npm 追加、最小構成で初期化 |

### Phase 2：エディター機能実装（約1〜2週間）

| タスク | 内容 |
|--------|------|
| 2.1 基本ブロック | 段落、見出し(h2/h3)、リスト（箇条書き・番号） |
| 2.2 インライン装飾 | 太字、斜体、下線、取り消し線、リンク |
| 2.3 テーブル | Tiptap Table 拡張で挿入・編集・削除 |
| 2.4 画像 | ドラッグ&ドロップ、既存R2アップローダー連携、alt・キャプション |
| 2.5 その他 | 引用、区切り線 |
| 2.6 ショートカット | Markdown風（`##`, `- `, `1. `, `---`, `~~`） |

### Phase 3：保存・戻りフロー（約3〜5日）

| タスク | 内容 |
|--------|------|
| 3.1 一時保存API | `POST /api/editor/draft`：セッションにHTMLを保存 |
| 3.2 戻りフロー | 保存後に `return` パラメータへリダイレクト＋クエリで結果渡し or セッション経由 |
| 3.3 呼び出し元対応 | 各フォームに「編集」ボタンと hidden input の連携 |

### Phase 4：各画面への統合（約1週間）

| タスク | 内容 |
|--------|------|
| 4.1 商品作成/編集 | 商品説明をリッチテキスト化、エディターページから編集 |
| 4.2 出品者紹介編集 | 既存Quillを廃止し、エディターページへ置き換え |
| 4.3 キャンペーン編集 | 既存Quillを廃止し、エディターページへ置き換え |

### Phase 5：既存データ・UX 仕上げ（約3〜5日）

| タスク | 内容 |
|--------|------|
| 5.1 既存HTMLの互換 | 既存Quill/HTMLがTiptapで正しく表示・編集できるか検証 |
| 5.2 モバイル対応 | タッチ操作、フォントサイズ、ツールの配置 |
| 5.3 アクセシビリティ | キーボード操作、スクリーンリーダー |

---

## 6. 画面ワイヤーフレーム（エディターページ）

```
+----------------------------------------------------------+
|  [← 戻る]  商品説明を編集                    [保存して戻る] |
+----------------------------------------------------------+
|                                                          |
|  +----------------------------------------------------+  |
|  |                                                    |  |
|  |  タイトル（任意・コンテキストにより表示）            |  |
|  |                                                    |  |
|  +----------------------------------------------------+  |
|                                                          |
|  +----------------------------------------------------+  |
|  |  |                                                 |  |
|  |  |  テキストを入力...  ← スラッシュ(/)でメニュー    |  |
|  |  |                                                 |  |
|  |  |  ## 見出し                                      |  |
|  |  |  本文...                                        |  |
|  |  |                                                 |  |
|  |  |  [画像エリア - ドロップまたはクリック]           |  |
|  |  |                                                 |  |
|  |  |  | 表 | 表の内容...                             |  |
|  |  |                                                 |  |
|  |  +------------------------------------------------+  |
|  |                                                          |
+----------------------------------------------------------+
```

---

## 7. リスクと対策

| リスク | 対策 |
|--------|------|
| 既存HTMLが崩れる | マイグレーションスクリプトで検証、必要に応じて変換 |
| セッション切れで編集中データ消失 | ローカルストレージに自動下書き、復元UI |
| 画像アップロードの既存フロー | R2＋ライブラリは現状維持し、Tiptapから呼び出す |
| モバイルでの操作性 | ブロックメニューをタップで開けるようにする |

---

## 8. 成果物一覧

- `/editor` 専用ページ（EJS + Tiptap）
- `/api/editor/draft` API（一時保存）
- 共通エディター用 CSS/JS
- 商品・出品者紹介・キャンペーン各フォームの修正
- 本計画書の更新版（z_document/）

---

## 9. 実装完了（2025-02）

### 成果物

- `GET /editor` - エディター専用ページ
- `POST /editor` - エディターを開く（html, context, returnUrl を渡す）
- `POST /api/editor/draft` - 保存して戻る
- `src/editor/index.js` - Tiptap エディター本体（esbuild でバンドル）
- `public/js/editor-bundle.js` - ビルド済みバンドル
- `public/styles/editor.css` - エディターページ用スタイル
- 商品編集・出品者紹介・キャンペーン各フォームに「リッチテキストで編集」ボタン追加

### ビルド

```bash
node scripts/build-editor.mjs
```

（package.json に `build:editor` スクリプトを追加する場合は `"build:editor":"node scripts/build-editor.mjs"`）

### 次のステップ（将来）

- ローカルストレージ自動下書き
- スラッシュコマンド（/）でブロックメニュー
- モバイル向けタッチ最適化
