# B2B機能 動作確認手順書（P0 + P1）

> **前提条件**
>
> - ローカルサーバーが起動済み (`npm run dev`)
> - DB マイグレーション (011_b2b_features.sql) が適用済み
> - テストユーザーが存在すること

---

## 事前準備

### 1. テスト用データの確認

1. ブラウザで `http://localhost:3000` を開く
2. **管理者アカウント**でログインする
3. `/admin/partners` にアクセスし、以下の取引先が存在することを確認：
   - 少なくとも1つの**出品者パートナー**（seller）
   - 少なくとも1つの**購入者パートナー**（buyer / corporate）

> **取引先が無い場合**: 管理画面から取引先を新規作成してください。

### 2. テスト用ユーザーの確認

以下のユーザーが必要です（なければ作成）：

- **管理者ユーザー**（role: admin）
- **出品者ユーザー**（role: seller、partner_idが出品者パートナーに紐づき）
- **購入者ユーザーA**（role: user、partner_idが購入者パートナーに紐づき）
- **購入者ユーザーB**（同じ購入者パートナーに紐づく別ユーザー）

---

## P0: 掛売（請求書払い）

### テスト P0-1: 決済方法の選択

1. **購入者ユーザーA** でログイン
2. 商品を1つ以上カートに追加
3. `/cart` でカートを確認、「レジに進む」をクリック
4. チェックアウト画面で **決済方法の選択** が表示されることを確認
5. 「掛売（請求書払い）」が選択肢にあることを確認
6. **期待結果**: 掛売を選択できる。法人アカウント（partner_id あり）のユーザーのみ掛売が利用可能

### テスト P0-2: 掛売で注文確定

1. 上記の続きで、決済方法に「掛売（請求書払い）」を選択
2. 配送先を設定
3. 「注文確定」をクリック
4. **期待結果**:
   - 注文完了画面が表示される
   - 注文ステータスが「pending」になる
   - 決済方法が「掛売（請求書払い）」と表示される

### テスト P0-3: 月次請求書（管理者）

1. **管理者ユーザー** でログイン
2. `/admin/invoices` にアクセス
3. 「月次請求書の生成」で対象年月を指定して実行
4. **期待結果**: 該当月の掛売注文がまとめられた請求書が生成される
5. 生成された請求書をクリックして詳細を確認
6. **期待結果**: 対象注文一覧、合計金額、支払期限が表示される

### テスト P0-4: 入金消込

1. 管理者の請求書詳細画面で「入金を記録」セクションを確認
2. 金額を入力（請求額と同じ金額）
3. 「入金記録」をクリック
4. **期待結果**:
   - 入金履歴に記録が追加される
   - 請求書ステータスが「支払済」に変わる

### テスト P0-5: 購入者側の請求書閲覧

1. **購入者ユーザーA** でログイン
2. ヘッダーメニューの「マイページ」→「請求書」をクリック
3. **期待結果**: 自分の組織宛ての請求書一覧が表示される

---

## P0: リピート注文

### テスト P0-6: 注文履歴から再注文

1. **購入者ユーザーA** でログイン
2. `/my/orders` で過去の注文一覧を開く
3. 注文の詳細画面を開く
4. 「再注文」ボタンをクリック
5. **期待結果**: カートに同じ商品が同じ数量で追加される
6. カート画面を開いて内容を確認
7. **期待結果**: 再注文した商品がカートに入っている

---

## P0: 注文テンプレート

### テスト P0-7: カートからテンプレート作成

1. **購入者ユーザーA** でログイン
2. 商品を2~3種類カートに追加
3. `/cart` でカートを確認
4. 出品者ごとのグループに「テンプレートとして保存」ボタンがあることを確認
5. ボタンをクリック
6. **期待結果**: テンプレートが作成され、テンプレート詳細画面にリダイレクトされる
7. テンプレート名と商品が正しく表示されることを確認

### テスト P0-8: テンプレート一覧

1. ヘッダーメニュー「マイページ」→「注文テンプレート」をクリック
2. **期待結果**: `/my/templates` でテンプレート一覧が表示される
3. 作成したテンプレートがカード形式で表示されていることを確認

### テスト P0-9: テンプレートの編集

1. テンプレート一覧からテンプレートをクリックして詳細を開く
2. テンプレート名を変更して保存
3. **期待結果**: 名前が変更される
4. 商品の数量を変更（+/- ボタンまたは直接入力）して保存
5. **期待結果**: 数量が変更される
6. 商品の1つを「削除」ボタンで削除
7. **期待結果**: 商品がテンプレートから削除される

### テスト P0-10: テンプレートからカートに追加

1. テンプレート詳細画面で「カートに追加」ボタンをクリック
2. **期待結果**: テンプレートの全商品（在庫あり分）がカートに追加される
3. カート画面を開いて確認
4. **期待結果**: テンプレートの商品が正しい数量でカートに入っている

### テスト P0-11: 注文からテンプレート作成

1. `/my/orders` で過去の注文詳細を開く
2. 「テンプレートとして保存」ボタンをクリック
3. **期待結果**: 注文の商品がテンプレートに保存される

### テスト P0-12: テンプレート削除

1. テンプレート一覧でテンプレートの「削除」ボタンをクリック
2. **期待結果**: テンプレートが削除される

---

## P1: 顧客別単価設定

### テスト P1-1: 出品者の取引先一覧

1. **出品者ユーザー** でログイン
2. ヘッダーメニュー「出品者メニュー」→「顧客別価格」をクリック
3. **期待結果**: `/seller/customer-prices` に取引先一覧が表示される
4. 購入実績のある取引先が一覧に表示されることを確認

> **注意**: 取引先が表示されない場合は、先にP0-2の掛売注文を購入者として実行してください。

### テスト P1-2: 顧客別価格の設定

1. 取引先一覧で取引先名をクリック
2. **期待結果**: `/seller/partners/{buyerId}/prices` で価格設定画面が表示される
3. 商品を選択し、特別価格を入力（標準価格より安い値段）
4. 「設定」をクリック
5. **期待結果**: 「顧客別価格を設定しました」と表示される
6. 設定した価格が一覧に表示されることを確認

### テスト P1-3: 購入者側での顧客別価格表示

1. **購入者ユーザーA** でログイン
2. 顧客別価格を設定した商品の詳細ページを開く
3. **期待結果**: 「特別価格」バッジと割引後の価格が表示される。標準価格が取り消し線で表示される
4. 商品をカートに追加
5. カート画面を確認
6. **期待結果**: カート内でも特別価格が適用されている

### テスト P1-4: 顧客別価格の削除

1. **出品者ユーザー** でログイン
2. 取引先の価格設定画面を開く
3. 設定済みの価格の「削除」ボタンをクリック
4. **期待結果**: 価格が削除される
5. 購入者でログインし直し、商品詳細を確認
6. **期待結果**: 標準価格に戻っている

---

## P1: 組織内の権限管理

### テスト P1-5: 組織管理者の初期設定

まず、購入者ユーザーAに org_admin ロールを設定する必要があります。

1. **管理者ユーザー** でログインし、PostgreSQL で直接設定:
   ```sql
   INSERT INTO partner_member_roles (partner_id, user_id, role)
   VALUES (
     '900929b1-d786-48e6-95c6-041de9a6e9c2',
     'ae7cc4f4-c149-46c5-9e75-7f64e4686299',
     'org_admin'
   ) ON CONFLICT DO NOTHING;
   ```

### テスト P1-6: メンバー一覧

1. **購入者ユーザーA**（org_admin）でログイン
2. ヘッダーメニュー「マイページ」→「組織管理」をクリック
3. **期待結果**: `/my/org/members` にメンバー一覧が表示される
4. 同じパートナーに紐づくユーザーが全て表示されることを確認
5. 各メンバーの現在のロールが表示されていることを確認

### テスト P1-7: ロール変更

1. メンバー一覧で購入者ユーザーBの「ロール変更」ボタンをクリック
2. **期待結果**: ロール変更モーダルが表示される
3. 「発注者」「承認者」にチェックを入れて「保存」
4. **期待結果**: ロールが変更されてロールのバッジが更新される

### テスト P1-8: 自分のorg_adminは削除不可

1. 自分自身の「ロール変更」をクリック
2. 「組織管理者」のチェックを外して保存
3. **期待結果**: 「自分自身の組織管理者権限は削除できません」エラーメッセージが表示される

### テスト P1-9: 最後のorg_admin保護

1. 他のメンバーにorg_adminロールが設定されていない状態で
2. 他のメンバーのロールからorg_adminを外す操作（もし設定していた場合）
3. **期待結果**: 最後のorg_adminを削除しようとするとエラーメッセージが表示される

---

## P1: 発注承認ワークフロー

### テスト P1-10: ワークフロー設定画面

1. **購入者ユーザーA**（org_admin）でログイン
2. ヘッダーメニュー「マイページ」→「承認フロー設定」をクリック
3. **期待結果**: `/my/org/workflow` に承認ワークフロー設定画面が表示される

### テスト P1-11: ワークフローの有効化と設定

1. 「承認ワークフローを有効にする」トグルをONにする
2. ステップ1: ロール = 「承認者（approver）」を設定
3. 「保存」をクリック
4. **期待結果**: 「承認ワークフロー設定を保存しました」と表示される
5. ページを再読み込みして設定が保持されていることを確認

### テスト P1-12: 承認が必要な注文

1. **購入者ユーザーB**（orderer ロール）でログイン
2. 商品をカートに追加し、注文手続きを進める
3. 注文を確定する
4. **期待結果**: 注文完了画面が表示される。注文ステータスは `pending` のまま

### テスト P1-13: 承認待ち一覧

1. **購入者ユーザーA**（approver ロール）でログイン
2. ヘッダーメニュー「マイページ」→「承認待ち」をクリック
3. **期待結果**: `/my/approvals` にユーザーBが発注した注文が表示される
4. 発注者名、金額、ステップ情報が正しいことを確認

### テスト P1-14: 注文の承認

1. 承認待ち一覧から注文をクリック
2. **期待結果**: 承認詳細画面に注文商品、発注者、承認履歴が表示される
3. コメント欄に「承認します」と入力
4. 「承認する」ボタンをクリック
5. **期待結果**: 「注文を承認しました。注文が確定されました。」と表示される
6. 承認待ち一覧に戻り、承認した注文が一覧から消えていることを確認

### テスト P1-15: 注文の却下

1. 再度P1-12の手順で新しい注文を作成（ユーザーBで）
2. **購入者ユーザーA** で承認待ちを開く
3. 注文詳細を開き、コメント「予算超過のため却下」と入力
4. 「却下する」をクリック
5. **期待結果**: 「注文を却下しました」と表示される

### テスト P1-16: 多段階承認（オプション）

1. ワークフロー設定でステップを2つに設定:
   - ステップ1: approver
   - ステップ2: org_admin
2. ユーザーBで注文
3. approverロールのユーザーで承認
4. **期待結果**: 「次の承認者に回されました」と表示される
5. org_adminロールのユーザーで承認
6. **期待結果**: 「注文が確定されました」と表示される

---

## P1: 月次請求書発行（管理者側）

### テスト P1-17: 請求書一覧

1. **管理者ユーザー** でログイン
2. `/admin/invoices` にアクセス
3. **期待結果**: 請求書一覧がテーブル形式で表示される
4. ステータスフィルタ、検索、ページネーションが動作することを確認

### テスト P1-18: 請求書詳細

1. 請求書一覧から1件クリック
2. **期待結果**: 以下が表示される
   - 請求書番号、対象年月、支払期限
   - 購入者・出品者の情報
   - 対象注文の一覧と金額内訳
   - 入金履歴
   - 入金記録フォーム

---

## P1: 与信管理

### テスト P1-19: 与信限度額の設定（管理者）

1. **管理者ユーザー** でログイン
2. `/admin/partners/{購入者パートナーID}` にアクセス
3. 「与信管理」セクションを確認
4. 与信限度額に `50000` を入力して「更新」
5. **期待結果**: 「与信限度額を更新しました」と表示される
6. ページを再読み込みして限度額が50,000円と表示されることを確認

### テスト P1-20: 与信枠内での注文

1. **購入者ユーザーA** でログイン
2. 合計が50,000円以内になるよう商品をカートに追加
3. 掛売で注文確定
4. **期待結果**: 正常に注文が確定される

### テスト P1-21: 与信枠超過時のエラー

1. 続けて、合計が与信残高を超える商品をカートに追加
2. 掛売で注文手続きを進める
3. **期待結果**: 「与信残高が不足しています（残高: ¥XX,XXX、注文額: ¥XX,XXX）」エラーが表示される
4. 注文は確定されず、チェックアウト画面に戻る

### テスト P1-22: 入金後の与信回復

1. **管理者** で請求書から入金消込を実行
2. **購入者** で再度注文を試みる
3. **期待結果**: 与信枠が回復し、注文が可能になる

---

## ナビゲーション確認

### テスト NAV-1: ヘッダーメニューの確認

1. **購入者ユーザーA**（partner_id あり）でログイン
2. ヘッダーの「マイページ」メニューを展開
3. **期待結果**: 以下のメニュー項目が表示される
   - 注文履歴
   - 注文テンプレート
   - 請求書
   - 承認待ち
   - 組織管理
   - 承認フロー設定

### テスト NAV-2: 出品者メニュー

1. **出品者ユーザー** でログイン
2. ヘッダーの出品者メニューを展開
3. **期待結果**: 「顧客別価格」メニュー項目が表示される

---

## トラブルシューティング

### 「出品者アカウントが必要です」と表示される

→ ログイン中のユーザーの `partner_id` が設定されていない可能性があります。管理画面でユーザーの所属パートナーを確認してください。

### 「組織に所属していません」と表示される

→ ログイン中のユーザーに `partner_id` が設定されていません。

### 「この操作には組織管理者権限が必要です」と表示される

→ ユーザーに `org_admin` ロールが設定されていません。テスト P1-5 の手順でロールを設定してください。

### 承認待ちに注文が表示されない

→ 以下を確認:

1. 承認ワークフローが有効になっているか（テスト P1-11）
2. ログインユーザーが適切なロール（approver/org_admin）を持っているか
3. 注文が `approval_status = 'pending'` になっているか

### 顧客別価格が表示されない

→ 出品者が価格を設定済みか確認。また、有効期限（starts_at / expires_at）が設定されている場合、現在日時が範囲内か確認。
