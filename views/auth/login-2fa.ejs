<%- include('../partials/header', { title: 'äºŒè¦ç´ èªè¨¼', extraCSS: '', extraCSS2: '' }) %>

<main style="max-width: 480px; margin: 120px auto 64px; padding: 0 16px;">
  <section style="background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:32px 28px;">
    <h1 style="margin:0 0 8px; font-size:1.6rem; text-align:center;">äºŒè¦ç´ èªè¨¼</h1>
    <p style="color:#666; margin:0 0 24px; text-align:center; font-size:0.9rem;">
      èªè¨¼ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
    </p>

    <% if (error) { %>
      <div style="background:#fee; border:1px solid #fcc; border-radius:8px; padding:12px; margin-bottom:20px;">
        <p style="color:#c33; margin:0; font-size:0.9rem;"><%= error %></p>
      </div>
    <% } %>

    <% if (!useBackupCode) { %>
      <!-- é€šå¸¸ã®2FAã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
      <form id="verify2FAForm" method="POST" action="/login/2fa/verify" style="margin-bottom:20px;">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div style="margin-bottom:20px;">
          <label for="token" style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">
            èªè¨¼ã‚³ãƒ¼ãƒ‰
          </label>
          <input
            type="text"
            id="token"
            name="token"
            maxlength="6"
            pattern="[0-9]{6}"
            autocomplete="one-time-code"
            inputmode="numeric"
            required
            style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:1.5rem; text-align:center; letter-spacing:0.3em; font-family:monospace;"
            placeholder="000000"
            autofocus
          >
          <p style="color:#666; font-size:0.8rem; margin:6px 0 0;">
            Google Authenticatorã€Authyã€1Passwordç­‰ã®ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </p>
        </div>

        <button
          type="submit"
          class="button button-primary"
          style="width:100%; padding:14px; font-size:1rem; border-radius:8px; cursor:pointer;"
        >
          èªè¨¼ã™ã‚‹
        </button>
      </form>

      <div style="text-align:center; margin-top:16px;">
        <a href="?useBackup=true" style="color:#666; font-size:0.9rem; text-decoration:underline;">
          ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
        </a>
      </div>

    <% } else { %>
      <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
      <form id="verifyBackupForm" method="POST" action="/login/2fa/backup" style="margin-bottom:20px;">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div style="margin-bottom:20px;">
          <label for="backupCode" style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">
            ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰
          </label>
          <input
            type="text"
            id="backupCode"
            name="backupCode"
            maxlength="8"
            pattern="[A-F0-9]{8}"
            required
            style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:1.2rem; text-align:center; letter-spacing:0.2em; font-family:monospace; text-transform:uppercase;"
            placeholder="XXXXXXXX"
            autofocus
          >
          <p style="color:#666; font-size:0.8rem; margin:6px 0 0;">
            2FAè¨­å®šæ™‚ã«ä¿å­˜ã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </p>
        </div>

        <button
          type="submit"
          class="button button-primary"
          style="width:100%; padding:14px; font-size:1rem; border-radius:8px; cursor:pointer;"
        >
          èªè¨¼ã™ã‚‹
        </button>
      </form>

      <div style="text-align:center; margin-top:16px;">
        <a href="?" style="color:#666; font-size:0.9rem; text-decoration:underline;">
          èªè¨¼ã‚³ãƒ¼ãƒ‰ã§èªè¨¼
        </a>
      </div>
    <% } %>

    <div style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; text-align:center;">
      <a href="/login" style="color:#999; font-size:0.85rem;">â† ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a>
    </div>
  </section>

  <div style="margin-top:32px; padding:20px; background:#f8f9fa; border-radius:12px; text-align:center;">
    <p style="margin:0 0 8px; font-size:0.85rem; color:#666;">
      ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€äºŒè¦ç´ èªè¨¼ã‚’è¨­å®šã—ã¦ã„ã¾ã™
    </p>
    <p style="margin:0; font-size:0.8rem; color:#999;">
      èªè¨¼ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã§ããªã„å ´åˆã¯ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’ã”ä½¿ç”¨ãã ã•ã„
    </p>
  </div>
</main>

<script>
// è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¨å…¥åŠ›è£œåŠ©
(function() {
  const tokenInput = document.getElementById('token');
  const backupInput = document.getElementById('backupCode');
  const activeInput = tokenInput || backupInput;

  if (activeInput) {
    activeInput.focus();

    // æ•°å­—ã®ã¿å…¥åŠ›ã‚’è¨±å¯ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã®å ´åˆï¼‰
    if (tokenInput) {
      tokenInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length === 6) {
          // 6æ¡å…¥åŠ›ã—ãŸã‚‰è‡ªå‹•é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          // document.getElementById('verify2FAForm').submit();
        }
      });
    }

    // å¤§æ–‡å­—åŒ–ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã®å ´åˆï¼‰
    if (backupInput) {
      backupInput.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().replace(/[^A-F0-9]/g, '');
      });
    }
  }
})();
</script>

<%- include('../partials/footer') %>
