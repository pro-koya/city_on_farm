<%- include('../partials/header', { title: 'äºŒè¦ç´ èªè¨¼', extraCSS: '', extraCSS2: '' }) %>

<style>
.webauthn-button {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #4C6B5C 0%, #3d5749 100%);
  color: #fff;
  border: none;
  border-radius: 12px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(76, 107, 92, 0.3);
  margin-bottom: 20px;
}

.webauthn-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(76, 107, 92, 0.4);
}

.webauthn-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.webauthn-icon {
  font-size: 24px;
  margin-right: 8px;
}

.divider {
  display: flex;
  align-items: center;
  margin: 24px 0;
  color: #999;
  font-size: 0.85rem;
}

.divider::before,
.divider::after {
  content: '';
  flex: 1;
  border-bottom: 1px solid #e5e7eb;
}

.divider::before {
  margin-right: 12px;
}

.divider::after {
  margin-left: 12px;
}
</style>

<main style="max-width: 480px; margin: 120px auto 64px; padding: 0 16px;">
  <section style="background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); padding:32px 28px;">
    <h1 style="margin:0 0 8px; font-size:1.6rem; text-align:center;">äºŒè¦ç´ èªè¨¼</h1>
    <p style="color:#666; margin:0 0 24px; text-align:center; font-size:0.9rem;">
      ãƒ­ã‚°ã‚¤ãƒ³ã‚’å®Œäº†ã™ã‚‹ãŸã‚ã«èªè¨¼ã—ã¦ãã ã•ã„
    </p>

    <% if (error) { %>
      <div style="background:#fee; border:1px solid #fcc; border-radius:8px; padding:12px; margin-bottom:20px;">
        <p style="color:#c33; margin:0; font-size:0.9rem;"><%= error %></p>
      </div>
    <% } %>

    <% if (!useBackupCode) { %>
      <!-- WebAuthnèªè¨¼ãƒœã‚¿ãƒ³ï¼ˆå„ªå…ˆè¡¨ç¤ºï¼‰ -->
      <div id="webauthnSection" style="display: none;">
        <button type="button" class="webauthn-button" id="webauthnButton">
          <span class="webauthn-icon">ğŸ”</span>
          ç”Ÿä½“èªè¨¼ã§èªè¨¼ã™ã‚‹
        </button>

        <div style="text-align: center; margin-top: 16px;">
          <a href="#" id="showTotpLink" style="display: none; color: #666; font-size: 0.9rem; text-decoration: underline;">
            èªè¨¼ã‚³ãƒ¼ãƒ‰ã§èªè¨¼
          </a>
        </div>
      </div>

      <!-- é€šå¸¸ã®2FAã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
      <div id="totpSection">
        <form id="verify2FAForm" method="POST" action="/login/2fa/verify" style="margin-bottom:20px;">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div style="margin-bottom:20px;">
          <label for="token" style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">
            èªè¨¼ã‚³ãƒ¼ãƒ‰
          </label>
          <input
            type="text"
            id="token"
            name="token"
            maxlength="6"
            pattern="[0-9]{6}"
            autocomplete="one-time-code"
            inputmode="numeric"
            required
            style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:1.5rem; text-align:center; letter-spacing:0.3em; font-family:monospace;"
            placeholder="000000"
            autofocus
          >
          <p style="color:#666; font-size:0.8rem; margin:6px 0 0;">
            Google Authenticatorã€Authyã€1Passwordç­‰ã®ã‚¢ãƒ—ãƒªã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </p>
        </div>

        <button
          type="submit"
          class="button button-primary"
          style="width:100%; padding:14px; font-size:1rem; border-radius:8px; cursor:pointer;"
        >
          èªè¨¼ã™ã‚‹
        </button>
      </form>

        <div style="text-align:center; margin-top:16px;">
          <a href="#" id="showWebAuthnLink" style="display: none; color: #4C6B5C; font-size: 0.9rem; text-decoration: underline; margin-right: 16px;">
            ğŸ” ç”Ÿä½“èªè¨¼ã«æˆ»ã‚‹
          </a>
          <a href="?useBackup=true" style="color:#666; font-size:0.9rem; text-decoration:underline;">
            ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
          </a>
        </div>
      </div>
      <!-- /totpSection -->

    <% } else { %>
      <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰å…¥åŠ› -->
      <form id="verifyBackupForm" method="POST" action="/login/2fa/backup" style="margin-bottom:20px;">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">

        <div style="margin-bottom:20px;">
          <label for="backupCode" style="display:block; margin-bottom:6px; font-weight:600; font-size:0.9rem;">
            ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰
          </label>
          <input
            type="text"
            id="backupCode"
            name="backupCode"
            maxlength="8"
            pattern="[A-F0-9]{8}"
            required
            style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:1.2rem; text-align:center; letter-spacing:0.2em; font-family:monospace; text-transform:uppercase;"
            placeholder="XXXXXXXX"
            autofocus
          >
          <p style="color:#666; font-size:0.8rem; margin:6px 0 0;">
            2FAè¨­å®šæ™‚ã«ä¿å­˜ã—ãŸãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
          </p>
        </div>

        <button
          type="submit"
          class="button button-primary"
          style="width:100%; padding:14px; font-size:1rem; border-radius:8px; cursor:pointer;"
        >
          èªè¨¼ã™ã‚‹
        </button>
      </form>

      <div style="text-align:center; margin-top:16px;">
        <a href="?" style="color:#666; font-size:0.9rem; text-decoration:underline;">
          èªè¨¼ã‚³ãƒ¼ãƒ‰ã§èªè¨¼
        </a>
      </div>
    <% } %>

    <div style="margin-top:24px; padding-top:20px; border-top:1px solid #eee; text-align:center;">
      <a href="/login" style="color:#999; font-size:0.85rem;">â† ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a>
    </div>
  </section>

  <div style="margin-top:32px; padding:20px; background:#f8f9fa; border-radius:12px; text-align:center;">
    <p style="margin:0 0 8px; font-size:0.85rem; color:#666;">
      ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€äºŒè¦ç´ èªè¨¼ã‚’è¨­å®šã—ã¦ã„ã¾ã™
    </p>
    <p style="margin:0; font-size:0.8rem; color:#999;">
      èªè¨¼ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã§ããªã„å ´åˆã¯ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã‚’ã”ä½¿ç”¨ãã ã•ã„
    </p>
  </div>
</main>

<script type="module">
import { startAuthentication } from 'https://unpkg.com/@simplewebauthn/browser@9.0.1/dist/bundle/index.js';

const csrfToken = '<%= csrfToken %>';

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«WebAuthnåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
async function checkWebAuthnAvailability() {
  try {
    // WebAuthnå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã‹ãƒã‚§ãƒƒã‚¯
    if (!window.PublicKeyCredential) {
      return;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒWebAuthnã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ2FAèªè¨¼ä¸­ã§ã‚‚åˆ©ç”¨å¯èƒ½ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
    const response = await fetch('/api/webauthn/credentials/check', {
      credentials: 'same-origin'
    });

    if (!response.ok) {
      return;
    }

    const data = await response.json();

    if (data.success && data.hasCredentials) {
      // WebAuthnã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      document.getElementById('webauthnSection').style.display = 'block';
      // TOTPã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ˜ã‚ŠãŸãŸã‚€
      document.getElementById('totpSection').style.display = 'none';
      document.getElementById('showTotpLink').style.display = 'block';
      document.getElementById('showWebAuthnLink').style.display = 'inline-block';
    }
  } catch (error) {
    console.log('WebAuthn check failed:', error);
  }
}

// WebAuthnèªè¨¼å®Ÿè¡Œ
async function authenticateWithWebAuthn() {
  const button = document.getElementById('webauthnButton');
  const originalText = button.innerHTML;

  try {
    button.disabled = true;
    button.innerHTML = '<span class="webauthn-icon">ğŸ”</span>èªè¨¼ä¸­...';

    // Step 1: ãƒãƒ£ãƒ¬ãƒ³ã‚¸å–å¾—
    const challengeResponse = await fetch('/api/webauthn/auth/challenge', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    });

    if (!challengeResponse.ok) {
      throw new Error('ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    const challengeData = await challengeResponse.json();

    if (!challengeData.success) {
      throw new Error(challengeData.error || 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    // Step 2: ãƒ–ãƒ©ã‚¦ã‚¶ã§ç”Ÿä½“èªè¨¼å®Ÿè¡Œ
    button.innerHTML = '<span class="webauthn-icon">ğŸ”</span>ç”Ÿä½“èªè¨¼ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„...';
    const credential = await startAuthentication(challengeData.options);

    // Step 3: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼
    button.innerHTML = '<span class="webauthn-icon">ğŸ”</span>æ¤œè¨¼ä¸­...';
    const verifyResponse = await fetch('/api/webauthn/auth/verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin',
      body: JSON.stringify({ response: credential })
    });

    if (!verifyResponse.ok) {
      throw new Error('èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    const verifyData = await verifyResponse.json();

    if (!verifyData.success) {
      throw new Error(verifyData.error || 'èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }

    // æˆåŠŸ - ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†å¾Œã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    button.innerHTML = '<span class="webauthn-icon">âœ…</span>èªè¨¼æˆåŠŸï¼ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆä¸­...';
    window.location.href = '/';

  } catch (error) {
    console.error('WebAuthn authentication failed:', error);
    button.disabled = false;
    button.innerHTML = originalText;

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    alert('ç”Ÿä½“èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰ã§èªè¨¼ã€ãƒªãƒ³ã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
const showTotpLink = document.getElementById('showTotpLink');
if (showTotpLink) {
  showTotpLink.addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('webauthnSection').style.display = 'none';
    document.getElementById('totpSection').style.display = 'block';
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›æ¬„ã«ç§»å‹•
    const tokenInput = document.getElementById('token');
    if (tokenInput) {
      tokenInput.focus();
    }
  });
}

// ã€Œç”Ÿä½“èªè¨¼ã«æˆ»ã‚‹ã€ãƒªãƒ³ã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
const showWebAuthnLink = document.getElementById('showWebAuthnLink');
if (showWebAuthnLink) {
  showWebAuthnLink.addEventListener('click', (e) => {
    e.preventDefault();
    document.getElementById('totpSection').style.display = 'none';
    document.getElementById('webauthnSection').style.display = 'block';
  });
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
const webauthnButton = document.getElementById('webauthnButton');
if (webauthnButton) {
  webauthnButton.addEventListener('click', authenticateWithWebAuthn);
}

// åˆæœŸåŒ–
checkWebAuthnAvailability();
</script>

<script>
// è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¨å…¥åŠ›è£œåŠ©
(function() {
  const tokenInput = document.getElementById('token');
  const backupInput = document.getElementById('backupCode');
  const activeInput = tokenInput || backupInput;

  if (activeInput) {
    activeInput.focus();

    // æ•°å­—ã®ã¿å…¥åŠ›ã‚’è¨±å¯ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ã®å ´åˆï¼‰
    if (tokenInput) {
      tokenInput.addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value.length === 6) {
          // 6æ¡å…¥åŠ›ã—ãŸã‚‰è‡ªå‹•é€ä¿¡ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          // document.getElementById('verify2FAForm').submit();
        }
      });
    }

    // å¤§æ–‡å­—åŒ–ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚³ãƒ¼ãƒ‰ã®å ´åˆï¼‰
    if (backupInput) {
      backupInput.addEventListener('input', function(e) {
        this.value = this.value.toUpperCase().replace(/[^A-F0-9]/g, '');
      });
    }
  }
})();
</script>

<%- include('../partials/footer') %>
