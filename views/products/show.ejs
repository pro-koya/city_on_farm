<%- include('../partials/header', { title: product.title, extraCSS: '/styles/product-show.css', extraCSS2: '/styles/prose-tables.css' }) %>

<main class="product-page" itemscope itemtype="https://schema.org/Product">
  <a href="/products">←商品一覧へ</a>
  <!-- ===== ファーストビュー ===== -->
  <section class="top">
    <!-- PC: 左＝ギャラリー / 右＝情報、SP: 1カラム -->
    <div class="gallery" aria-label="商品画像ギャラリー">
      <div class="gallery__main">
        <img id="mainImage"
            src="<%= (Array.isArray(product.images) && product.images.length ? product.images[0] : (product.image_url || '/images/placeholder.png')) %>"
            alt="<%= product.title + 'の画像' %>"
            loading="eager"
            itemprop="image">
      </div>

      <% if (Array.isArray(product.images) && product.images.length > 1) { %>
      <div class="thumbs-wrap">
        <!-- <button class="thumbs__nav thumbs__prev" type="button" aria-label="前へ" title="前へ">‹</button> -->
        <div class="thumbs" role="listbox" aria-label="サムネイル">
          <% product.images.forEach(function(img, i){ %>
            <button class="thumb <%= i===0 ? 'is-active':'' %>"
                    data-src="<%= img %>"
                    aria-label="画像 <%= i+1 %> を表示"
                    role="option"
                    aria-selected="<%= i===0 ? 'true' : 'false' %>">
              <img src="<%= img %>"
                  alt="<%= product.title + 'の画像 ' + (i+1) %>"
                  loading="lazy">
            </button>
          <% }) %>
        </div>
        <!-- <button class="thumbs__nav thumbs__next" type="button" aria-label="次へ" title="次へ">›</button> -->
      </div>
      <% } %>
    </div>

    <div class="info">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
        <h1 class="title" itemprop="name" style="margin: 0; flex: 1;"><%= product.title %></h1>
        <!-- お気に入りボタン -->
        <% if (typeof currentUser !== 'undefined' && currentUser) { %>
        <button type="button" 
                class="favorite-btn <%= (typeof isFavorited !== 'undefined' && isFavorited) ? 'is-favorited' : '' %>" 
                data-product-id="<%= product.id %>"
                aria-label="<%= (typeof isFavorited !== 'undefined' && isFavorited) ? 'お気に入りから削除' : 'お気に入りに追加' %>"
                aria-pressed="<%= (typeof isFavorited !== 'undefined' && isFavorited) ? 'true' : 'false' %>">
          <svg class="favorite-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </button>
        <% } else { %>
        <a href="/login" class="favorite-btn favorite-btn--guest" aria-label="ログインしてからお気に入りに追加">
          <svg class="favorite-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
        </a>
        <% } %>
      </div>

      <div class="rating">
        <span class="stars" aria-hidden="true"><%= '★'.repeat(Math.round(product.rating||0)) %><%= '☆'.repeat(5-Math.round(product.rating||0)) %></span>
        <span class="rating__num"><%= product.rating||0 %></span>
        <a class="rating__count" href="#reviews" id="goto-reviews">（<%= product.review_count || 0 %>件のレビュー）</a>
      </div>

      <div class="price-row" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
        <% if (typeof customerPrice !== 'undefined' && customerPrice != null) { %>
          <span class="price">&#165;<span itemprop="price"><%= customerPrice %></span></span>
          <% if (product.unit) { %><span class="unit">/ <%= product.unit %></span><% } %>
          <div class="customer-price-badge">
            <span>特別価格</span>
            <span class="customer-price-badge__original">&#165;<%= Number(product.price).toLocaleString() %></span>
          </div>
        <% } else { %>
          <span class="price">&#165;<span itemprop="price"><%= product.price %></span></span>
          <% if (product.unit) { %><span class="unit">/ <%= product.unit %></span><% } %>
        <% } %>
        <link itemprop="priceCurrency" content="JPY">
        <link itemprop="availability" href="https://schema.org/<%= product.stock>0?'InStock':'OutOfStock' %>">
      </div>

      <div class="stock">
        <% if (product.stock > 10) { %>
          <span class="badge">在庫あり</span>
        <% } else if (product.stock > 0) { %>
          <span class="badge badge--low">残り <%= product.stock %> 点</span>
        <% } else { %>
          <span class="badge badge--out">在庫切れ</span>
        <% } %>
        <span class="ship"><%= product.shippingNote || '2〜3日以内に発送' %></span>
      </div>

      <form class="buy" id="buyForm" action="/cart/add" method="POST" data-stock="<%= product.stock %>" novalidate>
        <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>
        <input type="hidden" name="productId" value="<%= product.id %>">
        <label class="qty" for="qty">
          数量
          <div class="stepper" role="group" aria-label="数量の増減">
            <button type="button" class="stepper__btn" data-step="-1" aria-label="数量を減らす">−</button>
            <input id="qty" name="qty" type="number" min="1" value="1" data-max="<%= product.stock %>" max="<%= product.stock %>" inputmode="numeric" pattern="[0-9]*">
            <button type="button" class="stepper__btn" data-step="1" aria-label="数量を増やす">＋</button>
          </div>
        </label>

        <div class="cta">
          <button class="btn btn--buy" type="submit" <%= product.stock>0?'':'disabled' %>>カートに入れる</button>
        </div>
      </form>

      <ul class="assurance">
        <% if (Array.isArray(tags) && tags.length) { %>
          <% tags.forEach(function(tag){ %>
            <li>#<%= tag.name %></li>
          <% }); %>
        <% } %>
      </ul>
    </div>
  </section>

  <!-- ===== コンパクトな出品者紹介カード ===== -->
  <% if (sellerHighlight) { %>
  <section class="seller-compact-card">
    <div class="seller-compact-content">
      <div class="seller-compact-logo">
        <%
        // アイコンURLを取得（icon_url または logo_url）
        const iconUrl = product.seller_partner_icon_url || '';
        %>
        <% if (iconUrl) { %>
          <img src="<%= iconUrl %>" alt="<%= sellerHighlight.name %>のアイコン">
        <% } else { %>
          <div class="seller-compact-logo-placeholder">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
        <% } %>
      </div>
      <div class="seller-compact-info">
        <div class="seller-compact-label">出品者（取引先）</div>
        <h3 class="seller-compact-name"><%= sellerHighlight.name %> さん</h3>
        <% if (sellerHighlight.tags && sellerHighlight.tags.length) { %>
          <div class="seller-compact-tags">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span><%= sellerHighlight.tags.slice(0, 3).join('、') %></span>
          </div>
        <% } %>
      </div>
      <a href="/sellers/<%= sellerHighlight.user_id %>" class="seller-compact-arrow" aria-label="出品者の詳細を見る">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>
    </div>
  </section>

  <style>
  .seller-compact-card {
    margin: 24px auto;
    max-width: 1200px;
    padding: 0;
  }

  .seller-compact-content {
    background: var(--white);
    border-radius: 12px;
    box-shadow: var(--shadow);
    padding: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.08);
  }

  .seller-compact-content:hover {
    border-color: #4caf50;
    box-shadow: 0 4px 16px rgba(76, 175, 80, 0.15);
    transform: translateY(-2px);
  }

  .seller-compact-logo {
    flex-shrink: 0;
    width: 72px;
    height: 72px;
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #e0e0e0;
  }

  .seller-compact-logo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .seller-compact-logo-placeholder {
    color: #999;
  }

  .seller-compact-info {
    flex: 1;
    min-width: 0;
  }

  .seller-compact-label {
    font-size: 0.75rem;
    color: #666;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 4px;
  }

  .seller-compact-name {
    font-size: 1rem;
    font-weight: 700;
    color: #1a1a1a;
    margin: 0 0 8px;
    line-height: 1.3;
  }

  .seller-compact-tags {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.875rem;
    color: #4caf50;
    font-weight: 500;
  }

  .seller-compact-tags svg {
    flex-shrink: 0;
    fill: #4caf50;
  }

  .seller-compact-tags span {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .seller-compact-arrow {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: all 0.2s ease;
  }

  .seller-compact-arrow:hover {
    background: #4caf50;
    border-color: #4caf50;
    color: #fff;
    transform: scale(1.1);
  }

  @media (max-width: 640px) {
    .seller-compact-card {
      margin: 12px auto;
    }

    .seller-compact-content {
      gap: 12px;
    }

    .seller-compact-logo {
      width: 56px;
      height: 56px;
    }

    .seller-compact-name {
      font-size: 1.1rem;
    }

    .seller-compact-tags {
      font-size: 0.8rem;
    }

    .seller-compact-arrow {
      width: 36px;
      height: 36px;
    }
  }
  </style>
  <% } %>

  <!-- ===== 詳細タブ / SPはアコーディオン風 ===== -->
  <section class="details">
    <div class="tabs" role="tablist">
      <button class="tab is-active tab1" role="tab" data-tab="desc">商品説明</button>
      <button class="tab tab2" role="tab" data-tab="specs">サイズ・選定基準</button>
      <button class="tab tab3" role="tab" data-tab="shipping">配送・送料</button>
      <button class="tab tab4" role="tab" data-tab="reviews">レビュー</button>
    </div>

    <div class="panes">
      <article id="pane-desc" class="pane is-active" role="tabpanel">
        <div class="prose product-desc" itemprop="description">
          <% if (product.description_html) { %>
            <%- product.description_html %>
          <% } else { %>
            <p><%- product.description_html || '商品の詳細説明が入ります。' %></p>
          <% } %>
        </div>
      </article>

      <article id="pane-specs" class="pane" role="tabpanel">
        <div class="specs">
          <% if (Array.isArray(specs) && specs.length) { %>
            <div class="table-wrapper">
              <table class="spec-table">
                <tbody>
                  <% specs.forEach(function(row){ %>
                    <tr><th><%= row.label %></th><td><%= row.value %></td></tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
          <% if (product.criteria && product.criteria.length) { %>
          <div class="criteria">
            <h4>選定基準</h4>
            <ul>
              <% product.criteria.forEach(function(c){ %>
                <li><%= c %></li>
              <% }) %>
            </ul>
          </div>
          <% } %>
        </div>
      </article>

      <!-- 配送・送料 -->
      <article id="pane-shipping" class="pane" role="tabpanel">
        <div class="shipping-info">
          <% if (shippingSummary && shippingSummary.hasAny) { %>
            <div class="shipping-info__intro">
              <p>出品者（<%= sellerHighlight ? sellerHighlight.name : 'この商品の出品者' %>）が設定している配送可能地域と送料です。</p>
            </div>
            <div class="table-wrapper">
              <table class="shipping-table">
                <thead>
                  <tr>
                    <th scope="col">地域</th>
                    <th scope="col">送料（税込）</th>
                    <th scope="col">備考</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (shippingSummary.globalRule) { %>
                    <tr>
                      <td>全国（上記以外）</td>
                      <% if (shippingSummary.globalRule.can_ship) { %>
                        <td><%= shippingSummary.globalRule.shipping_fee != null ? shippingSummary.globalRule.shipping_fee + '円' : '要問い合わせ' %></td>
                        <td>都道府県・市区町村で個別設定されていない地域に適用</td>
                      <% } else { %>
                        <td>配送不可</td>
                        <td>個別に指定した地域のみ配送可</td>
                      <% } %>
                    </tr>
                  <% } %>
                  <% if (shippingSummary.prefectureRules && shippingSummary.prefectureRules.length) { %>
                    <% shippingSummary.prefectureRules.forEach(function(r){ %>
                      <tr>
                        <td><%= r.prefecture %></td>
                        <% if (r.can_ship) { %>
                          <td><%= r.shipping_fee != null ? r.shipping_fee + '円' : '要問い合わせ' %></td>
                          <td></td>
                        <% } else { %>
                          <td>配送不可</td>
                          <td></td>
                        <% } %>
                      </tr>
                    <% }) %>
                  <% } %>
                  <% if (shippingSummary.cityRules && shippingSummary.cityRules.length) { %>
                    <% shippingSummary.cityRules.forEach(function(r){ %>
                      <tr>
                        <td><%= r.prefecture %><%= r.city ? ' ' + r.city : '' %></td>
                        <% if (r.can_ship) { %>
                          <td><%= r.shipping_fee != null ? r.shipping_fee + '円' : '要問い合わせ' %></td>
                          <td></td>
                        <% } else { %>
                          <td>配送不可</td>
                          <td></td>
                        <% } %>
                      </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <p class="muted">配送・送料の設定情報はありません。注文ページでご確認いただくか、出品者にお問い合わせください。</p>
          <% } %>
        </div>
      </article>

      <!-- レビュー -->
      <article id="pane-reviews" class="pane" role="tabpanel">
        <div id="reviews">
          <div class="review-head">
            <h3>レビュー</h3>
            <div class="score"><strong><%= product.rating || 0 %></strong> / 5（<%= product.review_count||0 %>件）</div>
            <% if (currentUser) { %>
              <button class="btn btn--buy" id="openReviewModal"
                      data-has-review="<%= myReview ? '1':'0' %>"
                      data-stars="<%= myReview?.rating || 5 %>"
                      data-body="<%- (myReview?.body || '').replace(/"/g, '&quot;') %>"
                      data-review-id="<%= myReview?.id || '' %>">
                <%= myReview ? 'レビューを編集' : 'レビューを書く' %>
              </button>
            <% } %>
          </div>

          <% if (reviews && reviews.length) { %>
            <ul class="review-list" id="reviewList">
              <% reviews.forEach(function(r){ %>
                <li class="review" id="rev-<%= r.id %>">
                  <% const isMine = !currentUser ? false : r.user_id === currentUser.id; %>
                  <div class="review__meta">
                    <span class="review__stars" aria-label="<%= r.stars %>点"><%= '★'.repeat(r.stars) %><%= '☆'.repeat(5-r.stars) %></span>
                    <span class="review__author <%= isMine ? 'badge mine' : '' %>"><%= isMine ? 'あなた' : r.author %></span>
                    <span class="review__date"><%= new Date(r.created_at).toLocaleDateString('ja-JP') %></span>
                  </div>
                  <% if (r.title) { %><h4 class="review__title"><%= r.title %></h4><% } %>
                  <!-- ★ 改行を尊重して表示（CSSで pre-wrap） -->
                  <p class="review__body"><%= r.text %></p>
                </li>
              <% }) %>
            </ul>
            <% if ((product.review_count||0) > reviews.length) { %>
              <a class="link" href="/products/<%= product.slug || product.id %>/reviews">すべてのレビューを見る →</a>
            <% } %>
          <% } else { %>
            <p class="muted">まだレビューはありません。</p>
          <% } %>
        </div>
      </article>

      <!-- ▼ レビュー投稿/編集モーダル -->
      <div class="modal" id="reviewModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal__content" role="document">
          <div class="modal__head">
            <h3 id="reviewModalTitle">レビューを書く</h3>
            <button type="button" class="icon-btn" id="closeReviewModal" aria-label="閉じる">✕</button>
          </div>

          <form id="reviewForm" action="/products/<%= product.id %>/reviews" method="POST" novalidate>
            <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
            <input type="hidden" name="review_id" id="rv_id" value="">
            <fieldset class="stars">
              <legend>評価</legend>
              <div class="stars__row" id="starsRow" data-value="5" aria-label="星で評価">
                <!-- JSで .is-active を付け替え -->
                <button type="button" class="star" data-v="1" aria-label="1点">★</button>
                <button type="button" class="star" data-v="2" aria-label="2点">★</button>
                <button type="button" class="star" data-v="3" aria-label="3点">★</button>
                <button type="button" class="star" data-v="4" aria-label="4点">★</button>
                <button type="button" class="star" data-v="5" aria-label="5点">★</button>
              </div>
              <input type="hidden" name="rating" id="rv_stars">
            </fieldset>

            <div class="field">
              <label for="rvTitle">タイトル</label>
              <input id="rvTitle" name="title" type="text" maxlength="120" value="<%= myReview?.title||'' %>">
            </div>

            <div class="field">
              <label for="rv_body">本文</label>
              <textarea id="rv_body" name="body" rows="6" placeholder="商品の良かった点・改善してほしい点など自由にどうぞ"></textarea>
              <p class="hint">※ 公序良俗に反する内容は掲載できません</p>
              <p class="error" id="rv_error"></p>
            </div>

            <div class="modal__foot">
              <button type="button" class="btn btn--ghost" id="cancelReview">キャンセル</button>
              <button type="submit" class="btn btn--buy" id="saveReview">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== 出品者ハイライト ===== -->
  <% if (sellerHighlight) { %>
  <section class="seller-highlight">
    <div class="seller-highlight__head">
      <p class="seller-highlight__label sp">この商品を育てた生産者</p>
      <h2 class="seller-highlight__name sp"><%= sellerHighlight.name %> さん</h2>
      <div class="seller-highlight-grid">
        <div class="seller-img">
          <img src="<%= sellerHighlight.hero_image_url || '' %>" alt="<%= sellerHighlight.name + 'さんのイメージ画像' %>">
        </div>
        <div class="seller-highlight-detail">
          <p class="seller-highlight__label pc">この商品を育てた生産者</p>
          <h2 class="seller-highlight__name pc"><%= sellerHighlight.name %> さん</h2>
          <% if (sellerHighlight.tags && sellerHighlight.tags.length) { %>
            <div class="seller-highlight__tags">
              <p class="seller-highlight__tags-label">この農家さんが大事にしていること</p>
              <ul class="seller-highlight__taglist">
                <% sellerHighlight.tags.forEach(function(t){ %>
                  <li>#<%= t %></li>
                <% }) %>
              </ul>
            </div>
          <% } %>
          <a class="seller-highlight__more link js-seller-modal-link" href="/sellers/<%= sellerHighlight.user_id %>?embed=1">生産者の詳しい紹介を見る→</a>
        </div>
      </div>
    </div>

    <p class="seller-highlight__summary">
      <%= sellerHighlight.intro_summary || 'この生産者さんの紹介文は現在準備中です。' %>
    </p>

    <div class="seller-highlight__actions">
      <a
        class="btn btn--seller"
        href="/products/list?seller=<%= encodeURIComponent(sellerHighlight.name) %>">
        この生産者さんの他の商品
      </a>
    </div>
  </section>
  <% } %>

  <!-- ===== 関連商品 ===== -->
  <% if (related && related.length) { %>
  <section class="rail">
    <div class="rail__head">
      <h2>関連商品</h2>
      <a class="link" href="/products/list?category=<%= encodeURIComponent(product.category_name||'') %>">同カテゴリをもっと見る →</a>
    </div>
    <div class="rail__track">
      <% related.forEach(function(p){ %>
        <%- include('../partials/productCardTall', { p }) %>
      <% }) %>
    </div>
  </section>
  <% } %>
</main>

<!-- ▼ 生産者紹介モーダル（ポップアップ） -->
<div
  class="modal seller-modal"
  id="sellerProfileModal"
  role="dialog"
  aria-modal="true"
  aria-hidden="true">
  <div class="modal__content seller-modal__content" role="document">
    <div class="seller-modal__head">
      <h3 class="seller-modal__title">生産者の詳しい紹介</h3>
      <button
        type="button"
        class="icon-btn seller-modal__close"
        data-seller-modal-close
        aria-label="閉じる">
        ✕
      </button>
    </div>
    <div class="seller-modal__body">
      <iframe
        id="sellerProfileFrame"
        title="生産者紹介"
        loading="lazy"></iframe>
    </div>
  </div>
</div>

<script src="/js/favorites.js"></script>
<script src="/js/product-show.js"></script>
<%- include('../partials/footer') %>