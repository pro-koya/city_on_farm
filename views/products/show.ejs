<%- include('../partials/header', { title: product.title, extraCSS: '/styles/product-show.css' }) %>

<main class="product-page" itemscope itemtype="https://schema.org/Product">
  <a href="/products">←商品一覧へ</a>
  <!-- ===== ファーストビュー ===== -->
  <section class="top">
    <!-- PC: 左＝ギャラリー / 右＝情報、SP: 1カラム -->
    <div class="gallery" aria-label="商品画像ギャラリー">
      <div class="gallery__main">
        <img id="mainImage"
            src="<%= (Array.isArray(product.images) && product.images.length ? product.images[0] : (product.image_url || '/images/placeholder.png')) %>"
            alt="<%= product.title + 'の画像' %>"
            loading="eager"
            itemprop="image">
      </div>

      <% if (Array.isArray(product.images) && product.images.length > 1) { %>
      <div class="thumbs-wrap">
        <!-- <button class="thumbs__nav thumbs__prev" type="button" aria-label="前へ" title="前へ">‹</button> -->
        <div class="thumbs" role="listbox" aria-label="サムネイル">
          <% product.images.forEach(function(img, i){ %>
            <button class="thumb <%= i===0 ? 'is-active':'' %>"
                    data-src="<%= img %>"
                    aria-label="画像 <%= i+1 %> を表示"
                    role="option"
                    aria-selected="<%= i===0 ? 'true' : 'false' %>">
              <img src="<%= img %>"
                  alt="<%= product.title + 'の画像 ' + (i+1) %>"
                  loading="lazy">
            </button>
          <% }) %>
        </div>
        <!-- <button class="thumbs__nav thumbs__next" type="button" aria-label="次へ" title="次へ">›</button> -->
      </div>
      <% } %>
    </div>

    <div class="info">
      <h1 class="title" itemprop="name"><%= product.title %></h1>

      <div class="rating">
        <span class="stars" aria-hidden="true"><%= '★'.repeat(Math.round(product.rating||0)) %><%= '☆'.repeat(5-Math.round(product.rating||0)) %></span>
        <span class="rating__num"><%= product.rating||0 %></span>
        <a class="rating__count" href="#reviews" id="goto-reviews">（<%= product.review_count || 0 %>件のレビュー）</a>
      </div>

      <div class="price-row" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
        <span class="price">¥<span itemprop="price"><%= product.price %></span></span>
        <% if (product.unit) { %><span class="unit">/ <%= product.unit %></span><% } %>
        <link itemprop="priceCurrency" content="JPY">
        <link itemprop="availability" href="https://schema.org/<%= product.stock>0?'InStock':'OutOfStock' %>">
      </div>

      <div class="stock">
        <% if (product.stock > 10) { %>
          <span class="badge">在庫あり</span>
        <% } else if (product.stock > 0) { %>
          <span class="badge badge--low">残り <%= product.stock %> 点</span>
        <% } else { %>
          <span class="badge badge--out">在庫切れ</span>
        <% } %>
        <span class="ship"><%= product.shippingNote || '2〜3日以内に発送' %></span>
      </div>

      <form class="buy" id="buyForm" action="/cart/add" method="POST" data-stock="<%= product.stock %>" novalidate>
        <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>
        <input type="hidden" name="productId" value="<%= product.id %>">
        <label class="qty" for="qty">
          数量
          <div class="stepper" role="group" aria-label="数量の増減">
            <button type="button" class="stepper__btn" data-step="-1" aria-label="数量を減らす">−</button>
            <input id="qty" name="qty" type="number" min="1" value="1" data-max="<%= product.stock %>" max="<%= product.stock %>" inputmode="numeric" pattern="[0-9]*">
            <button type="button" class="stepper__btn" data-step="1" aria-label="数量を増やす">＋</button>
          </div>
        </label>

        <div class="cta">
          <button class="btn btn--buy" type="submit" <%= product.stock>0?'':'disabled' %>>カートに入れる</button>
          <button class="btn btn--wish" type="button" id="favBtn" aria-pressed="false">♡ お気に入り</button>
        </div>
      </form>

      <ul class="assurance">
        <% if (Array.isArray(tags) && tags.length) { %>
          <% tags.forEach(function(tag){ %>
            <li>#<%= tag.name %></li>
          <% }); %>
        <% } %>
      </ul>
    </div>
  </section>

  <!-- ===== 詳細タブ / SPはアコーディオン風 ===== -->
  <section class="details">
    <div class="tabs" role="tablist">
      <button class="tab is-active" role="tab" data-tab="desc">商品説明</button>
      <button class="tab" role="tab" data-tab="seller">出品者情報</button>
      <button class="tab" role="tab" data-tab="specs">サイズ・選定基準</button>
      <button class="tab" role="tab" data-tab="reviews">レビュー</button>
    </div>

    <div class="panes">
      <article id="pane-desc" class="pane is-active" role="tabpanel">
        <div class="prose" itemprop="description">
          <% if (product.description_html) { %>
            <%- product.description_html %>
          <% } else { %>
            <p><%= product.description_html || '商品の詳細説明が入ります。' %></p>
          <% } %>
        </div>
      </article>

      <article id="pane-seller" class="pane" role="tabpanel">
        <div class="seller">
          <img class="seller__avatar" src="<%= (product.seller && product.seller.avatar) || '/images/test-image.jpeg' %>" alt="<%= product.seller_name || '生産者' %>">
          <div class="seller__meta">
            <h3><%= product.seller_name || '生産者名' %></h3>
            <p><%= product.seller?.bio || '生産者紹介文が入ります。' %></p>
            <% if (product.seller && product.seller.location){ %><p class="muted">所在地：<%= product.seller.location %></p><% } %>
            <a class="link" href="/products/list?producer=<%= encodeURIComponent(product.seller?.name||'') %>">この出品者の他商品 →</a>
          </div>
        </div>
      </article>

      <article id="pane-specs" class="pane" role="tabpanel">
        <div class="specs">
          <% if (Array.isArray(specs) && specs.length) { %>
            <div class="table-wrapper">
              <table class="spec-table">
                <tbody>
                  <% specs.forEach(function(row){ %>
                    <tr><th><%= row.label %></th><td><%= row.value %></td></tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
          <% if (product.criteria && product.criteria.length) { %>
          <div class="criteria">
            <h4>選定基準</h4>
            <ul>
              <% product.criteria.forEach(function(c){ %>
                <li><%= c %></li>
              <% }) %>
            </ul>
          </div>
          <% } %>
        </div>
      </article>

      <!-- レビュー -->
      <article id="pane-reviews" class="pane" role="tabpanel">
        <div id="reviews">
          <div class="review-head">
            <h3>レビュー</h3>
            <div class="score"><strong><%= product.rating || 0 %></strong> / 5（<%= product.review_count||0 %>件）</div>
            <% if (currentUser) { %>
              <button class="btn btn--buy" id="openReviewModal"
                      data-has-review="<%= myReview ? '1':'0' %>"
                      data-stars="<%= myReview?.rating || 5 %>"
                      data-body="<%- (myReview?.body || '').replace(/"/g, '&quot;') %>"
                      data-review-id="<%= myReview?.id || '' %>">
                <%= myReview ? 'レビューを編集' : 'レビューを書く' %>
              </button>
            <% } %>
          </div>

          <% if (reviews && reviews.length) { %>
            <ul class="review-list" id="reviewList">
              <% reviews.forEach(function(r){ %>
                <li class="review" id="rev-<%= r.id %>">
                  <div class="review__meta">
                    <span class="review__stars" aria-label="<%= r.stars %>点"><%= '★'.repeat(r.stars) %><%= '☆'.repeat(5-r.stars) %></span>
                    <span class="review__author"><%= r.author %></span>
                    <span class="review__date"><%= new Date(r.created_at).toLocaleDateString('ja-JP') %></span>
                    <% if (currentUser && r.user_id === currentUser.id) { %>
                      <span class="badge mine">あなたのレビュー</span>
                    <% } %>
                  </div>
                  <% if (r.title) { %><h4 class="review__title"><%= r.title %></h4><% } %>
                  <!-- ★ 改行を尊重して表示（CSSで pre-wrap） -->
                  <p class="review__body"><%= r.text %></p>
                </li>
              <% }) %>
            </ul>
            <% if ((product.review_count||0) > reviews.length) { %>
              <a class="link" href="/products/<%= product.slug || product.id %>/reviews">すべてのレビューを見る →</a>
            <% } %>
          <% } else { %>
            <p class="muted">まだレビューはありません。</p>
          <% } %>
        </div>
      </article>

      <!-- ▼ レビュー投稿/編集モーダル -->
      <div class="modal" id="reviewModal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal__content" role="document">
          <div class="modal__head">
            <h3 id="reviewModalTitle">レビューを書く</h3>
            <button type="button" class="icon-btn" id="closeReviewModal" aria-label="閉じる">✕</button>
          </div>

          <form id="reviewForm" action="/products/<%= product.id %>/reviews" method="POST" novalidate>
            <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
            <input type="hidden" name="review_id" id="rv_id" value="">
            <fieldset class="stars">
              <legend>評価</legend>
              <div class="stars__row" id="starsRow" data-value="5" aria-label="星で評価">
                <!-- JSで .is-active を付け替え -->
                <button type="button" class="star" data-v="1" aria-label="1点">★</button>
                <button type="button" class="star" data-v="2" aria-label="2点">★</button>
                <button type="button" class="star" data-v="3" aria-label="3点">★</button>
                <button type="button" class="star" data-v="4" aria-label="4点">★</button>
                <button type="button" class="star" data-v="5" aria-label="5点">★</button>
              </div>
              <input type="hidden" name="rating" id="rv_stars">
            </fieldset>

            <div class="field">
              <label for="rvTitle">タイトル</label>
              <input id="rvTitle" name="title" type="text" maxlength="120" value="<%= myReview?.title||'' %>">
            </div>

            <div class="field">
              <label for="rv_body">本文</label>
              <textarea id="rv_body" name="body" rows="6" placeholder="商品の良かった点・改善してほしい点など自由にどうぞ"></textarea>
              <p class="hint">※ 公序良俗に反する内容は掲載できません</p>
              <p class="error" id="rv_error"></p>
            </div>

            <div class="modal__foot">
              <button type="button" class="btn btn--ghost" id="cancelReview">キャンセル</button>
              <button type="submit" class="btn btn--buy" id="saveReview">保存</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== 関連商品 ===== -->
  <% if (related && related.length) { %>
  <section class="rail">
    <div class="rail__head">
      <h2>関連商品</h2>
      <a class="link" href="/products/list?category=<%= encodeURIComponent(product.category_name||'') %>">同カテゴリをもっと見る →</a>
    </div>
    <div class="rail__track">
      <% related.forEach(function(p){ %>
        <%- include('../partials/productCardTall', { p }) %>
      <% }) %>
    </div>
  </section>
  <% } %>
</main>

<script src="/js/product-show.js"></script>
<%- include('../partials/footer') %>