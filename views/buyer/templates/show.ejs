<%- include('../../partials/header', { title: `テンプレート: ${template.name}`, extraCSS2: '',
  extraCSS: '/styles/order-templates.css' }) %>

<main class="tpl-show">
  <!-- ヘッダー -->
  <div class="tpl-show__head">
    <div class="tpl-show__head-left">
      <a href="/my/templates" class="btn btn--ghost btn--sm">&larr; 一覧に戻る</a>
      <h1><%= template.name %></h1>
      <div class="tpl-show__meta">
        <span class="pill pill--small"><%= template.seller_name || '出品者' %></span>
        <span class="muted">作成: <%= new Date(template.created_at).toLocaleDateString('ja-JP') %></span>
        <span class="muted">更新: <%= new Date(template.updated_at).toLocaleDateString('ja-JP') %></span>
      </div>
    </div>
    <div class="tpl-show__head-right">
      <form method="POST" action="/my/templates/<%= template.id %>/to-cart" class="inline">
        <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>
        <button type="submit" class="btn btn--primary">カートに一括追加</button>
      </form>
    </div>
  </div>

  <% if (flash) { %>
    <div class="alert alert--<%= flash.type === 'success' ? 'safe' : 'danger' %>">
      <%= flash.message %>
    </div>
  <% } %>

  <!-- テンプレート名編集 -->
  <section class="card tpl-edit-name">
    <form method="POST" action="/my/templates/<%= template.id %>/update" class="tpl-name-form">
      <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>
      <div class="field field--inline">
        <label for="tpl_name">テンプレート名</label>
        <input type="text" id="tpl_name" name="name" value="<%= template.name %>" maxlength="60" required>
        <button type="submit" class="btn btn--ghost btn--sm">名前を変更</button>
      </div>
    </form>
  </section>

  <!-- 商品一覧 -->
  <section class="card">
    <div class="card__head">
      <h2>登録商品（<%= items.length %>件）</h2>
      <button type="button" class="btn btn--primary btn--sm" id="openAddProductModal">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="margin-right:2px;">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        商品を追加
      </button>
    </div>

    <% if (!items.length) { %>
      <div style="padding: 2.5rem 1rem; text-align: center;">
        <p class="muted" style="margin: 0 0 1rem;">商品が登録されていません。</p>
        <button type="button" class="btn btn--primary" id="openAddProductModalEmpty">商品を追加する</button>
      </div>
    <% } else { %>
      <form method="POST" action="/my/templates/<%= template.id %>/update" id="tplUpdateForm">
        <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>
        <ul class="tpl-items">
          <% items.forEach(function(it) {
            const displayPrice = it.variant_price != null ? it.variant_price : it.price;
            const displayUnit = it.variant_unit || it.unit;
            const displayStock = it.variant_stock != null ? it.variant_stock : it.stock;
          %>
            <li class="tpl-item <%= !it.is_active || displayStock <= 0 ? 'tpl-item--unavailable' : '' %>">
              <a class="tpl-item__thumb" href="/products/<%= it.id %>">
                <img src="<%= it.image_url || '/images/placeholder.png' %>" alt="<%= it.title %>" loading="lazy">
              </a>
              <div class="tpl-item__main">
                <a class="tpl-item__title" href="/products/<%= it.id %>"><%= it.title %><% if (it.variant_label) { %> <small>(<%= it.variant_label %>)</small><% } %></a>
                <div class="tpl-item__meta">
                  <span>&#165;<%= Number(displayPrice).toLocaleString() %> / <%= displayUnit || '点' %></span>
                  <% if (!it.is_active) { %>
                    <span class="badge badge--danger">非公開</span>
                  <% } else if (displayStock <= 0) { %>
                    <span class="badge badge--danger">在庫なし</span>
                  <% } else if (displayStock <= 10) { %>
                    <span class="badge badge--warn">在庫わずか</span>
                  <% } %>
                </div>
              </div>
              <div class="tpl-item__qty">
                <label class="sr-only" for="qty_<%= it.template_item_id %>">数量</label>
                <div class="qty" role="group" aria-label="数量">
                  <button class="qty__btn" type="button" data-act="dec" aria-label="減らす">&minus;</button>
                  <input class="qty__input" type="number" min="1" step="1"
                    id="qty_<%= it.template_item_id %>"
                    name="quantities[<%= it.template_item_id %>]"
                    value="<%= it.quantity %>" inputmode="numeric">
                  <button class="qty__btn" type="button" data-act="inc" aria-label="増やす">+</button>
                </div>
              </div>
              <div class="tpl-item__actions">
                <button type="button" class="btn btn--ghost btn--sm btn--danger tpl-remove-btn"
                        title="削除"
                        data-template-id="<%= template.id %>"
                        data-item-id="<%= it.template_item_id %>">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6l-1 14H6L5 6"/>
                    <path d="M10 11v6"/>
                    <path d="M14 11v6"/>
                    <path d="M9 6V4h6v2"/>
                  </svg>
                </button>
              </div>
            </li>
          <% }) %>
        </ul>
        <div class="tpl-save-bar">
          <button type="submit" class="btn btn--primary">数量を保存</button>
        </div>
      </form>
    <% } %>
  </section>

  <!-- 削除用の隠しフォーム（ネスト回避） -->
  <form id="removeItemForm" method="POST" action="" style="display:none;">
    <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <% } %>
    <input type="hidden" name="itemId" id="removeItemId" value="">
  </form>

  <!-- 削除 -->
  <section class="tpl-danger-zone">
    <form method="POST" action="/my/templates/<%= template.id %>/delete"
          onsubmit="return confirm('このテンプレートを完全に削除しますか？この操作は元に戻せません。')">
      <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>
      <button type="submit" class="btn btn--ghost btn--sm btn--danger">このテンプレートを削除</button>
    </form>
  </section>
</main>

<!-- 商品追加モーダル -->
<div id="addProductModal" class="modal" style="display: none;">
  <div class="modal__overlay"></div>
  <div class="modal__content">
    <div class="modal__header">
      <h2>商品を追加</h2>
      <button class="modal__close" type="button" aria-label="閉じる">&times;</button>
    </div>
    <div class="modal__body">
      <div class="search-box">
        <svg class="search-box__icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input type="text" class="search-box__input" id="productSearchInput"
               placeholder="商品名で検索..."
               data-seller-partner-id="<%= template.seller_partner_id %>">
      </div>
      <div id="searchResultsContainer">
        <p class="search-results__empty">商品名を入力して検索してください</p>
      </div>
    </div>
    <div class="modal__footer">
      <button type="button" class="btn btn--ghost" id="cancelAddProduct">キャンセル</button>
      <form method="POST" action="/my/templates/<%= template.id %>/add-item" id="addProductForm" class="inline">
        <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>
        <input type="hidden" name="productId" id="selectedProductId" value="">
        <input type="hidden" name="quantity" value="1">
        <button type="submit" class="btn btn--primary" id="confirmAddProduct" disabled>追加する</button>
      </form>
    </div>
  </div>
</div>

<script src="/js/order-templates.js"></script>
<%- include('../../partials/footer') %>
