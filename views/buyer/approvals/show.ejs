<%- include('../../partials/header', { title: '承認詳細', extraCSS2: '',
  extraCSS: '/styles/approval.css' }) %>

<main class="appr-show">
  <div class="appr-show__head">
    <a href="/my/approvals" class="btn btn--ghost btn--sm" style="margin-bottom:.5rem;">&larr; 承認待ち一覧に戻る</a>
    <h1>承認詳細</h1>
  </div>

  <% if (flash) { %>
    <div class="alert alert--<%= flash.type === 'success' ? 'safe' : 'danger' %>">
      <%= flash.message %>
    </div>
  <% } %>

  <%
    const statusMap = {
      pending: { label: '承認待ち', cls: 'pending' },
      approved: { label: '承認済み', cls: 'approved' },
      rejected: { label: '却下', cls: 'rejected' },
      ordered: { label: '注文済み', cls: 'ordered' },
      cancelled: { label: 'キャンセル', cls: 'cancelled' }
    };
    const st = statusMap[request.status] || { label: request.status, cls: '' };
  %>

  <!-- リクエスト情報 -->
  <section class="card">
    <div class="card__head"><h2>申請情報</h2></div>
    <dl class="kv">
      <div><dt>申請者</dt><dd><%= request.requester_name || '—' %></dd></div>
      <div><dt>申請日時</dt><dd><%= new Date(request.created_at).toLocaleString('ja-JP') %></dd></div>
      <div><dt>小計</dt><dd>&#165;<%= Number(request.subtotal || 0).toLocaleString() %></dd></div>
      <div><dt>合計</dt><dd><strong>&#165;<%= Number(request.total || 0).toLocaleString() %></strong></dd></div>
      <div><dt>承認状態</dt>
        <dd>
          <span class="pill pill--small pill--<%= st.cls %>"><%= st.label %></span>
        </dd>
      </div>
    </dl>
  </section>

  <!-- 申請商品 -->
  <section class="card">
    <div class="card__head"><h2>申請商品</h2></div>
    <ul class="appr-items">
      <% items.forEach(function(it) { %>
        <li class="appr-item">
          <img src="<%= it.image_url || '/images/placeholder.png' %>" alt="" class="appr-item__img">
          <div class="appr-item__main">
            <div class="appr-item__title"><%= it.title %></div>
            <div class="appr-item__meta">
              数量: <%= it.quantity %><%= it.unit || '点' %>
              / 単価: &#165;<%= Number(it.price || 0).toLocaleString() %>
            </div>
          </div>
          <div class="appr-item__amount">&#165;<%= Number((it.price || 0) * it.quantity).toLocaleString() %></div>
        </li>
      <% }) %>
    </ul>
  </section>

  <!-- 承認履歴 -->
  <section class="card">
    <div class="card__head"><h2>承認履歴</h2></div>
    <% if (approvalSteps.length) { %>
      <ul class="appr-history">
        <% approvalSteps.forEach(function(a) { %>
          <li class="appr-history__item appr-history--<%= a.status %>">
            <div class="appr-history__step">ステップ <%= a.step_order %></div>
            <div class="appr-history__status">
              <span class="pill pill--small pill--<%= a.status %>">
                <%= a.status === 'pending' ? '待ち' : a.status === 'approved' ? '承認' : '却下' %>
              </span>
            </div>
            <% if (a.approver_name) { %>
              <div class="appr-history__who"><%= a.approver_name %></div>
            <% } %>
            <% if (a.decided_at) { %>
              <div class="appr-history__when"><%= new Date(a.decided_at).toLocaleString('ja-JP') %></div>
            <% } %>
            <% if (a.comment) { %>
              <div class="appr-history__comment"><%= a.comment %></div>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p class="muted" style="padding: 1rem;">承認履歴はまだありません。</p>
    <% } %>
  </section>

  <!-- 承認/却下アクション -->
  <% if (request.status === 'pending') { %>
    <section class="card appr-actions-card" style="border-left: 4px solid #059669;">
      <div class="card__head"><h2>承認する / 却下する</h2></div>
      <p class="muted" style="padding: 0 1rem 0.5rem;">この申請に対して承認または却下の操作を行ってください。</p>
      <div class="appr-comment">
        <label for="appr_comment">コメント（任意）</label>
        <textarea id="appr_comment" rows="3" placeholder="承認・却下の理由やメモ..."></textarea>
      </div>
      <div class="appr-action-btns">
        <form method="POST" action="/my/approvals/requests/<%= request.id %>/approve" class="inline" id="approveForm">
          <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <% } %>
          <input type="hidden" name="comment" class="js-comment-input">
          <button type="submit" class="btn btn--primary btn--lg">承認する</button>
        </form>
        <form method="POST" action="/my/approvals/requests/<%= request.id %>/reject" class="inline" id="rejectForm"
              onsubmit="return confirm('この承認リクエストを却下しますか？')">
          <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <% } %>
          <input type="hidden" name="comment" class="js-comment-input">
          <button type="submit" class="btn btn--ghost btn--danger btn--lg">却下する</button>
        </form>
      </div>
    </section>
  <% } %>
</main>

<script>
(function() {
  var textarea = document.getElementById('appr_comment');
  if (!textarea) return;
  var inputs = document.querySelectorAll('.js-comment-input');
  textarea.addEventListener('input', function() {
    inputs.forEach(function(inp) { inp.value = textarea.value; });
  });
})();
</script>

<%- include('../../partials/footer') %>
