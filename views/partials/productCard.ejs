<div class="card">
  <a href="/products/<%= p.id %>" data-product-id="<%= p.id %>" aria-label="<%= p.name %>ã®è©³ç´°">
    <%
      const created = new Date(p.created_at);
      const today = new Date();
  
      created.setHours(0, 0, 0, 0);
      today.setHours(0, 0, 0, 0);
  
      const diffDays = (today - created) / (1000 * 60 * 60 * 24);
    %>
    <!-- é †ä½ãƒãƒƒã‚¸ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºæ™‚ï¼‰ -->
    <% if (typeof showRank !== 'undefined' && showRank && typeof rank !== 'undefined') { %>
      <span class="badge--rank badge--rank--<%= rank <= 3 ? rank : 'other' %>">
        <% if (rank === 1) { %>ğŸ¥‡<% } else if (rank === 2) { %>ğŸ¥ˆ<% } else if (rank === 3) { %>ğŸ¥‰<% } else { %><%= rank %>ä½<% } %>
      </span>
    <% } %>

    <% if (diffDays <= 3 && diffDays >= 0) { %>
      <span class="badge--new">NEW</span>
    <% } %>
    
    <% if (p.stock === 0) { %>
      <span class="badge--low zero">åœ¨åº«åˆ‡ã‚Œ</span>
    <% } else if (p.stock < 5) { %>
      <span class="badge--low">æ®‹ã‚Š<%= p.stock %>ç‚¹</span>
    <% } %>

    <!-- ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ -->
    <% if (typeof currentUser !== 'undefined' && currentUser) { %>
    <button type="button" 
            class="favorite-btn <%= (typeof p.isFavorited !== 'undefined' && p.isFavorited) ? 'is-favorited' : '' %>" 
            data-product-id="<%= p.id %>"
            aria-label="<%= (typeof p.isFavorited !== 'undefined' && p.isFavorited) ? 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤' : 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ' %>"
            aria-pressed="<%= (typeof p.isFavorited !== 'undefined' && p.isFavorited) ? 'true' : 'false' %>">
      <svg class="favorite-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    </button>
    <% } else { %>
    <a href="/login" class="favorite-btn favorite-btn--guest" aria-label="ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ">
      <svg class="favorite-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    </a>
    <% } %>

    <img src="<%= p.image_url %>" alt="<%= p.title %>">
    <div class="card__body">
      <h3 class="card__name"><%= p.title %></h3>
      <div class="card__meta">
        <span>Â¥<%= p.price %></span>
        <span><%= p.unit || '' %></span>
      </div>
      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æƒ…å ±ï¼ˆäººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºæ™‚ï¼‰ -->
      <% if (typeof showRank !== 'undefined' && showRank && p.quantity_sold != null) { %>
        <div class="card__stats" style="margin-top: 6px; font-size: 0.85rem; color: var(--muted);">
          <span>å£²ã‚ŒãŸå€‹æ•°: <%= p.quantity_sold || 0 %>å€‹</span>
          <% if (p.order_count != null) { %>
            <span style="margin-left: 8px;">æ³¨æ–‡æ•°: <%= p.order_count || 0 %>ä»¶</span>
          <% } %>
        </div>
      <% } %>
      <!-- ãŠæ°—ã«å…¥ã‚Šæ•°ï¼ˆã¿ã‚“ãªã®ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤ºæ™‚ï¼‰ -->
      <% if (typeof showFavoriteCount !== 'undefined' && showFavoriteCount && p.favorite_count != null && p.favorite_count > 0) { %>
        <div class="card__favorite-count" style="margin-top: 6px; font-size: 0.85rem; color: var(--muted); display: flex; align-items: center; gap: 4px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="var(--danger)" stroke="var(--danger)" stroke-width="2" style="flex-shrink: 0;">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          <span><%= p.favorite_count %>äººãŒãŠæ°—ã«å…¥ã‚Š</span>
        </div>
      <% } %>
    </div>
  </a>
  <form class="buy buyForm" action="/cart/add" method="POST" data-stock="<%= p.stock %>" novalidate>
    <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <% } %>
    <input type="hidden" name="productId" value="<%= p.id %>">
    <label class="qty" for="qty">
      æ•°é‡
      <div class="stepper" role="group" aria-label="æ•°é‡ã®å¢—æ¸›">
        <button type="button" class="stepper__btn" data-step="-1" aria-label="æ•°é‡ã‚’æ¸›ã‚‰ã™">âˆ’</button>
        <input class="qty-data" name="qty" type="number" min="1" value="1" data-max="<%= p.stock %>" max="<%= p.stock %>" inputmode="numeric" pattern="[0-9]*">
        <button type="button" class="stepper__btn" data-step="1" aria-label="æ•°é‡ã‚’å¢—ã‚„ã™">ï¼‹</button>
      </div>
    </label>

    <div class="cta">
      <button class="btn btn--buy" type="submit" <%= p.stock>0?'':'disabled' %>>ã‚«ãƒ¼ãƒˆè¿½åŠ </button>
      <!-- <button class="btn btn--wish" type="button" id="favBtn" aria-pressed="false">â­ï¸</button> -->
    </div>
  </form>
</div>