<div class="card">
  <a href="/products/<%= p.slug || p.id %>" data-product-id="<%= p.id %>" aria-label="<%= p.name %>の詳細">
    <%
      const created = new Date(p.created_at);
      const today = new Date();
  
      created.setHours(0, 0, 0, 0);
      today.setHours(0, 0, 0, 0);
  
      const diffDays = (today - created) / (1000 * 60 * 60 * 24);
    %>
    <% if (diffDays <= 3 && diffDays >= 0) { %>
      <span class="badge--new">NEW</span>
    <% } %>
    
    <% if (p.stock === 0) { %>
      <span class="badge--low">在庫切れ</span>
    <% } else if (p.stock < 5) { %>
      <span class="badge--low">残り<%= p.stock %>点</span>
    <% } %>
    <img src="<%= p.image_url %>" alt="<%= p.title %>">
    <div class="card__body">
      <h3 class="card__name"><%= p.title %></h3>
      <div class="card__meta">
        <span>¥<%= p.price %></span>
        <span><%= p.unit || '' %></span>
      </div>
    </div>
  </a>
  <form class="buy buyForm" action="/cart/add" method="POST" data-stock="<%= p.stock %>" novalidate>
    <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <% } %>
    <input type="hidden" name="productId" value="<%= p.id %>">
    <label class="qty" for="qty">
      数量
      <div class="stepper" role="group" aria-label="数量の増減">
        <button type="button" class="stepper__btn" data-step="-1" aria-label="数量を減らす">−</button>
        <input class="qty-data" name="qty" type="number" min="1" value="1" data-max="<%= p.stock %>" max="<%= p.stock %>" inputmode="numeric" pattern="[0-9]*">
        <button type="button" class="stepper__btn" data-step="1" aria-label="数量を増やす">＋</button>
      </div>
    </label>

    <div class="cta">
      <button class="btn btn--buy" type="submit" <%= p.stock>0?'':'disabled' %>>カート追加</button>
      <button class="btn btn--wish" type="button" id="favBtn" aria-pressed="false">⭐︎</button>
    </div>
  </form>
</div>