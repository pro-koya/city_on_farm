<div class="card" data-product-id="<%= p.id %>">
  <% 
    const productUrl = `/products/${p.id}`;
    const created = new Date(p.created_at);
    const today = new Date();

    created.setHours(0, 0, 0, 0);
    today.setHours(0, 0, 0, 0);

    const diffDays = (today - created) / (1000 * 60 * 60 * 24);
  %>

  <!-- ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ â€»ã‚«ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã¨ã¯åˆ¥è¦ç´ ã«ã™ã‚‹ -->
  <% if (typeof currentUser !== 'undefined' && currentUser) { %>
    <button type="button" 
            class="favorite-btn <%= (typeof p.isFavorited !== 'undefined' && p.isFavorited) ? 'is-favorited' : '' %>" 
            data-product-id="<%= p.id %>"
            aria-label="<%= (typeof p.isFavorited !== 'undefined' && p.isFavorited) ? 'ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å‰Šé™¤' : 'ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ' %>"
            aria-pressed="<%= (typeof p.isFavorited !== 'undefined' && p.isFavorited) ? 'true' : 'false' %>">
      <svg class="favorite-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    </button>
  <% } else { %>
    <!-- æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã¯ãƒ­ã‚°ã‚¤ãƒ³ã¸èª˜å°ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«æˆ»ã‚Œã‚‹ã‚ˆã† next ä»˜ãï¼‰ -->
    <a href="/login?next=<%= encodeURIComponent(productUrl) %>" 
       class="favorite-btn favorite-btn--guest" 
       aria-label="ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‹ã‚‰ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ">
      <svg class="favorite-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
    </a>
  <% } %>

  <!-- ã‚«ãƒ¼ãƒ‰å…¨ä½“ã®ãƒªãƒ³ã‚¯ï¼ˆå•†å“è©³ç´°ã¸ï¼‰ -->
  <a href="<%= productUrl %>" 
     class="card__link"
     data-product-id="<%= p.id %>" 
     aria-label="<%= p.title %>ã®è©³ç´°">

    <!-- é †ä½ãƒãƒƒã‚¸ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºæ™‚ï¼‰ -->
    <% if (typeof showRank !== 'undefined' && showRank && typeof rank !== 'undefined') { %>
      <span class="badge--rank badge--rank--<%= rank <= 3 ? rank : 'other' %>">
        <% if (rank === 1) { %>ğŸ¥‡<% } else if (rank === 2) { %>ğŸ¥ˆ<% } else if (rank === 3) { %>ğŸ¥‰<% } else { %><%= rank %>ä½<% } %>
      </span>
    <% } %>

    <% if (diffDays <= 3 && diffDays >= 0) { %>
      <span class="badge--new">NEW</span>
    <% } %>
    
    <% if (p.stock === 0) { %>
      <span class="badge--low zero">åœ¨åº«åˆ‡ã‚Œ</span>
    <% } else if (p.stock < 5) { %>
      <span class="badge--low">æ®‹ã‚Š<%= p.stock %>ç‚¹</span>
    <% } %>

    <img src="<%= p.image_url %>" alt="<%= p.title %>">
    <div class="card__body">
      <h3 class="card__name"><%= p.title %></h3>
      <div class="card__meta">
        <span>Â¥<%= p.price %><%= p.has_variants ? 'ã€œ' : '' %></span>
        <span><%= p.unit || '' %></span>
      </div>

      <!-- å‡ºå“è€…å -->
      <div class="card__seller">
        <% if (p.seller_partner_icon_url) { %>
          <!-- ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒãŒã‚ã‚‹å ´åˆ -->
          <img class="card__seller-icon-img"
               src="<%= p.seller_partner_icon_url %>"
               alt="<%= p.seller_partner_name || p.seller_name %>ã®ã‚¢ã‚¤ã‚³ãƒ³">
        <% } else { %>
          <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šSVGã‚¢ã‚¤ã‚³ãƒ³ -->
          <svg class="card__seller-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        <% } %>
        <span class="card__seller-name"><%= p.seller_partner_name || p.seller_name || 'å‡ºå“è€…ä¸æ˜' %></span>
      </div>

      <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æƒ…å ±ï¼ˆäººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºæ™‚ï¼‰ -->
      <% if (typeof showRank !== 'undefined' && showRank && p.quantity_sold != null) { %>
        <div class="card__stats" style="margin-top: 6px; font-size: 0.85rem; color: var(--muted);">
          <span>è²©å£²æ•°: <%= p.quantity_sold || 0 %></span>
          <% if (p.order_count != null) { %>
            <span style="margin-left: 8px;">æ³¨æ–‡æ•°: <%= p.order_count || 0 %>ä»¶</span>
          <% } %>
        </div>
      <% } %>

      <!-- ãŠæ°—ã«å…¥ã‚Šæ•°ï¼ˆã¿ã‚“ãªã®ãŠæ°—ã«å…¥ã‚Šè¡¨ç¤ºæ™‚ï¼‰ -->
      <% if (typeof showFavoriteCount !== 'undefined' && showFavoriteCount && p.favorite_count != null && p.favorite_count > 0) { %>
        <div class="card__favorite-count" style="margin-top: 6px; font-size: 0.85rem; color: var(--muted); display: flex; align-items: center; gap: 4px;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="var(--danger)" stroke="var(--danger)" stroke-width="2" style="flex-shrink: 0;">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
          </svg>
          <span><%= p.favorite_count %>äººãŒãŠæ°—ã«å…¥ã‚Š</span>
        </div>
      <% } %>
    </div>
  </a>
</div>