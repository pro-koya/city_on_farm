<%- include('../partials/header', { title: 'ご注文手続き', extraCSS: '/styles/checkout.css' }) %>

<main class="checkout">
  <form id="checkoutForm" class="ck-grid" method="POST" action="/checkout">
    <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <% } %>
    <input type="hidden" name="sellerId" value="<%= sellerId %>">

    <!-- 左カラム：入力領域 -->
    <section class="ck-left">

      <section class="card sticky">
        <h2>ご注文内容</h2>

        <ul class="mini-cart">
          <% (items || []).forEach(function(it){ %>
            <li class="mini-row">
              <img src="<%= it.image_url || '/images/placeholder.png' %>" alt="" loading="lazy">
              <div class="mini-main">
                <div class="mini-title"><%= it.title %></div>
                <div class="mini-meta">数量 × 単価：<%= it.quantity %> × ¥<%= Number(it.price).toLocaleString() %></div>
                <div class="mini-meta">数量1あたり：<%= it.unit || '点' %></div>
              </div>
              <div class="mini-sub">¥<%= Number(it.price*it.quantity).toLocaleString() %></div>
            </li>
          <% }) %>
        </ul>

        <div class="sum">
          <div class="row"><span>小計</span><strong class="sumSubtotal">¥<%= Number(totals?.subtotal||0).toLocaleString() %></strong></div>
          <div class="row"><span>割引</span><strong class="sumDiscount">-¥<%= Number(totals?.discount||0).toLocaleString() %></strong></div>
          <div class="row"><span>送料</span><strong class="sumShipping">¥<%= Number(totals?.shipping||0).toLocaleString() %></strong></div>
          <hr>
          <div class="row total"><span>合計</span><strong class="sumTotal">¥<%= Number(totals?.total||0).toLocaleString() %></strong></div>
        </div>

      </section>

      <!-- 受け取り方法・日時 -->
      <section class="card" id="shipMethodCard">
        <div class="card__head"><h2>受け取り方法・日時</h2></div>
        <div class="field field--row">
          <div>
            <label for="shipMethod">受け取り方法</label>
            <select class="pulldown" name="shipMethod" id="shipMethod" required>
              <% (allowedShipMethods || []).forEach(function(m){ %>
                <option value="<%= m.code %>" <%= form.shipMethod === m.code ? 'selected' : '' %>>
                  <%= m.label_ja || m.code %>
                </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="ev_date"><%= form.shipMethod === 'pickup' ? '受け取り希望日（任意）' : 'お届け希望日（任意）' %></label>
            <input id="ev_date" type="text" name="ev_date" value="<%= form.shipDate || '' %>">
            <input type="hidden" id="shipDate" name="shipDate" value="<%= form.shipDate || '' %>">
          </div>
          <div>
            <label for="shipTime"><%= form.shipMethod === 'pickup' ? '受け取り時間帯（任意）' : 'お届け時間帯（任意）' %></label>
            <select class="pulldown" id="shipTime" name="shipTime">
              <option value="">指定なし</option>
              <option value="am"    <%= form.shipTime === 'am' ? 'selected' : '' %>>午前中</option>
              <option value="14-16" <%= form.shipTime === '14-16' ? 'selected' : '' %>>14-16時</option>
              <option value="16-18" <%= form.shipTime === '16-18' ? 'selected' : '' %>>16-18時</option>
              <option value="18-20" <%= form.shipTime === '18-20' ? 'selected' : '' %>>18-20時</option>
              <option value="19-21" <%= form.shipTime === '19-21' ? 'selected' : '' %>>19-21時</option>
            </select>
          </div>
        </div>
        <p class="help" id="shipHelp">
          <%= form.shipMethod === 'pickup'
              ? '受け取り場所は出品者指定の畑になります。詳細はご注文確定後のメールをご確認ください。'
              : 'ご指定の配送先へお届けします。' %>
        </p>
      </section>

      <!-- 配送先（pickupでは非表示） -->
      <section class="card" id="shippingAddress" aria-hidden="<%= form.shipMethod === 'pickup' ? 'true' : 'false' %>">
        <div class="card__head">
          <h2>配送先住所</h2>
          <button class="link" type="button" id="openAddressModal" aria-haspopup="dialog">＋ 新しい住所を追加</button>
        </div>
          <p class="muted" id="shippingAddrInv" aria-hidden="<%= form.shipMethod === 'pickup' ? 'true' : 'false' %>">畑受け取りでは配送先は不要です。</p>
          <ul id="shippingAddrList" class="addr-list" role="list" aria-hidden="<%= form.shipMethod === 'pickup' ? 'true' : 'false' %>">
            <% addresses.forEach(function(a){ %>
              <li class="addr-item">
                <label class="addr-radio">
                  <input type="radio" name="shippingAddressId" value="<%= a.id %>" <%= String(form.shippingAddressId) === String(a.id) ? 'checked' : '' %> >
                  <div class="addr-body">
                    <div class="addr-name"><%= a.full_name %>（<%= a.phone %>）</div>
                    <div class="addr-lines">
                      〒<%= a.postal_code %>：<%= a.prefecture %><%= a.city %><%= a.address_line1 %> <%= a.address_line2 || '' %>
                    </div>
                    <% if (a.is_default) { %><span class="badge">既定</span><% } %>
                  </div>
                </label>
              </li>
              <% }); %>
          </ul>
      </section>

      <!-- 請求先（pickupでも必要） -->
      <section class="card" id="billingAddress">
        <div class="card__head">
          <h2>請求先住所</h2>
        </div>

        <label class="check" id="billSameCheck" aria-hidden="<%= form.shipMethod === 'pickup' ? 'true' : 'false' %>">
          <input type="checkbox" id="billSame" name="billSame" value="1" <%= (!selectedBillingId) ? 'checked' : '' %> >
          配送先と同じにする
        </label>

        <button class="link" type="button" id="openBillingAddressModal" aria-haspopup="dialog">＋ 新しい請求先を追加</button>
        <div id="billingBlock" class="<%= (form.shipMethod === 'delivery' && !selectedBillingId) ? 'is-hidden' : '' %>">
          <ul id="billingAddrList" class="addr-list" role="list">
              <% addresses.forEach(function(a){ %>
                <li class="addr-item">
                  <label class="addr-radio">
                    <input type="radio" name="billingAddressId" value="<%= a.id %>" <%= String(form.billingAddressId) === String(a.id) ? 'checked' : '' %> >
                    <div class="addr-body">
                      <div class="addr-name"><%= a.full_name %>（<%= a.phone %>）</div>
                      <div class="addr-lines">
                        〒<%= a.postal_code %>　<%= a.prefecture %><%= a.city %><%= a.address_line1 %> <%= a.address_line2 || '' %>
                      </div>
                      <% if (a.is_default) { %><span class="badge">既定</span><% } %>
                    </div>
                  </label>
                </li>
              <% }) %>
            </ul>
        </div>
      </section>

      <!-- お支払い方法 -->
      <section class="card">
        <div class="card__head"><h2>お支払い方法</h2></div>

        <% if (!allowedPayments || !allowedPayments.length) { %>
          <p class="muted">利用可能な決済方法がありません。出品者へお問い合わせください。</p>
        <% } else { %>
          <div class="field">
            <% allowedPayments.forEach(pm => { %>
              <label class="radio">
                <input
                  type="radio"
                  name="paymentMethod"
                  value="<%= pm.code %>"
                  <%= form.paymentMethod === pm.code ? 'checked' : '' %>
                >
                <%= pm.label_ja || pm.code %>
              </label>
            <% }) %>
          </div>
        <% } %>
      </section>

      <!-- クーポン・規約 -->
      <section class="card coupon-card" id="coupon_card">
        <div class="card__head"><h2>クーポン・ご要望</h2></div>
        <div class="field field--row">
          <div class="coupon">
            <label for="couponCode">クーポンコード</label>
            <div class="row">
              <input id="couponCode" type="text" placeholder="例）SUM10" value="<%= (form?.couponCode || (req.session?.cart?.coupon?.code || '')) %>" <%= (req.session?.cart?.coupon?.code ? 'disabled' : '') %> >
              <button type="button" class="btn btn--ghost" id="applyCoupon" <%= (req.session?.cart?.coupon?.code ? 'disabled' : '') %> >適用</button>
              <button type="button" class="btn btn--ghost" id="removeCoupon" <%= (req.session?.cart?.coupon?.code ? '' : 'disabled') %> >解除</button>
            </div>
            <p class="help" id="couponMsg">
              <%= (req.session?.cart?.coupon?.code ? `適用中: ${req.session.cart.coupon.code}` : '') %>
            </p>
            </div>
            <p class="help" id="couponMsg"></p>
          </div>
          <div class="note field">
            <label for="orderNote">ご要望・備考（任意）</label>
            <textarea id="orderNote" name="orderNote" rows="3" placeholder="例）不在時は宅配ボックスへ など"><%= form.orderNote %></textarea>
          </div>
        </div>
        <label class="check agree">
          <input type="checkbox" name="agree" value="1" required> 利用規約とキャンセルポリシーに同意します
        </label>
      </section>

    </section>

    <!-- 右カラム：サマリー -->
    <aside class="ck-right">
      <section class="card sticky">
        <h2>ご注文内容</h2>

        <ul class="mini-cart">
          <% (items || []).forEach(function(it){ %>
            <li class="mini-row">
              <img src="<%= it.image_url || '/images/placeholder.png' %>" alt="" loading="lazy">
              <div class="mini-main">
                <div class="mini-title"><%= it.title %></div>
                <div class="mini-meta">数量 × 単価：<%= it.quantity %> × ¥<%= Number(it.price).toLocaleString() %></div>
                <div class="mini-meta">数量1あたり：<%= it.unit || '点' %></div>
              </div>
              <div class="mini-sub">¥<%= Number(it.price*it.quantity).toLocaleString() %></div>
            </li>
          <% }) %>
        </ul>

        <div class="sum">
          <div class="row"><span>小計</span><strong class="sumSubtotal">¥<%= Number(totals?.subtotal||0).toLocaleString() %></strong></div>
          <div class="row"><span>割引</span><strong class="sumDiscount">-¥<%= Number(totals?.discount||0).toLocaleString() %></strong></div>
          <div class="row"><span>送料</span><strong class="sumShipping">¥<%= Number(totals?.shipping||0).toLocaleString() %></strong></div>
          <hr>
          <div class="row total"><span>合計</span><strong class="sumTotal">¥<%= Number(totals?.total||0).toLocaleString() %></strong></div>
        </div>

        <button class="btn btn--primary btn--lg" type="submit" id="toConfirm">確認へ進む</button>
        <% if (req.session.flash) { %>
          <p class="error"><%= req.session.flash.message || '' %></p>
        <% } %>
        <p class="muted small">お支払いは安全に処理されます</p>
      </section>
    </aside>
  </form>
</main>

<!-- 住所追加モーダル -->
<%- include('./_address-modal', { csrfToken }) %>

<script>
  window.__CK__ = {
    csrfToken: '<%= csrfToken || '' %>',
    applyCouponUrl: '/checkout/apply-coupon',
    createAddressUrl: '/addresses'
  };
</script>
<script src="/js/checkout.js"></script>
<%- include('../partials/footer') %>