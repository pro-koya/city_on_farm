<%- include('../partials/header', { title: 'ã”æ³¨æ–‡æ‰‹ç¶šã', extraCSS2: '',
  extraCSS: '/styles/checkout.css' }) %>

<main class="checkout">
  <form id="checkoutForm" class="ck-grid" method="POST" action="/checkout">
    <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <% } %>
    <input type="hidden" name="sellerId" value="<%= sellerId %>">

    <!-- å·¦ã‚«ãƒ©ãƒ ï¼šå…¥åŠ›é ˜åŸŸ -->
    <section class="ck-left">

      <section class="card sticky">
        <h2>ã”æ³¨æ–‡å†…å®¹</h2>

        <ul class="mini-cart">
          <% (items || []).forEach(function(it){ %>
            <li class="mini-row">
              <img src="<%= it.image_url || '/images/placeholder.png' %>" alt="" loading="lazy">
              <div class="mini-main">
                <div class="mini-title"><%= it.title %></div>
                <div class="mini-meta">æ•°é‡ Ã— å˜ä¾¡ï¼š<%= it.quantity %> Ã— Â¥<%= Number(it.price).toLocaleString() %></div>
                <div class="mini-meta">æ•°é‡1ã‚ãŸã‚Šï¼š<%= it.unit || 'ç‚¹' %></div>
              </div>
              <div class="mini-sub">Â¥<%= Number(it.price*it.quantity).toLocaleString() %></div>
            </li>
          <% }) %>
        </ul>

        <div class="sum">
          <div class="row"><span>å°è¨ˆ</span><strong class="sumSubtotal">Â¥<%= Number(totals?.subtotal||0).toLocaleString() %></strong></div>
          <div class="row"><span>å‰²å¼•</span><strong class="sumDiscount">-Â¥<%= Number(totals?.discount||0).toLocaleString() %></strong></div>
          <div class="row"><span>é€æ–™</span><strong class="sumShipping">Â¥<%= Number(totals?.shipping||0).toLocaleString() %></strong></div>
          <hr>
          <div class="row total"><span>åˆè¨ˆ</span><strong class="sumTotal">Â¥<%= Number(totals?.total||0).toLocaleString() %></strong></div>
        </div>

      </section>

      <!-- å—ã‘å–ã‚Šæ–¹æ³•ãƒ»æ—¥æ™‚ -->
      <section class="card" id="shipMethodCard">
        <div class="card__head"><h2>å—ã‘å–ã‚Šæ–¹æ³•ãƒ»æ—¥æ™‚</h2></div>
        <div class="field field--row">
          <div>
            <label for="shipMethod">å—ã‘å–ã‚Šæ–¹æ³•</label>
            <select class="pulldown" name="shipMethod" id="shipMethod" required>
              <% (allowedShipMethods || []).forEach(function(m){ %>
                <option value="<%= m.code %>" <%= form.shipMethod === m.code ? 'selected' : '' %>>
                  <%= m.label_ja || m.code %>
                </option>
              <% }) %>
            </select>
          </div>
          <div>
            <label for="ev_date"><%= form.shipMethod === 'pickup' ? 'å—ã‘å–ã‚Šå¸Œæœ›æ—¥ï¼ˆä»»æ„ï¼‰' : 'ãŠå±Šã‘å¸Œæœ›æ—¥ï¼ˆä»»æ„ï¼‰' %></label>
            <input id="ev_date" type="text" name="ev_date" value="<%= form.shipDate || '' %>">
            <input type="hidden" id="shipDate" name="shipDate" value="<%= form.shipDate || '' %>">
          </div>
          <div>
            <label for="shipTime"><%= form.shipMethod === 'pickup' ? 'å—ã‘å–ã‚Šæ™‚é–“å¸¯ï¼ˆä»»æ„ï¼‰' : 'ãŠå±Šã‘æ™‚é–“å¸¯ï¼ˆä»»æ„ï¼‰' %></label>
            <select class="pulldown" id="shipTime" name="shipTime">
              <option value="">æŒ‡å®šãªã—</option>
              <% if (form.shipTime) { %>
                <!-- JSç„¡åŠ¹æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º -->
                <option value="<%= form.shipTime %>" selected>
                  <%= form.shipTime %>
                </option>
              <% } %>
            </select>
          </div>
        </div>
        <p class="help" id="shipHelp">
          <%= form.shipMethod === 'pickup'
              ? 'å—ã‘å–ã‚Šå ´æ‰€ã¯å‡ºå“è€…æŒ‡å®šã®ç•‘ã«ãªã‚Šã¾ã™ã€‚è©³ç´°ã¯ã”æ³¨æ–‡ç¢ºå®šå¾Œã®ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸Šã§ã¯ç¿Œæ—¥ä»¥é™ã®æ—¥ä»˜ã®ã¿æŒ‡å®šã§ãã¾ã™ã€‚å½“æ—¥å—ã‘å–ã‚Šã‚’å¸Œæœ›ã•ã‚Œã‚‹å ´åˆã¯ã€ãŠæ‰‹æ•°ã§ã™ãŒç›´æ¥ãŠé›»è©±ã§ã”ç›¸è«‡ãã ã•ã„ã€‚'
              : 'ã”æŒ‡å®šã®é…é€å…ˆã¸ãŠå±Šã‘ã—ã¾ã™ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸Šã§ã¯ç¿Œæ—¥ä»¥é™ã®æ—¥ä»˜ã®ã¿æŒ‡å®šã§ãã¾ã™ã€‚å½“æ—¥é…é€ã‚’å¸Œæœ›ã•ã‚Œã‚‹å ´åˆã¯ã€ãŠæ‰‹æ•°ã§ã™ãŒç›´æ¥ãŠé›»è©±ã§ã”ç›¸è«‡ãã ã•ã„ã€‚' %>
        </p>
      </section>

      <!-- é…é€å…ˆï¼ˆpickupã§ã¯éè¡¨ç¤ºï¼‰ -->
      <section class="card" id="shippingAddress" aria-hidden="<%= form.shipMethod === 'pickup' ? 'true' : 'false' %>">
        <div class="card__head">
          <h2>é…é€å…ˆä½æ‰€</h2>
          <button class="link" type="button" id="openAddressModal" aria-haspopup="dialog">ï¼‹ æ–°ã—ã„ä½æ‰€ã‚’è¿½åŠ </button>
        </div>
        <p class="error is-hidden" id="shippingError" aria-live="polite"></p>
        <ul id="shippingAddrList" class="addr-list" role="list" aria-hidden="<%= form.shipMethod === 'pickup' ? 'true' : 'false' %>">
          <% addresses.forEach(function(a){ %>
            <li class="addr-item">
              <label class="addr-radio">
                <input type="radio" name="shippingAddressId" value="<%= a.id %>" <%= String(form.shippingAddressId) === String(a.id) ? 'checked' : '' %> >
                <div class="addr-body">
                  <div class="addr-name"><%= a.full_name %>ï¼ˆ<%= a.phone %>ï¼‰</div>
                  <div class="addr-lines">
                    ã€’<%= a.postal_code %>ï¼š<%= a.prefecture %><%= a.city %><%= a.address_line1 %> <%= a.address_line2 || '' %>
                  </div>
                  <% if (a.is_default) { %><span class="badge">æ—¢å®š</span><% } %>
                </div>
              </label>
            </li>
            <% }); %>
        </ul>
      </section>

      <!-- è«‹æ±‚å…ˆï¼ˆpickupã§ã‚‚å¿…è¦ï¼‰ -->
      <section class="card" id="billingAddress">
        <div class="card__head">
          <h2>è«‹æ±‚å…ˆä½æ‰€</h2>
        </div>

        <label class="check" id="billSameCheck" aria-hidden="<%= form.shipMethod === 'pickup' ? 'true' : 'false' %>">
          <input type="checkbox" id="billSame" name="billSame" value="1" <%= (!selectedBillingId) ? 'checked' : '' %> >
          é…é€å…ˆã¨åŒã˜ã«ã™ã‚‹
        </label>

        <button class="link" type="button" id="openBillingAddressModal" aria-haspopup="dialog">ï¼‹ æ–°ã—ã„è«‹æ±‚å…ˆã‚’è¿½åŠ </button>
        <div id="billingBlock" class="<%= (form.shipMethod === 'delivery' && !selectedBillingId) ? 'is-hidden' : '' %>">
          <ul id="billingAddrList" class="addr-list" role="list">
              <% addresses.forEach(function(a){ %>
                <li class="addr-item">
                  <label class="addr-radio">
                    <input type="radio" name="billingAddressId" value="<%= a.id %>" <%= String(form.billingAddressId) === String(a.id) ? 'checked' : '' %> >
                    <div class="addr-body">
                      <div class="addr-name"><%= a.full_name %>ï¼ˆ<%= a.phone %>ï¼‰</div>
                      <div class="addr-lines">
                        ã€’<%= a.postal_code %>ã€€<%= a.prefecture %><%= a.city %><%= a.address_line1 %> <%= a.address_line2 || '' %>
                      </div>
                      <% if (a.is_default) { %><span class="badge">æ—¢å®š</span><% } %>
                    </div>
                  </label>
                </li>
              <% }) %>
            </ul>
        </div>
      </section>

      <!-- ãŠæ”¯æ‰•ã„æ–¹æ³• -->
      <section class="card" id="paymentMethodCard">
        <div class="card__head"><h2>ãŠæ”¯æ‰•ã„æ–¹æ³•</h2></div>

        <% if (!allowedPayments || !allowedPayments.length) { %>
          <p class="muted">åˆ©ç”¨å¯èƒ½ãªæ±ºæ¸ˆæ–¹æ³•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å‡ºå“è€…ã¸ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
        <% } else { %>
          <div class="payment-methods-grid">
            <% allowedPayments.forEach(pm => { %>
              <label class="payment-method-card">
                <input
                  type="radio"
                  name="paymentMethod"
                  value="<%= pm.code %>"
                  <%= form.paymentMethod === pm.code ? 'checked' : '' %>
                  class="payment-method-radio"
                >
                <div class="payment-method-content">
                  <div class="payment-method-header">
                    <span class="payment-method-icon">
                      <% if (pm.code === 'card') { %>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                      <% } else if (pm.code === 'cod') { %>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                      <% } else { %>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"></path><path d="M12 18V6"></path></svg>
                      <% } %>
                    </span>
                    <span class="payment-method-checkmark">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </span>
                  </div>
                  <h3 class="payment-method-title"><%= pm.label_ja || pm.code %></h3>
                  <p class="payment-method-description">
                    <% if (pm.code === 'card') { %>
                      ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆï¼ˆStripeï¼‰ã§ãŠæ”¯æ‰•ã„ã„ãŸã ã‘ã¾ã™
                    <% } else if (pm.code === 'cod') { %>
                      å•†å“åˆ°ç€æ™‚ã«é…é€å“¡ã¸ç¾é‡‘ã§ãŠæ”¯æ‰•ã„ãã ã•ã„
                    <% } else { %>
                      ãŠæ”¯æ‰•ã„æ–¹æ³•ã®è©³ç´°
                    <% } %>
                  </p>
                </div>
              </label>
            <% }) %>
          </div>

          <style>
          .payment-methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
          }

          .payment-method-card {
            position: relative;
            display: block;
            cursor: pointer;
            transition: all 0.2s ease;
          }

          .payment-method-radio {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
          }

          .payment-method-content {
            padding: 1rem;
            border: 2px solid var(--border-color, #e0e0e0);
            border-radius: 12px;
            background: var(--bg-secondary, #fafafa);
            transition: all 0.2s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
          }

          .payment-method-card:hover .payment-method-content {
            border-color: var(--accent-light, #a8d5a8);
            background: var(--bg-primary, #fff);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
          }

          .payment-method-radio:checked + .payment-method-content {
            border-color: var(--accent, #4caf50);
            background: var(--bg-primary, #fff);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
          }

          .payment-method-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
          }

          .payment-method-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-light, #e8f5e9);
            border-radius: 8px;
            color: var(--accent, #4caf50);
          }

          .payment-method-checkmark {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: transparent;
            color: transparent;
            transition: all 0.2s ease;
          }

          .payment-method-radio:checked ~ .payment-method-content .payment-method-checkmark {
            background: var(--accent, #4caf50);
            color: white;
          }

          .payment-method-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary, #333);
          }

          .payment-method-description {
            margin: 0;
            font-size: 0.875rem;
            color: var(--text-secondary, #666);
            line-height: 1.4;
          }

          @media (max-width: 640px) {
            .payment-methods-grid {
              grid-template-columns: 1fr;
            }
          }
          </style>
        <% } %>

        <script>
        function togglePaymentMethodEdit() {
          const viewMode = document.getElementById('paymentMethodView');
          const editMode = document.getElementById('paymentMethodEdit');

          // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
          if (!viewMode || !editMode) return;

          if (viewMode.style.display === 'none') {
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰å‚ç…§ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹å ´åˆã€è¡¨ç¤ºã‚’æ›´æ–°
            updatePaymentMethodView();
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
          } else {
            // å‚ç…§ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
          }
        }

        function updatePaymentMethodView() {
          const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
          if (!selectedRadio) return;

          const paymentCode = selectedRadio.value;
          <% if (allowedPayments && allowedPayments.length) { %>
          const paymentMethods = <%- JSON.stringify(allowedPayments) %>;
          const selectedMethod = paymentMethods.find(pm => pm.code === paymentCode) || paymentMethods[0];

          // ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
          let icon = 'ğŸ’°';
          let note = '';
          if (paymentCode === 'card') {
            icon = 'ğŸ’³';
            note = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆï¼ˆStripeï¼‰ã§ãŠæ”¯æ‰•ã„ã„ãŸã ã‘ã¾ã™ã€‚';
          } else if (paymentCode === 'cod') {
            icon = 'ğŸ’´';
            note = 'å•†å“åˆ°ç€æ™‚ã«é…é€å“¡ã¸ç¾é‡‘ã§ãŠæ”¯æ‰•ã„ãã ã•ã„ã€‚';
          }

          // å‚ç…§ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–°
          const paymentBadge = document.querySelector('#paymentMethodView .payment-badge');
          const paymentNote = document.querySelector('#paymentMethodView .payment-note');

          if (paymentBadge) {
            paymentBadge.innerHTML = `
              <span class="payment-icon">${icon}</span>
              <span class="payment-label">${selectedMethod.label_ja || selectedMethod.code}</span>
            `;
          }

          if (paymentNote) {
            if (note) {
              paymentNote.innerHTML = note;
              paymentNote.style.display = 'block';
            } else {
              paymentNote.style.display = 'none';
            }
          }
          <% } %>
        }
        </script>
      </section>

      <!-- ã‚¯ãƒ¼ãƒãƒ³ãƒ»è¦ç´„ -->
      <section class="card coupon-card" id="coupon_card">
        <div class="card__head"><h2>ã‚¯ãƒ¼ãƒãƒ³ãƒ»ã”è¦æœ›</h2></div>
        <div class="field field--row">
          <div class="coupon">
            <label for="couponCode">ã‚¯ãƒ¼ãƒãƒ³ã‚³ãƒ¼ãƒ‰</label>
            <div class="row">
              <input id="couponCode" type="text" placeholder="ä¾‹ï¼‰SUM10" value="<%= (form?.couponCode || (req.session?.cart?.coupon?.code || '')) %>" <%= (req.session?.cart?.coupon?.code ? 'disabled' : '') %> >
              <button type="button" class="btn btn--ghost" id="applyCoupon" <%= (req.session?.cart?.coupon?.code ? 'disabled' : '') %> >é©ç”¨</button>
              <button type="button" class="btn btn--ghost" id="removeCoupon" <%= (req.session?.cart?.coupon?.code ? '' : 'disabled') %> >è§£é™¤</button>
            </div>
            <p class="help" id="couponMsg">
              <%= (req.session?.cart?.coupon?.code ? `é©ç”¨ä¸­: ${req.session.cart.coupon.code}` : '') %>
            </p>
            </div>
            <p class="help" id="couponMsg"></p>
          </div>
          <div class="note field">
            <label for="orderNote">ã”è¦æœ›ãƒ»å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
            <textarea id="orderNote" name="orderNote" rows="3" placeholder="ä¾‹ï¼‰ä¸åœ¨æ™‚ã¯å®…é…ãƒœãƒƒã‚¯ã‚¹ã¸ ãªã©"><%= form.orderNote %></textarea>
          </div>
        </div>
        <label class="check agree">
          <input type="checkbox" name="agree" value="1" required> åˆ©ç”¨è¦ç´„ã¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¾ã™
        </label>
      </section>

    </section>

    <!-- å³ã‚«ãƒ©ãƒ ï¼šã‚µãƒãƒªãƒ¼ -->
    <aside class="ck-right">
      <section class="card sticky">
        <h2>ã”æ³¨æ–‡å†…å®¹</h2>

        <ul class="mini-cart">
          <% (items || []).forEach(function(it){ %>
            <li class="mini-row">
              <img src="<%= it.image_url || '/images/placeholder.png' %>" alt="" loading="lazy">
              <div class="mini-main">
                <div class="mini-title"><%= it.title %></div>
                <div class="mini-meta">æ•°é‡ Ã— å˜ä¾¡ï¼š<%= it.quantity %> Ã— Â¥<%= Number(it.price).toLocaleString() %></div>
                <div class="mini-meta">æ•°é‡1ã‚ãŸã‚Šï¼š<%= it.unit || 'ç‚¹' %></div>
              </div>
              <div class="mini-sub">Â¥<%= Number(it.price*it.quantity).toLocaleString() %></div>
            </li>
          <% }) %>
        </ul>

        <div class="sum">
          <div class="row"><span>å°è¨ˆ</span><strong class="sumSubtotal">Â¥<%= Number(totals?.subtotal||0).toLocaleString() %></strong></div>
          <div class="row"><span>å‰²å¼•</span><strong class="sumDiscount">-Â¥<%= Number(totals?.discount||0).toLocaleString() %></strong></div>
          <div class="row"><span>é€æ–™</span><strong class="sumShipping">Â¥<%= Number(totals?.shipping||0).toLocaleString() %></strong></div>
          <hr>
          <div class="row total"><span>åˆè¨ˆ</span><strong class="sumTotal">Â¥<%= Number(totals?.total||0).toLocaleString() %></strong></div>
        </div>

        <button class="btn btn--primary btn--lg" type="submit" id="toConfirm">ç¢ºèªã¸é€²ã‚€</button>
        <% if (flash && flash.type === 'error') { %>
          <p class="error"><%= flash.message || '' %></p>
        <% } %>
        <p class="muted small">ãŠæ”¯æ‰•ã„ã¯å®‰å…¨ã«å‡¦ç†ã•ã‚Œã¾ã™</p>
      </section>
    </aside>
  </form>
</main>

<!-- ä½æ‰€è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<%- include('./_address-modal', { csrfToken }) %>

<script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
<script>
  window.__CK__ = {
    csrfToken: '<%= csrfToken || '' %>',
    applyCouponUrl: '/checkout/apply-coupon',
    createAddressUrl: '/addresses',
    shipAvailability: <%- JSON.stringify(shipAvailability || { delivery: [], pickup: [] }) %>,
    shipTimeSlots: <%- JSON.stringify(shipTimeSlots || { delivery: {}, pickup: {} }) %>
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<script src="/js/checkout.js"></script>
<%- include('../partials/footer') %>