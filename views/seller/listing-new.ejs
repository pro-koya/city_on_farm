<%- include('../partials/header', { title: '新規出品', extraCSS2: '',
  extraCSS: '/styles/listing-new.css' }) %>

<main class="listing">
  <form id="listing-form" class="listing__form" method="POST" action="/seller/listing-new">
    <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <% } %>

    <!-- ===== ヘッダー（アクションバー） ===== -->
    <!-- <div class="bar">
      <div class="bar__left">
        <h1>新規出品</h1>
        <span class="hint">* は必須</span>
      </div>
      <div class="bar__right">
        <button class="btn btn--ghost" type="button" id="saveDraft">下書き保存</button>
        <button class="btn" type="submit" id="publishBtn">公開する</button>
      </div>
    </div> -->

    <!-- ===== 2カラム ===== -->
    <div class="grid">
      <!-- 左：主要入力 -->
      <section class="card">
        <div class="field">
          <label for="title">商品名 *</label>
          <input id="title" name="title" type="text" required maxlength="80" placeholder="例）朝採れレタス（無農薬）" value="<%= values?.title || '' %>">
          <p class="error" data-for="title"></p>
        </div>

        <div class="field field--row">
          <div>
            <label for="categoryId">カテゴリ *</label>
            <select id="categoryId" class="pulldown" name="categoryId" required>
              <option value="">選択してください</option>
              <% (categories).forEach(function(cat){ %>
                <option value="<%= cat.id %>" <%= (values?.categoryId===cat.id)?'selected':'' %>><%= cat.name %></option>
              <% }) %>
            </select>
            <p class="error" data-for="categoryId"></p>
          </div>

          <div>
            <label for="tags">タグ（カンマ区切り）</label>
            <input id="tags" name="tags" type="text" placeholder="例）オーガニック, 旬, 地産地消" value="<%= values?.tags || '' %>">
            <p class="help">半角カンマで区切ると複数タグになります</p>
          </div>
        </div>

        <div class="field field--row" id="singlePriceRow">
          <div>
            <label for="price">価格（税抜/円） *</label>
            <input id="price" name="price" type="number" min="1" step="1" required placeholder="例）480" value="<%= values?.price || '' %>">
            <p class="error" data-for="price"></p>
          </div>
          <div>
            <label for="unit">単位 *</label>
            <input id="unit" name="unit" type="text" required placeholder="例）1玉 / 500g / 1箱" value="<%= values?.unit || '' %>">
            <p class="error" data-for="unit"></p>
          </div>
          <div>
            <label for="stock">在庫数 *</label>
            <input id="stock" name="stock" type="number" min="0" step="1" required placeholder="例）50" value="<%= values?.stock || '' %>">
            <p class="error" data-for="stock"></p>
          </div>
        </div>

        <!-- ★ バリエーション設定 -->
        <div class="field">
          <label class="check">
            <input type="checkbox" id="hasVariantsCheck" name="hasVariants" value="1">
            バリエーション（複数規格）を設定する
          </label>
          <p class="help">1個/10個/50個ケースなどロット違いの価格・在庫を個別管理できます</p>
        </div>

        <div id="variantsSection" style="display:none;">
          <div class="field">
            <label>バリエーション一覧</label>
            <div id="variantRows">
              <!-- JSで行を追加 -->
            </div>
            <button type="button" class="btn btn--ghost" id="addVariantRow">バリエーションを追加</button>
          </div>
        </div>

        <div class="field">
          <label for="description">商品説明 *</label>
          <input type="hidden" name="description_html" id="description_html">
          <div class="description-editor-area">
            <p class="hint">リッチテキスト（見出し・画像・表など）で編集できます。</p>
            <button type="button" class="btn btn--ghost" id="openEditorBtn" data-context="product" data-return-url="/seller/listing-new" data-subject-name="新規出品">説明をリッチテキストで編集</button>
          </div>
          <script>
            (function(){ var h = <%- JSON.stringify(values?.description_html || '') %>;
              document.getElementById('description_html').value = h;
            })();
            (function(){
              var btn = document.getElementById('openEditorBtn');
              var htmlEl = document.getElementById('description_html');
              if (!btn || !htmlEl) return;
              btn.addEventListener('click', function(){
                var form = document.createElement('form');
                form.method = 'POST'; form.action = '/editor';
                var csrf = <%- JSON.stringify(typeof csrfToken !== 'undefined' ? csrfToken : '') %>;
                if (csrf) { var i = document.createElement('input'); i.type='hidden'; i.name='_csrf'; i.value=csrf; form.appendChild(i); }
                var hi = document.createElement('input'); hi.type='hidden'; hi.name='html'; hi.value = htmlEl.value || ''; form.appendChild(hi);
                var ci = document.createElement('input'); ci.type='hidden'; ci.name='context'; ci.value = btn.dataset.context || 'product'; form.appendChild(ci);
                var ri = document.createElement('input'); ri.type='hidden'; ri.name='returnUrl'; ri.value = btn.dataset.returnUrl || '/'; form.appendChild(ri);
                var sn = btn.dataset.subjectName || '';
                if (sn) { var si = document.createElement('input'); si.type='hidden'; si.name='subjectName'; si.value = sn; form.appendChild(si); }
                document.body.appendChild(form);
                form.submit();
              });
            })();
          </script>
          <p class="error" data-for="description"></p>
        </div>

        <!-- 仕様・規格（任意で複数行） -->
        <div class="field">
          <label>仕様・規格</label>
          <div class="kv" id="specs">
            <% (values?.specs || [{label:'サイズ', value:'M〜L'}, {label:'等級', value:'優'}]).forEach(function(row, i){ %>
              <div class="kv__row">
                <input type="text" name="specs[<%= i %>][label]" placeholder="項目名（例：サイズ）" value="<%= row.label %>">
                <input type="text" name="specs[<%= i %>][value]" placeholder="値（例：M〜L）" value="<%= row.value %>">
                <button type="button" class="icon-btn kv__del" title="削除">✕</button>
              </div>
            <% }) %>
          </div>
          <button type="button" class="btn btn--ghost" id="addSpec">行を追加</button>
        </div>
      </section>

      <!-- 右：メディア & 出荷情報 & 公開設定 -->
      <aside class="side">

        <!-- 画像アップロード -->
        <section class="card">
          <h2 class="card__title">商品画像 *</h2>
          <p class="help">1枚以上、最大8枚まで。最初の画像がサムネイルになります。</p>

          <!-- 編集と同じ hidden を先頭に -->
          <input type="hidden" id="imageJson" name="imageJson" value="[]">

          <!-- 現在の画像（ここに並ぶ） -->
          <ul class="uploader__list sortable" id="currentImages" aria-live="polite"></ul>

          <!-- 共通のR2ローダDOM（IDを編集と揃える） -->
          <div class="uploader" id="uploader" data-max="8">
            <input id="images" type="file" accept="image/*" multiple hidden>
            <button type="button" class="btn" id="openPicker">画像を追加</button>
            <button type="button" class="btn btn--ghost" id="openLibrary">ライブラリから選ぶ</button>
            <p id="uploaderMsg" class="help"></p>
            <ul class="uploader__list" id="previewList" aria-live="polite" hidden></ul>
          </div>

          <!-- サーバー互換用（編集と同じ名前でOK） -->
          <textarea id="imageUrls" name="imageUrls" hidden></textarea>

          <p class="error" data-for="images"></p>
        </section>

        <!-- 出荷/配送 -->
        <section class="card">
          <h2 class="card__title">出荷・配送</h2>
          <div class="field">
            <label for="shipMethod">配送方法 *</label>
            <select id="shipMethod" class="pulldown" name="shipMethod" required>
              <option value="">選択してください</option>
              <option value="normal" <%= values?.shipMethod==='normal'?'selected':'' %>>常温便</option>
              <option value="cool"   <%= values?.shipMethod==='cool'?'selected':'' %>>クール便</option>
            </select>
            <p class="error" data-for="shipMethod"></p>
          </div>
          <div class="field">
            <label for="shipDays">発送目安 *</label>
            <select id="shipDays" class="pulldown" name="shipDays" required>
              <option value="">選択してください</option>
              <option value="1-2" <%= values?.shipDays==='1-2'?'selected':'' %>>1〜2日</option>
              <option value="2-3" <%= values?.shipDays==='2-3'?'selected':'' %>>2〜3日</option>
              <option value="4-7" <%= values?.shipDays==='4-7'?'selected':'' %>>4〜7日</option>
            </select>
            <p class="error" data-for="shipDays"></p>
          </div>
          <div class="field">
            <label class="check"><input type="checkbox" name="isOrganic" value="1" <%= values?.isOrganic?'checked':'' %>> 有機/JAS</label>
            <label class="check"><input type="checkbox" name="isSeasonal" value="1" <%= values?.isSeasonal?'checked':'' %>> 旬</label>
          </div>
        </section>

        <!-- 公開設定 -->
        <section class="card">
          <h2 class="card__title">公開設定</h2>
          <div class="field">
            <label for="status">ステータス *</label>
            <select id="status" class="pulldown" name="status" required>
              <option value="draft"   <%= values?.status==='draft'?'selected':'' %>>下書き</option>
              <option value="private" <%= values?.status==='private'?'selected':'' %>>限定公開</option>
              <option value="public"  <%= (!values || values?.status==='public')?'selected':'' %>>公開</option>
            </select>
            <p class="error" data-for="status"></p>
          </div>
          <div class="actions">
            <!-- <button class="btn btn--ghost" type="button" id="sideSaveDraft">下書き保存</button> -->
            <button class="btn" type="submit">公開する</button>
          </div>
        </section>

      </aside>
    </div>
  </form>
</main>

<script src="/js/uploader-r2.js"></script>
<script src="/js/listing-variants.js"></script>
<script src="/js/listing-new.js"></script>
<%- include('../partials/footer') %>