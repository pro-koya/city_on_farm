<%- include('../../partials/header', { title, extraCSS: '/styles/trade-detail.css' }) %>

<%
  const orderNo     = order.orderNo;
  const createdAt   = order.created_at;
  const eta         = order.eta;
  const shipMethod  = order.ship_method;             // 'delivery' | 'pickup' など
  const isPickup    = shipMethod === 'pickup';
  const shipLabel   = order.ship_method_ja || (isPickup ? '畑で受け取り' : (shipMethod ? '配送' : '—'));
%>

<main class="td">
  <header class="td__head">
    <div>
      <h1 class="td__title">取引 #<%= orderNo %></h1>
      <div class="td__meta">
        <span>作成: <%= createdAt %></span>
        <% if (eta) { %>
          <span>
            <%= isPickup ? '受け取りの目安: ' : 'お届け予定日: ' %><%= eta %>
          </span>
        <% } %>
      </div>
    </div>

    <div class="td__head-right">
      <span class="status-badge status--<%= order.status_ja %>">
        <%= order.status_ja %>
      </span>
      <div class="td__head-summary">
        <span class="pill pill--soft"><%= shipLabel %></span>
        <span class="pill pill--outline"><%= order.payment_status_ja %></span>
      </div>
    </div>
  </header>

  <section class="td__grid">
    <!-- 左：注文情報 -->
    <article class="td-card">
      <h2 class="td-card__title">注文情報</h2>
      <div class="kv">
        <div class="kv__row">
          <div class="kv__key">支払い方法</div>
          <div class="kv__val"><%= order.payment_method_ja %></div>
        </div>
        <div class="kv__row">
          <div class="kv__key">支払い状況</div>
          <div class="kv__val"><%= order.payment_status_ja %></div>
        </div>
        <div class="kv__row">
          <div class="kv__key"><%= isPickup ? '受け取り方法' : '配送方法' %></div>
          <div class="kv__val"><%= shipLabel %></div>
        </div>
        <div class="kv__row">
          <div class="kv__key"><%= isPickup ? '受け取りステータス' : '配送ステータス' %></div>
          <div class="kv__val"><%= order.shipment_status_ja %></div>
        </div>
        <% if (order.ship_tracking_no) { %>
          <div class="kv__row">
            <div class="kv__key">追跡番号</div>
            <div class="kv__val mono"><%= order.ship_tracking_no %></div>
          </div>
        <% } %>
      </div>
    </article>

    <!-- 右：お届け先 / 受け取り先 -->
    <aside class="td-card">
      <h2 class="td-card__title">
        <%= isPickup ? '受け取り先（連絡先）' : 'お届け先' %>
      </h2>

      <% if (isPickup) { %>
        <p class="addr__hint">
          畑での受け取りが選択されています。受け取り場所の詳細は、出品者と購入者間のやり取りで確定してください。
        </p>
      <% } %>

      <% if (order.shipping) { %>
        <div class="addr">
          <div class="addr__name">店舗名：<%= order.partner?.name || '—' %></div>
          <div class="addr__name"><%= isPickup ? 'ご担当者：' : '氏名：' %><%= order.shipping.full_name %></div>

          <% if (order.shipping.postal_code) { %>
            <div class="addr__row">
              〒<%= order.shipping.postal_code.substring(0,3) %>-<%= order.shipping.postal_code.slice(-4) %>
            </div>
          <% } %>

          <div class="addr__row">
            <%= order.shipping.prefecture %><%= order.shipping.city %><%= order.shipping.address_line1 %>
            <%= order.shipping.address_line2 || '' %>
          </div>

          <% if (order.shipping.phone) { %>
            <div class="addr__muted">TEL：<%= order.shipping.phone %></div>
          <% } %>
        </div>
      <% } else { %>
        <p class="addr__hint">配送 / 連絡先情報が登録されていません。</p>
      <% } %>
    </aside>
  </section>

  <!-- 商品明細 -->
  <section class="td-items">
    <table>
      <thead>
        <tr>
          <th>商品</th>
          <th>数量 / 単価</th>
          <th>小計</th>
        </tr>
      </thead>
      <tbody>
        <% order.items.forEach(it => { %>
          <tr>
            <td>
              <div class="td-item__prod">
                <img class="td-item__img" src="<%= it.image_url %>" alt="">
                <div>
                  <p class="td-item__title"><%= it.title %></p>
                  <div class="td-item__meta">
                    出品者：<%= it.producer %> ／ 単位：<%= it.unit %>
                  </div>
                </div>
              </div>
            </td>
            <td class="price">
              数量：<%= it.quantity %><%= it.unit %><br>
              単価：¥<%= it.price.toLocaleString() %>
            </td>
            <td class="price">
              小計：¥<%= (it.price * it.quantity).toLocaleString() %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </section>

  <!-- 金額サマリ -->
  <section class="td-summary">
    <div class="td-summary__row">
      <div class="td-summary__key">小計：</div>
      <div class="td-summary__val price">¥<%= order.subtotal.toLocaleString() %></div>
    </div>

    <% if (order.discount && order.discount > 0) { %>
      <div class="td-summary__row">
        <div class="td-summary__key">割引：</div>
        <div class="td-summary__val price">-¥<%= order.discount.toLocaleString() %></div>
      </div>
    <% } %>

    <div class="td-summary__row">
      <div class="td-summary__key"><%= isPickup ? 'サービス料（送料相当）：' : '送料：' %></div>
      <div class="td-summary__val price">¥<%= order.shipping_fee.toLocaleString() %></div>
    </div>

    <div class="td-summary__row td-summary__total">
      <div class="td-summary__key">合計：</div>
      <div class="td-summary__val price">¥<%= order.total.toLocaleString() %></div>
    </div>
  </section>

  <!-- ステータス更新 -->
  <section class="td-card td-action">
    <h2 class="td-card__title">ステータス更新</h2>

    <form id="statusForm" class="td-status-form">
      <input type="hidden" name="_csrf" value="<%= csrfToken || '' %>">

      <div class="td-status-grid">
        <label class="td-status-field">
          <span class="td-status-label">注文ステータス</span>
          <select class="pulldown" name="order_status" id="orderStatus">
            <option value="pending"   <%= order.status === 'pending'   ? 'selected' : '' %>>受付中</option>
            <option value="confirmed" <%= order.status === 'confirmed' ? 'selected' : '' %>>確定</option>
            <option value="paid"      <%= order.status === 'paid'      ? 'selected' : '' %>>支払い済み</option>
            <option value="fulfilled" <%= order.status === 'fulfilled' ? 'selected' : '' %>>出荷完了</option>
            <option value="canceled"  <%= order.status === 'canceled'  ? 'selected' : '' %>>キャンセル</option>
            <option value="refunded"  <%= order.status === 'refunded'  ? 'selected' : '' %>>返金済み</option>
          </select>
        </label>

        <label class="td-status-field">
          <span class="td-status-label">支払いステータス</span>
          <select class="pulldown" name="payment_status" id="paymentStatus">
            <option value="unpaid"   <%= order.payment_status === 'unpaid'   ? 'selected' : '' %>>未入金</option>
            <option value="paid"     <%= order.payment_status === 'paid'     ? 'selected' : '' %>>入金完了</option>
            <option value="canceled" <%= order.payment_status === 'canceled' ? 'selected' : '' %>>キャンセル</option>
            <option value="refunded" <%= order.payment_status === 'refunded' ? 'selected' : '' %>>返金済み</option>
          </select>
        </label>

        <label class="td-status-field">
          <span class="td-status-label"><%= isPickup ? '受け取りステータス' : '配送ステータス' %></span>
          <select class="pulldown" name="shipment_status" id="shipmentStatus">
            <% if (isPickup) { %>
              <option value="preparing"  <%= order.shipment_status === 'preparing'  ? 'selected' : '' %>>受け取り準備中</option>
              <option value="in_transit" <%= order.shipment_status === 'in_transit' ? 'selected' : '' %>>準備完了（連絡済み）</option>
              <option value="delivered"  <%= order.shipment_status === 'delivered'  ? 'selected' : '' %>>受け渡し完了</option>
              <option value="returned"   <%= order.shipment_status === 'returned'   ? 'selected' : '' %>>キャンセル / 返品</option>
            <% } else { %>
              <option value="preparing"  <%= order.shipment_status === 'preparing'  ? 'selected' : '' %>>出荷準備中</option>
              <option value="in_transit" <%= order.shipment_status === 'in_transit' ? 'selected' : '' %>>お届け中</option>
              <option value="delivered"  <%= order.shipment_status === 'delivered'  ? 'selected' : '' %>>配達完了</option>
              <option value="returned"   <%= order.shipment_status === 'returned'   ? 'selected' : '' %>>返品</option>
            <% } %>
          </select>
        </label>
      </div>

      <div class="td-actions">
        <button class="btn" type="submit" id="statusSubmit">更新する</button>
        <button class="btn btn--ghost" type="button" id="revertStatus">元に戻す</button>
      </div>
    </form>

    <p class="td-status-hint" id="statusMsg" aria-live="polite"></p>
  </section>
</main>

<script>
  (function(){
    const form   = document.getElementById('statusForm');
    const msg    = document.getElementById('statusMsg');
    const csrf   = form?.querySelector('input[name="_csrf"]')?.value || '';
    const submit = document.getElementById('statusSubmit');
    const revert = document.getElementById('revertStatus');

    const initial = {
      order: '<%= order.status %>',
      pay:   '<%= order.payment_status %>',
      ship:  '<%= order.shipment_status %>'
    };

    function setMsg(t, ok = true){
      if (!msg) return;
      msg.textContent = t || '';
      msg.style.color = ok ? '#14532d' : '#7f1d1d';
    }

    // 元に戻す
    revert?.addEventListener('click', () => {
      const os = document.getElementById('orderStatus');
      const ps = document.getElementById('paymentStatus');
      const ss = document.getElementById('shipmentStatus');
      if (os) os.value = initial.order || 'pending';
      if (ps) ps.value = initial.pay   || 'unpaid';
      if (ss) ss.value = initial.ship  || 'preparing';
      setMsg('選択内容を元に戻しました。', true);
    });

    // 更新
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMsg('更新中…');
      submit?.setAttribute('disabled', 'disabled');

      const payload = {
        order_status:   document.getElementById('orderStatus')?.value,
        payment_status: document.getElementById('paymentStatus')?.value,
        shipment_status:document.getElementById('shipmentStatus')?.value
      };

      try {
        // /seller/trades/:id → /seller/trades/:id/status を想定
        const url = location.pathname.replace(/\/?$/, '') + '/status';
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'CSRF-Token': csrf
          },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || ('HTTP ' + res.status));
        }
        const data = await res.json(); // { ok:true, order:{...} などを想定 }
        if (!data?.ok) throw new Error(data?.message || '更新に失敗しました');

        const updated = data.order || payload;

        // 初期値を更新しておく（次回「元に戻す」用）
        initial.order = updated.order_status   || initial.order;
        initial.pay   = updated.payment_status || initial.pay;
        initial.ship  = updated.shipment_status|| initial.ship;

        setMsg('ステータスを更新しました。', true);
      } catch (err) {
        console.error(err);
        setMsg('更新に失敗しました。時間をおいて再度お試しください。', false);
      } finally {
        submit?.removeAttribute('disabled');
      }
    });
  })();
</script>

<%- include('../../partials/footer') %>