<%- include('../partials/header', { title: '売上ダッシュボード詳細', extraCSS: '/styles/analytics.css' }) %>

<main class="listing" style="max-width:1100px;margin:80px auto 40px;padding:0 16px">
  <header>
    <h1 style="margin:0 0 .5rem 0;font-size:1.2rem">売上ダッシュボード詳細</h1>

    <form class="ana-bar" method="get" action="/seller/analytics" id="anaForm">
        <div class="search">
            <input type="search" name="q" value="<%= q || '' %>" placeholder="商品名・出品者などで検索">
        </div>

        <div class="filters">
            <!-- 粒度 -->
            <select class="select" name="granularity" id="gSel">
                <option value="day"   <%= granularity==='day'   ? 'selected':'' %>>日</option>
                <option value="week"  <%= granularity==='week'  ? 'selected':'' %>>週</option>
                <option value="month" <%= granularity==='month' ? 'selected':'' %>>月</option>
                <option value="year"  <%= granularity==='year'  ? 'selected':'' %>>年</option>
            </select>
            <!-- 粒度別入力（JSでトグル） -->
            <div class="g-input g-day">
                <input id="dateRange" class="select" placeholder="🗓️" value="🗓️">
                <input type="hidden" class="select" id="dateFrom" name="dateFrom">
                <input type="hidden" class="select" id="dateTo"   name="dateTo">
            </div>
            <div class="g-input g-week">
                <input id="weekPick" class="select" name="week" placeholder="週（例: 2025-W39）">
            </div>
            <div class="g-input g-month">
                <input id="monthPick" class="select" name="ym" placeholder="年月（例: 2025-10）">
            </div>
            <div class="g-input g-year">
                <input id="yearPick" class="select" name="year" placeholder="年（例: 2025）">
            </div>
        </div>

        <div class="filters">
            <!-- 既存のカテゴリ/支払い -->
            <select class="select pulldown" name="category">
                <option value="">すべてのカテゴリ</option>
                <% (categories || []).forEach(c => { %>
                    <option value="<%= c.id %>" <%= String(category||'')===String(c.id)?'selected':'' %>><%= c.name %></option>
                <% }) %>
            </select>
            <select class="select pulldown" name="payment">
                <option value="">すべての支払い方法</option>
                <% (paymentMethods || []).forEach(pm => { %>
                    <option value="<%= pm.value %>" <%= (payment||'')===pm.value?'selected':'' %>><%= pm.label_ja %></option>
                <% }) %>
            </select>
        </div>

        <div style="justify-self:end;display:flex;gap:.4rem;flex-wrap:wrap">
            <button class="btn" type="submit">適用</button>
            <a class="btn btn-danger" href="/seller/analytics">リセット</a>
        </div>
    </form>
  </header>

  <section class="ana-card">
    <div class="ana-head">
      <div>
        <span class="badge">売上: ¥<%= (summary?.revenue||0).toLocaleString() %></span>
        <span class="badge">注文数: <%= (summary?.orders ||0).toLocaleString() %></span>
      </div>
    </div>

    <script>
      window.__ANALYTICS__ = {
        granularity: "<%= granularity %>",
        buckets: <%- JSON.stringify(analyticsData || []) %>,
        summary: <%- JSON.stringify(summary || {revenue:0,orders:0}) %>
      };
      // 粒度別の入力切替
      (function(){
        const g = "<%= granularity %>";
        const root = document.getElementById('anaForm');
        function show(cls){
          root.querySelectorAll('.g-input').forEach(el => el.style.display='none');
          const t = root.querySelector('.g-' + cls);
          if (t) t.style.display = 'flex';
        }
        show(g);
        const sel = document.getElementById('gSel');
        sel?.addEventListener('change', (e)=> show(e.target.value));
      })();
    </script>

    <section class="card">
      <h2>売上チャート</h2>
      <div class="chart-wrap">
        <canvas id="analyticsCombo" aria-label="売上/件数チャート"></canvas>
      </div>
    </section>

    <table class="ana-table">
      <thead><tr><th>区分</th><th>売上</th><th>注文数</th></tr></thead>
      <tbody>
        <% (analyticsData || []).forEach(b => { %>
          <tr>
            <td data-label="区分"><%= b.label %></td>
            <td data-label="売上">¥<%= (b.revenue||0).toLocaleString() %></td>
            <td data-label="注文数"><%= (b.orders||0).toLocaleString() %></td>
          </tr>
        <% }) %>
        <% if (!(analyticsData || []).length) { %>
          <tr><td colspan="3" style="text-align:center;color:#6b7280">該当データがありません。</td></tr>
        <% } %>
      </tbody>
    </table>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script src="/js/analytics-charts.js"></script>
<%- include('../partials/footer') %>