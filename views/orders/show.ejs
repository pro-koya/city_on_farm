<%- include('../partials/header', { title: `注文詳細 - ${order.orderNumber || order.orderNo || order.id}`, extraCSS2: '',
  extraCSS: '/styles/order-show.css' }) %>

<%
  const orderNo   = order.orderNumber || order.orderNo || order.id;
  const createdAt = order.createdAt   || order.created_at;
  const etaAt     = order.etaAt       || order.eta_at;
  const shipMethod = order.ship_method || order.shipMethod || null;
  const isPickup  = shipMethod === 'pickup';
  const shipMethodLabel =
    order.ship_method_ja ||
    order.shipMethodJa   ||
    (isPickup ? '畑で受け取り' : shipMethod ? '配送' : '—');
%>

<main class="order-show">
  <!-- ヘッダー -->
  <header class="order-head">
    <h1>注文詳細</h1>
    <span class="order-head__number"><%= orderNo %></span>
  </header>

  <!-- 進捗バー -->
  <div class="order-progress">
    <ul class="progress">
      <% if (isPickup) { %>
        <li class="<%= order.statusRank >= 0 ? (order.statusRank > 0 ? 'is-done' : 'is-active') : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">注文受付</span>
        </li>
        <li class="<%= order.statusRank >= 1 ? (order.statusRank > 1 ? 'is-done' : 'is-active') : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">収穫・準備中</span>
        </li>
        <li class="<%= order.statusRank >= 2 ? (order.statusRank > 2 ? 'is-done' : 'is-active') : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">受け取り待ち</span>
        </li>
        <li class="<%= order.statusRank >= 3 ? 'is-done' : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">受け取り完了</span>
        </li>
      <% } else { %>
        <li class="<%= order.statusRank >= 0 ? (order.statusRank > 0 ? 'is-done' : 'is-active') : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">注文受付</span>
        </li>
        <li class="<%= order.statusRank >= 1 ? (order.statusRank > 1 ? 'is-done' : 'is-active') : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">出荷準備中</span>
        </li>
        <li class="<%= order.statusRank >= 2 ? (order.statusRank > 2 ? 'is-done' : 'is-active') : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">配送中</span>
        </li>
        <li class="<%= order.statusRank >= 3 ? 'is-done' : '' %>">
          <span class="progress__dot"></span>
          <span class="progress__label">お届け完了</span>
        </li>
      <% } %>
    </ul>
  </div>

  <!-- 支払い方法に応じた注意喚起 -->
  <% if (order.paymentMethod === '銀行振込') { %>
    <% if (order.paymentStatus === '未入金') { %>
      <p class="alert alert--danger">
        お支払い方法：銀行振込（未入金）<br>
        ご入金の確認後に、<%= isPickup ? '受け取りのご案内をお送りします。' : '商品を発送いたします。' %>
      </p>
    <% } else { %>
      <p class="alert alert--safe">
        ご入金を確認しました。<%= isPickup ? '受け取り準備ができ次第ご連絡いたします。' : '商品が準備でき次第発送いたします。' %>
      </p>
    <% } %>
  <% } %>

  <% if (order.paymentMethod === '代金引換') { %>
    <p class="alert alert--notice">
      お支払い方法：代金引換 — お支払いは現金のみです。カードやバーコード決済はご利用いただけません。
    </p>
  <% } %>

  <% if (order.payment_method === 'invoice' || order.paymentMethod === '掛売（請求書払い）') { %>
    <p class="alert alert--notice">
      お支払い方法：掛売（請求書払い） — 月末締めで請求書をお送りいたします。翌月末までにお振込をお願いいたします。
    </p>
  <% } %>

  <!-- 概要 2カラム -->
  <div class="order-grid">
    <!-- 注文概要 -->
    <section class="card">
      <div class="card__head"><h2>注文概要</h2></div>
      <div class="order-summary">
        <div class="order-summary__row">
          <span class="order-summary__label">ステータス</span>
          <span class="order-summary__value">
            <span class="status status--<%= order.status %>"><%= order.status_ja || order.status %></span>
          </span>
        </div>
        <div class="order-summary__row">
          <span class="order-summary__label">注文日時</span>
          <span class="order-summary__value"><%= createdAt ? new Date(createdAt).toLocaleString('ja-JP') : '—' %></span>
        </div>
        <div class="order-summary__row">
          <span class="order-summary__label">受け取り方法</span>
          <span class="order-summary__value">
            <span class="pill pill--<%= isPickup ? 'green' : 'blue' %>"><%= shipMethodLabel %></span>
          </span>
        </div>
        <% if (etaAt) { %>
          <div class="order-summary__row">
            <span class="order-summary__label"><%= isPickup ? '受け取り目安' : 'お届け予定' %></span>
            <span class="order-summary__value">
              <%= new Date(etaAt).toLocaleDateString('ja-JP') %><%= order.ship_time_ja ? ` ${order.ship_time_ja}` : '' %>
            </span>
          </div>
        <% } %>
      </div>
    </section>

    <!-- 支払い情報 -->
    <section class="card">
      <div class="card__head"><h2>支払い情報</h2></div>
      <dl class="payinfo">
        <div class="row">
          <dt>支払い方法</dt>
          <dd><%= order.paymentMethod || '—' %></dd>
        </div>
        <div class="row">
          <dt>支払い状態</dt>
          <dd><%= order.paymentStatus || '—' %></dd>
        </div>
      </dl>
      <div class="side-actions">
        <button class="btn btn--ghost" id="showInvoiceBtn" type="button">領収書を表示</button>
        <button class="btn btn--ghost" id="showDeliveryNoteBtn" type="button">納品書を表示</button>
      </div>
    </section>
  </div>

  <!-- 商品一覧 -->
  <section class="card">
    <div class="card__head">
      <h2>注文商品（<%= items ? items.length : 0 %>点）</h2>
      <% if (order.note) { %>
        <span class="badge">メモ</span>
      <% } %>
    </div>

    <% if (order.note) { %>
      <p class="note" style="margin: 0 0 0.75rem; padding: 0.5rem 0.75rem; background: #f8faf9; border-radius: 8px; font-size: 0.85rem;">
        <%= order.note %>
      </p>
    <% } %>

    <% if (!items || !items.length) { %>
      <p class="muted">商品情報が見つかりません。</p>
    <% } else { %>
      <ul class="items">
        <% items.forEach(function(it){ %>
          <li class="item">
            <a class="item__thumb" href="/products/<%= it.slug || it.id %>">
              <img src="<%= it.image_url || '/images/placeholder.png' %>" alt="<%= it.title %>" loading="lazy">
            </a>
            <div class="item__main">
              <a class="item__title" href="/products/<%= it.slug || it.id %>"><%= it.title %><% if (it.variant_label) { %> (<%= it.variant_label %>)<% } %></a>
              <div class="item__meta">
                <span><%= it.quantity %><%= it.unit || '点' %></span>
                <span class="dot">·</span>
                <span>¥<%= Number(it.unit_price || it.price).toLocaleString() %> / 単価</span>
                <% if (it.seller_name) { %>
                  <span class="dot">·</span>
                  <span><%= it.seller_name %></span>
                <% } %>
              </div>
            </div>
            <div class="item__amount">¥<%= Number((it.unit_price||it.price) * it.quantity).toLocaleString() %></div>
          </li>
        <% }) %>
      </ul>
    <% } %>

    <dl class="totals">
      <div class="row">
        <dt>小計</dt>
        <dd>¥<%= Number(totals.subtotal||0).toLocaleString() %></dd>
      </div>
      <% if (totals.discount) { %>
        <div class="row">
          <dt>割引</dt>
          <dd>-¥<%= Number(totals.discount||0).toLocaleString() %></dd>
        </div>
      <% } %>
      <div class="row">
        <dt><%= isPickup ? 'サービス料' : '送料' %></dt>
        <dd>¥<%= Number(totals.shipping||0).toLocaleString() %></dd>
      </div>
      <% if (totals.tax) { %>
        <div class="row">
          <dt>税</dt>
          <dd>¥<%= Number(totals.tax||0).toLocaleString() %></dd>
        </div>
      <% } %>
      <div class="row grand">
        <dt>合計</dt>
        <dd>¥<%= Number(totals.total||0).toLocaleString() %></dd>
      </div>
    </dl>
  </section>

  <!-- 配送先・受取先 & 配送状況 2カラム -->
  <div class="order-grid">
    <!-- お届け先 / 受け取り先 -->
    <section class="card">
      <div class="card__head">
        <h2><%= isPickup ? '受け取り先' : '配送先' %></h2>
      </div>

      <% if (isPickup) { %>
        <% if (typeof pickupAddress !== 'undefined' && pickupAddress) { %>
          <div class="addr">
            <div class="addr__name"><%= typeof partnerName !== 'undefined' && partnerName ? partnerName : (pickupAddress.full_name || '受け取り場所') %></div>
            <div class="addr__lines">
              〒<%= pickupAddress.postal_code %>
              <%= pickupAddress.prefecture %><%= pickupAddress.city %><%= pickupAddress.address_line1 || pickupAddress.address1 || '' %> <%= pickupAddress.address_line2 || pickupAddress.address2 || '' %>
            </div>
            <% if (pickupAddress.phone) { %>
              <div class="addr__phone">TEL: <%= pickupAddress.phone %></div>
            <% } %>
          </div>
        <% } else { %>
          <p class="muted">受け取り場所の詳細は確定メールをご確認ください。</p>
        <% } %>
      <% } else { %>
        <% if (shippingAddress) { %>
          <div class="addr">
            <div class="addr__name"><%= shippingAddress.full_name %><% if (shippingAddress.phone) { %>（<%= shippingAddress.phone %>）<% } %></div>
            <div class="addr__lines">
              〒<%= shippingAddress.postal_code %>
              <%= shippingAddress.prefecture %><%= shippingAddress.city %><%= shippingAddress.address_line1 %> <%= shippingAddress.address_line2 || '' %>
            </div>
          </div>
        <% } else { %>
          <p class="muted">配送先が登録されていません。</p>
        <% } %>

        <% if (billingAddress) { %>
          <div style="margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid #f1f5f9;">
            <div class="card__head" style="margin-bottom: 0.5rem;"><h2 style="font-size: 0.92rem;">請求先</h2></div>
            <div class="addr">
              <div class="addr__name"><%= billingAddress.full_name %><% if (billingAddress.phone) { %>（<%= billingAddress.phone %>）<% } %></div>
              <div class="addr__lines">
                〒<%= billingAddress.postal_code %>
                <%= billingAddress.prefecture %><%= billingAddress.city %><%= billingAddress.address_line1 %> <%= billingAddress.address_line2 || '' %>
              </div>
            </div>
          </div>
        <% } %>
      <% } %>
    </section>

    <!-- 配送状況 / 受け取り状況 -->
    <section class="card">
      <div class="card__head">
        <h2><%= isPickup ? '受け取り状況' : '配送状況' %></h2>
      </div>

      <div class="shipment-summary">
        <div class="shipment-summary__row">
          <span class="label"><%= isPickup ? '受け取り方法' : '配送方法' %></span>
          <span class="value">
            <span class="pill pill--<%= isPickup ? 'green' : 'blue' %>"><%= shipMethodLabel %></span>
          </span>
        </div>

        <% if (etaAt || order.ship_time_ja) { %>
          <div class="shipment-summary__row">
            <span class="label"><%= isPickup ? '受け取り目安' : 'お届け予定' %></span>
            <span class="value">
              <%= etaAt ? new Date(etaAt).toLocaleDateString('ja-JP') : '' %>
              <%= order.ship_time_ja ? ` ${order.ship_time_ja}` : '' %>
            </span>
          </div>
        <% } %>

        <% if (order.deliveryStatus) { %>
          <div class="shipment-summary__row">
            <span class="label">現在の状況</span>
            <span class="value">
              <% if (isPickup) { %>
                <%= order.deliveryStatus === 'delivered' ? '受取完了' : '未受取' %>
              <% } else { %>
                <%= order.deliveryStatus %>
              <% } %>
            </span>
          </div>
        <% } %>
      </div>

      <% if (!order.deliveryStatus) { %>
        <p class="shipment-note">
          <%= isPickup
            ? '畑での受け取り準備が整い次第、詳細をご連絡いたします。'
            : '出荷準備が整い次第、配送情報をご連絡いたします。'
          %>
        </p>
      <% } %>
    </section>
  </div>

  <!-- アクション -->
  <section class="card">
    <div class="card__head"><h2>操作</h2></div>
    <div class="order-actions">
      <% if (order.status !== 'canceled' && order.status !== 'cancelled') { %>
        <form method="POST" action="/orders/<%= orderNo %>/reorder" class="inline">
          <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <% } %>
          <button type="submit" class="btn btn--primary">この注文をもう一度</button>
        </form>
      <% } %>
      <form method="POST" action="/my/templates" class="inline">
        <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <% } %>
        <input type="hidden" name="source" value="order">
        <input type="hidden" name="sourceId" value="<%= order.id %>">
        <input type="hidden" name="sellerId" value="<%= order.seller_id || '' %>">
        <button type="submit" class="btn">テンプレートとして保存</button>
      </form>
      <button class="btn btn--ghost" id="printPage" type="button">このページを印刷</button>
      <a class="btn btn--ghost" href="/orders/recent">注文一覧へ</a>
    </div>
  </section>

  <!-- サポート -->
  <section class="card">
    <div class="card__head"><h2>サポート</h2></div>
    <p class="muted" style="margin: 0 0 0.5rem;">
      ご不明な点があれば、注文番号を添えてお気軽にお問い合わせください。
    </p>
    <a class="btn" href="/contact?type=order&ref=<%= orderNo %>">問い合わせる</a>
  </section>
</main>

<!-- 領収書宛名入力モーダル -->
<div id="receiptNameModal" class="modal" style="display: none;">
  <div class="modal__overlay"></div>
  <div class="modal__content">
    <div class="modal__header">
      <h2>領収書の宛名を入力</h2>
      <button class="modal__close" type="button" aria-label="閉じる">&times;</button>
    </div>
    <div class="modal__body">
      <form id="receiptNameForm">
        <div class="field">
          <label for="receipt_name_input">宛名</label>
          <input
            type="text"
            id="receipt_name_input"
            name="receipt_name"
            value="<%= order.receiptName || (typeof defaultReceiptName !== 'undefined' && defaultReceiptName ? defaultReceiptName : '') %>"
            maxlength="40"
            required
            placeholder="例：山田太郎"
          />
          <p class="field-hint">1〜40文字で入力してください</p>
          <div id="receiptNameError" class="field-error" style="display: none;"></div>
        </div>
        <div class="modal__actions">
          <button type="button" class="btn btn--ghost" id="cancelReceiptNameBtn">キャンセル</button>
          <button type="submit" class="btn btn--primary">確定して領収書を表示</button>
        </div>
      </form>
    </div>
  </div>
</div>

<% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
  <meta name="csrf-token" content="<%= csrfToken %>">
<% } %>
<script src="/js/order-show.js"></script>
<%- include('../partials/footer') %>
