<%- include('../../partials/header', {
  title,
  extraCSS2: '',
  extraCSS: '/styles/partner-show.css'
}) %>

<main class="ps">
  <header class="ps__head">
    <div class="ps__title-wrap">
      <h1 class="ps__title"><%= partner.name %></h1>
      <span class="ps__badge ps__badge--<%= partner.status %>" id="statusBadge">
        <%= partner.status === 'active' ? '有効' : '無効' %>
      </span>
    </div>
    <div class="ps__meta">
      <span>作成: <%= new Date(partner.created_at).toLocaleString('ja-JP') %></span>
      <span>更新: <%= new Date(partner.updated_at).toLocaleString('ja-JP') %></span>
    </div>

    <% if (user.roles.includes('admin')) { %>
    <div class="ps__actions">
      <!-- <form id="statusForm" action="/admin/partners/<%= partner.id %>/status" method="POST" class="inline">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <input type="hidden" name="status" id="statusInput" value="<%= partner.status === 'active' ? 'inactive':'active' %>">
        <button type="submit" class="btn btn--toggle" id="toggleBtn">
          <%= partner.status === 'active' ? '無効にする' : '有効にする' %>
        </button>
      </form> -->
      <a class="btn btn--ghost" href="/admin/partners">一覧へ戻る</a>
    </div>
    <% } %>

    <% if (user.roles.includes('seller') && isMember) { %>
    <!-- 出品者向け：紹介ページ管理への導線 -->
    <div class="ps__actions ps__actions--seller">
      <a class="btn btn--toggle" href="/seller/profile/edit">
        出品者紹介ページを編集
      </a>
      <a class="btn btn--ghost" href="/sellers/<%= user.id %>" target="_blank" rel="noopener">
        紹介ページを確認
      </a>
    </div>
    <% } %>
  </header>

  <section class="ps__grid">
    <!-- 基本情報 -->
    <article class="card">
      <h2 class="card__title">店舗情報</h2>
      <dl class="kv">
        <div><dt>名称</dt><dd><%= partner.name %></dd></div>
        <% if (partner.kana) { %><div><dt>カナ</dt><dd><%= partner.kana %></dd></div><% } %>
        <div><dt>種別</dt><dd><%= partner.type %></dd></div>
        <div><dt>メール</dt><dd><%= partner.email || '—' %></dd></div>
        <div><dt>電話</dt><dd><%= partner.phone || '—' %></dd></div>
        <div><dt>Web</dt><dd>
          <% if (partner.website) { %>
            <a href="<%= partner.website %>" target="_blank" rel="noopener"><%= partner.website %></a>
          <% } else { %>—<% } %>
        </dd></div>
        <div><dt>税ID</dt><dd><%= partner.tax_id || '—' %></dd></div>
        <div><dt>住所</dt><dd>
          <div class="addr">
            <div>〒 <%= partner.postal_code || '—' %></div>
            <div><%= [partner.prefecture, partner.city, partner.address1, partner.address2].filter(Boolean).join(' ') || '—' %></div>
          </div>
        </dd></div>
        <div class="kv--full"><dt>メモ</dt><dd><%= partner.note || '—' %></dd></div>
      </dl>
    </article>

    <% if (user.roles.includes('seller') || user.roles.includes('admin')) { %>
    <article class="card card--availability">
      <div class="card__head">
        <h2 class="card__title">受け渡し可能日（概要）</h2>
        <a class="btn btn--ghost btn--sm" href="/admin/partners/<%= partner.id %>/availability">
          設定を編集
        </a>
      </div>

      <% if (!availabilitySummary || (!availabilitySummary.weekly_delivery_label && !availabilitySummary.weekly_pickup_label && (!availabilitySummary.preview || !availabilitySummary.preview.length))) { %>
        <p class="muted small">
          まだ受け渡し可能日が設定されていません。「設定を編集」から設定してください。
        </p>
      <% } else { %>
        <div class="pa-summary">
          <div class="pa-summary__row">
            <!-- 左：毎週パターン -->
            <div class="pa-summary__col">
              <h3 class="pa-summary__subtitle">毎週のパターン</h3>
              <dl class="kv kv--stack">
                <div>
                  <dt>配送</dt>
                  <dd><%= availabilitySummary.weekly_delivery_label || '未設定' %></dd>
                </div>
                <div>
                  <dt>畑受け渡し</dt>
                  <dd><%= availabilitySummary.weekly_pickup_label || '未設定' %></dd>
                </div>
              </dl>

              <% if (availabilitySummary.specials_label) { %>
                <p class="muted xsmall">
                  <%= availabilitySummary.specials_label %>
                </p>
              <% } %>
            </div>

            <!-- 右：直近の受け渡し可能日（ミニカレンダー的な一覧） -->
            <div class="pa-summary__col pa-summary__calendar">
              <h3 class="pa-summary__subtitle">直近の受け渡し可能日</h3>

              <% if (availabilitySummary.preview && availabilitySummary.preview.length) { %>
                <ul class="pa-summary__chips" aria-label="直近の受け渡し可能日">
                  <% availabilitySummary.preview.forEach(function(d) { %>
                    <li class="pa-summary__chip">
                      <div class="pa-summary__chip-date">
                        <span class="pa-summary__chip-week"><%= d.weekday + '曜' %></span>
                        <span class="pa-summary__chip-day"><%= d.month + '/' + d.day %></span>
                      </div>
                      <div class="pa-summary__chip-tags">
                        <% if (d.delivery) { %><span class="tag tag--delivery">配送</span><% } %>
                        <% if (d.pickup)  { %><span class="tag tag--pickup">畑</span><% } %>
                      </div>
                    </li>
                  <% }); %>
                </ul>
              <% } else { %>
                <p class="muted small">直近2週間で受け渡し可能日はありません。</p>
              <% } %>
            </div>
          </div>

          <p class="muted xsmall pa-summary__note">
            詳細なカレンダーや特定日の編集は「設定を編集」から行えます。
          </p>
        </div>
      <% } %>
    </article>

    <article class="card card--shipping">
      <div class="card__head">
        <h2 class="card__title">配送・送料設定（概要）</h2>
        <a class="btn btn--ghost btn--sm" href="/admin/partners/<%= partner.id %>/shipping">
          設定を編集
        </a>
      </div>

      <% if (!shippingSummary || !shippingSummary.hasAny) { %>
        <p class="muted small">
          まだ配送・送料設定が登録されていません。「設定を編集」から設定してください。
        </p>
      <% } else { %>
        <div class="ship-summary">
          <!-- 全国一律（デフォルト） -->
          <section class="ship-summary__global">
            <h3 class="ship-summary__subtitle">全国一律の設定</h3>
            <p class="ship-summary__global-label">
              <%= shippingSummary.globalLabel %>
            </p>
          </section>

          <!-- 地域別タブ -->
          <section class="ship-summary__regions">
            <div class="ship-tabs" role="tablist">
              <button type="button"
                      class="ship-tab is-active"
                      data-tab="pref"
                      role="tab"
                      aria-selected="true">
                都道府県ごとの設定
              </button>
              <button type="button"
                      class="ship-tab"
                      data-tab="city"
                      role="tab"
                      aria-selected="false">
                市区町村ごとの設定
              </button>
            </div>

            <div class="ship-panels">
              <!-- 都道府県タブ -->
              <div class="ship-panel is-active"
                   data-tab="pref"
                   role="tabpanel">
                <% if (!shippingSummary.prefectureRules || !shippingSummary.prefectureRules.length) { %>
                  <p class="muted xsmall">都道府県単位の個別設定はありません。</p>
                <% } else { %>
                  <ul class="ship-list">
                    <% shippingSummary.prefectureRules.forEach(function(r) { %>
                      <li class="ship-list__item">
                        <div class="ship-list__label">
                          <span class="ship-pill"><%= r.prefecture %></span>
                        </div>
                        <div class="ship-list__meta">
                          <% if (!r.can_ship) { %>
                            <span class="ship-tag ship-tag--ng">配送不可</span>
                          <% } else { %>
                            <span class="ship-tag ship-tag--ok">
                              <%= (r.shipping_fee != null) ? (r.shipping_fee + '円') : '送料未設定' %>
                            </span>
                          <% } %>
                        </div>
                      </li>
                    <% }); %>
                  </ul>
                <% } %>
              </div>

              <!-- 市区町村タブ -->
              <div class="ship-panel"
                   data-tab="city"
                   role="tabpanel">
                <% if (!shippingSummary.cityRules || !shippingSummary.cityRules.length) { %>
                  <p class="muted xsmall">市区町村単位の個別設定はありません。</p>
                <% } else { %>
                  <ul class="ship-list">
                    <% shippingSummary.cityRules.forEach(function(r) { %>
                      <li class="ship-list__item">
                        <div class="ship-list__label">
                          <span class="ship-pill"><%= r.prefecture %></span>
                          <span class="ship-pill ship-pill--sub"><%= r.city %></span>
                        </div>
                        <div class="ship-list__meta">
                          <% if (!r.can_ship) { %>
                            <span class="ship-tag ship-tag--ng">配送不可</span>
                          <% } else { %>
                            <span class="ship-tag ship-tag--ok">
                              <%= (r.shipping_fee != null) ? (r.shipping_fee + '円') : '送料未設定' %>
                            </span>
                          <% } %>
                        </div>
                      </li>
                    <% }); %>
                  </ul>
                <% } %>
              </div>
            </div>

            <p class="muted xsmall ship-summary__note">
              ここに表示されているのは概要です。詳しい地域と金額は「設定を編集」から確認・変更できます。
            </p>
          </section>
        </div>
      <% } %>
    </article>

    <article class="card">
      <div class="card__head">
        <h2 class="card__title">決済方法（取引先全体）</h2>
      </div>

      <form action="/admin/partners/<%= partner.id %>/payments" method="POST" class="form">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>

        <div class="chips">
          <% allPaymentMethods.forEach(m => { %>
            <label class="chip">
              <input type="checkbox" name="methods" value="<%= m.value %>"
                    <%= paymentMethods.includes(m.value) ? 'checked' : '' %> >
              <span><%= m.label_ja %></span>
            </label>
          <% }) %>
        </div>

        <p class="muted small">
          保存すると、この取引先に所属する全ユーザーの「パートナー由来の決済方法」が同期されます。
          （ユーザー側で手動編集済みの設定は上書きされません）
        </p>

        <div class="row-right">
          <button class="btn btn--toggle" type="submit">保存</button>
        </div>
      </form>
    </article>
    <% } %>

    <!-- ユーザー一覧 -->
    <article class="card">
      <div class="card__head">
        <h2 class="card__title">所属ユーザー</h2>
        <span class="muted small"><%= users.length %>名</span>
      </div>

      <% if (!users.length) { %>
        <p class="muted">この取引先に紐づくユーザーはいません。</p>
      <% } else { %>
        <div class="table-wrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>ユーザー</th>
                <th>メール</th>
                <% if (user.roles.includes('admin')) { %>
                <th>ロール</th>
                <% } %>
                <th>登録日</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach(u => { %>
                <tr>
                  <td><strong><%= u.name %></strong></td>
                  <td><%= u.email %></td>
                  <% if (user.roles.includes('admin')) { %>
                  <td><%= (u.roles||[]).join(', ') %></td>
                  <% } %>
                  <td><%= new Date(u.created_at).toLocaleDateString('ja-JP') %></td>
                  <td class="ta-right">
                    <a class="btn" href="/admin/users/<%= u.id %>">詳細</a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="table-grid">
            <% users.forEach(u => { %>
                <div class="table-row">
                    <a class="table-info" href="/admin/users/<%= u.id %>">
                        <span>氏名　 ： <%= u.name %></span>
                        <% if (user.roles.includes('admin')) { %>
                        <span>ロール ： <%= (u.roles||[]).join(', ') %></span>
                        <% } %>
                        <span>メール ： <%= u.email %></span>
                        <span>登録日 ： <%= new Date(u.created_at).toLocaleDateString('ja-JP') %></span>
                    </a>
                  </td>
                </div>
            <% }) %>
        </div>
      <% } %>
    </article>
  </section>
</main>

<script src="/js/partner-show.js"></script>
<%- include('../../partials/footer') %>