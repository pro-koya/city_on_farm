<%- include('../../partials/header', {
  title,
  extraCSS2: '',
  extraCSS: '/styles/partner-show.css'
}) %>

<main class="ps">
  <header class="ps__head">
    <div class="ps__title-wrap">
      <h1 class="ps__title"><%= partner.name %></h1>
      <span class="ps__badge ps__badge--<%= partner.status %>" id="statusBadge">
        <%= partner.status === 'active' ? '有効' : '無効' %>
      </span>
    </div>
    <div class="ps__meta">
      <span>作成: <%= new Date(partner.created_at).toLocaleString('ja-JP') %></span>
      <span>更新: <%= new Date(partner.updated_at).toLocaleString('ja-JP') %></span>
    </div>

    <% if (user.roles.includes('admin')) { %>
    <div class="ps__actions">
      <form id="statusForm" action="/admin/partners/<%= partner.id %>/status" method="POST" class="inline">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <input type="hidden" name="status" id="statusInput" value="<%= partner.status === 'active' ? 'inactive':'active' %>">
        <button type="submit" class="btn btn--toggle" id="toggleBtn">
          <%= partner.status === 'active' ? '無効にする' : '有効にする' %>
        </button>
      </form>
      <a class="btn btn--ghost" href="/admin/partners">一覧へ戻る</a>
    </div>
    <% } %>

    <% if (user.roles.includes('seller') && isMember) { %>
    <!-- 出品者向け：紹介ページ管理への導線 -->
    <div class="ps__actions ps__actions--seller">
      <a class="btn btn--toggle" href="/seller/profile/edit">
        出品者紹介ページを編集
      </a>
      <a class="link" href="/sellers/<%= user.id %>" target="_blank" rel="noopener">
        公開中の紹介ページを確認 →
      </a>
    </div>
    <% } %>
  </header>

  <section class="ps__grid">
    <!-- 基本情報 -->
    <article class="card">
      <h2 class="card__title">店舗情報</h2>
      <dl class="kv">
        <div><dt>名称</dt><dd><%= partner.name %></dd></div>
        <% if (partner.kana) { %><div><dt>カナ</dt><dd><%= partner.kana %></dd></div><% } %>
        <div><dt>種別</dt><dd><%= partner.type %></dd></div>
        <div><dt>メール</dt><dd><%= partner.email || '—' %></dd></div>
        <div><dt>電話</dt><dd><%= partner.phone || '—' %></dd></div>
        <div><dt>Web</dt><dd>
          <% if (partner.website) { %>
            <a href="<%= partner.website %>" target="_blank" rel="noopener"><%= partner.website %></a>
          <% } else { %>—<% } %>
        </dd></div>
        <div><dt>請求メール</dt><dd><%= partner.billing_email || '—' %></dd></div>
        <div><dt>請求条件</dt><dd><%= partner.billing_terms || '—' %></dd></div>
        <div><dt>税ID</dt><dd><%= partner.tax_id || '—' %></dd></div>
        <div><dt>住所</dt><dd>
          <div class="addr">
            <div>〒 <%= partner.postal_code || '—' %></div>
            <div><%= [partner.prefecture, partner.city, partner.address1, partner.address2].filter(Boolean).join(' ') || '—' %></div>
          </div>
        </dd></div>
        <div class="kv--full"><dt>メモ</dt><dd><%= partner.note || '—' %></dd></div>
      </dl>
    </article>

    <% if (user.roles.includes('seller') || user.roles.includes('admin')) { %>
    <article class="card">
      <div class="card__head">
        <h2 class="card__title">決済方法（取引先全体）</h2>
      </div>

      <form action="/admin/partners/<%= partner.id %>/payments" method="POST" class="form">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>

        <div class="chips">
          <% allPaymentMethods.forEach(m => { %>
            <label class="chip">
              <input type="checkbox" name="methods" value="<%= m.value %>"
                    <%= paymentMethods.includes(m.value) ? 'checked' : '' %> >
              <span><%= m.label_ja %></span>
            </label>
          <% }) %>
        </div>

        <p class="muted small">
          保存すると、この取引先に所属する全ユーザーの「パートナー由来の決済方法」が同期されます。
          （ユーザー側で手動編集済みの設定は上書きされません）
        </p>

        <div class="row-right">
          <button class="btn btn--toggle" type="submit">保存</button>
        </div>
      </form>
    </article>
    <% } %>

    <!-- ユーザー一覧 -->
    <article class="card">
      <div class="card__head">
        <h2 class="card__title">所属ユーザー</h2>
        <span class="muted small"><%= users.length %>名</span>
      </div>

      <% if (!users.length) { %>
        <p class="muted">この取引先に紐づくユーザーはいません。</p>
      <% } else { %>
        <div class="table-wrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>ユーザー</th>
                <th>メール</th>
                <% if (user.roles.includes('admin')) { %>
                <th>ロール</th>
                <% } %>
                <th>登録日</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach(u => { %>
                <tr>
                  <td><strong><%= u.name %></strong></td>
                  <td><%= u.email %></td>
                  <% if (user.roles.includes('admin')) { %>
                  <td><%= (u.roles||[]).join(', ') %></td>
                  <% } %>
                  <td><%= new Date(u.created_at).toLocaleDateString('ja-JP') %></td>
                  <td class="ta-right">
                    <a class="btn" href="/admin/users/<%= u.id %>">詳細</a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="table-grid">
            <% users.forEach(u => { %>
                <div class="table-row">
                    <a class="table-info" href="/admin/users/<%= u.id %>">
                        <span>氏名　 ： <%= u.name %></span>
                        <% if (user.roles.includes('admin')) { %>
                        <span>ロール ： <%= (u.roles||[]).join(', ') %></span>
                        <% } %>
                        <span>メール ： <%= u.email %></span>
                        <span>登録日 ： <%= new Date(u.created_at).toLocaleDateString('ja-JP') %></span>
                    </a>
                  </td>
                </div>
            <% }) %>
        </div>
      <% } %>
    </article>
  </section>
</main>

<!-- <script src="/js/partner-show.js"></script> -->
<%- include('../../partials/footer') %>