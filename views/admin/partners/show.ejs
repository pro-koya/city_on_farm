<%- include('../../partials/header', {
  title,
  extraCSS2: '',
  extraCSS: '/styles/partner-show.css'
}) %>

<main class="ps">

  <header class="ps__head">
    <div class="ps__title-wrap">
      <h1 class="ps__title"><%= partner.name %></h1>
      <span class="ps__badge ps__badge--<%= partner.status %>" id="statusBadge">
        <%= partner.status === 'active' ? '有効' : '無効' %>
      </span>
    </div>
    <div class="ps__meta">
      <span>作成: <%= new Date(partner.created_at).toLocaleString('ja-JP') %></span>
      <span>更新: <%= new Date(partner.updated_at).toLocaleString('ja-JP') %></span>
    </div>

    <% if (user.roles.includes('admin')) { %>
    <div class="ps__actions">
      <!-- <form id="statusForm" action="/admin/partners/<%= partner.id %>/status" method="POST" class="inline">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <input type="hidden" name="status" id="statusInput" value="<%= partner.status === 'active' ? 'inactive':'active' %>">
        <button type="submit" class="btn btn--toggle" id="toggleBtn">
          <%= partner.status === 'active' ? '無効にする' : '有効にする' %>
        </button>
      </form> -->
      <a class="btn btn--ghost" href="/admin/partners">一覧へ戻る</a>
    </div>
    <% } %>

    <% if (user.roles.includes('seller') && isMember) { %>
    <!-- 出品者向け：紹介ページ管理への導線 -->
    <div class="ps__actions ps__actions--seller">
      <a class="btn btn--toggle" href="/seller/profile/edit">
        出品者紹介ページを編集
      </a>
      <a class="btn btn--ghost" href="/sellers/<%= user.id %>" target="_blank" rel="noopener">
        紹介ページを確認
      </a>
    </div>
    <% } %>
  </header>

  <section class="ps__grid">
    <!-- 基本情報 -->
    <article class="card">
      <div class="card__head">
        <h2 class="card__title">店舗情報</h2>
        <% if (user.roles.includes('admin') || isMember) { %>
        <button type="button" class="btn btn--ghost btn--sm" id="editPartnerBtn">
          編集
        </button>
        <% } %>
      </div>

      <!-- 表示モード -->
      <div id="partnerViewMode">
        <dl class="kv">
          <!-- アイコン画像 -->
          <div class="kv--full">
            <dt>アイコン画像</dt>
            <dd>
              <% if (partner.icon_url) { %>
                <img src="<%= partner.icon_url %>" alt="<%= partner.name %>のアイコン"
                     style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main);">
              <% } else { %>
                <span class="muted">未設定</span>
              <% } %>
            </dd>
          </div>

          <div><dt>名称</dt><dd><%= partner.name %></dd></div>
          <% if (partner.kana) { %><div><dt>カナ</dt><dd><%= partner.kana %></dd></div><% } %>
          <div><dt>種別</dt><dd><%= partner.type %></dd></div>
          <div><dt>メール</dt><dd><%= partner.email || '—' %></dd></div>
          <div><dt>電話</dt><dd><%= partner.phone || '—' %></dd></div>
          <div><dt>Web</dt><dd>
            <% if (partner.website) { %>
              <a href="<%= partner.website %>" target="_blank" rel="noopener"><%= partner.website %></a>
            <% } else { %>—<% } %>
          </dd></div>
          <div><dt>税ID</dt><dd><%= partner.tax_id || '—' %></dd></div>
          <div><dt>住所</dt><dd>
            <div class="addr">
              <div>〒 <%= partner.postal_code || '—' %></div>
              <div><%= [partner.prefecture, partner.city, partner.address1, partner.address2].filter(Boolean).join(' ') || '—' %></div>
            </div>
          </dd></div>
          <div class="kv--full">
            <dt>畑受け取り住所</dt>
            <dd>
              <% if (pickupAddress) { %>
                <div class="addr" style="margin-top: 0.5rem;">
                  <div><strong><%= pickupAddress.full_name %></strong></div>
                  <div>〒 <%= pickupAddress.postal_code %></div>
                  <div><%= [pickupAddress.prefecture, pickupAddress.city, pickupAddress.address_line1, pickupAddress.address_line2].filter(Boolean).join(' ') %></div>
                  <% if (pickupAddress.phone) { %>
                    <div style="margin-top: 0.25rem; color: var(--muted); font-size: 0.875rem;">TEL: <%= pickupAddress.phone %></div>
                  <% } %>
                </div>
              <% } else { %>
                <span class="muted">未設定（基本住所が使用されます）</span>
              <% } %>
            </dd>
          </div>
          <div class="kv--full"><dt>メモ</dt><dd><%= partner.note || '—' %></dd></div>
        </dl>
      </div>

      <!-- 編集モード -->
      <% if (user.roles.includes('admin') || isMember) { %>
      <div id="partnerEditMode" style="display: none;">
        <form action="/admin/partners/<%= partner.id %>/edit" method="POST" class="form h-adr" id="partnerEditForm">
          <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
          <span class="p-country-name" style="display: none;">Japan</span>

          <!-- アイコン画像アップロード -->
          <div class="field">
            <label for="partner_icon">アイコン画像</label>
            <div class="uploader-wrap">
              <!-- 現在のアイコンプレビュー -->
              <div id="iconPreview" style="margin-bottom: 12px;">
                <% if (partner.icon_url) { %>
                  <img src="<%= partner.icon_url %>" alt="現在のアイコン"
                       style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--main);">
                <% } %>
              </div>

              <!-- hiddenフィールド -->
              <input type="hidden" id="partner_icon_url" name="icon_url" value="<%= partner.icon_url || '' %>">
              <input type="hidden" id="partner_icon_r2_key" name="icon_r2_key" value="<%= partner.icon_r2_key || '' %>">

              <!-- ボタン群 -->
              <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                <button type="button" class="btn btn--ghost btn--sm" id="uploadIconBtn">新しい画像をアップロード</button>
                <button type="button" class="btn btn--ghost btn--sm" id="selectFromLibraryBtn">ライブラリから選択</button>
                <% if (partner.icon_url) { %>
                  <button type="button" class="btn btn--ghost btn--sm" id="removeIconBtn">削除</button>
                <% } else { %>
                  <button type="button" class="btn btn--ghost btn--sm" id="removeIconBtn" style="display: none;">削除</button>
                <% } %>
              </div>

              <!-- ファイル選択input（非表示） -->
              <input type="file" id="iconFileInput" accept="image/jpeg,image/png,image/webp,image/avif,image/gif" style="display: none;">

              <!-- メッセージ表示 -->
              <div id="iconUploadMsg" style="font-size: 0.875rem; color: var(--muted); margin-top: 4px;"></div>
            </div>
          </div>

          <div class="field">
            <label for="partner_name">名称 *</label>
            <input type="text" id="partner_name" name="name" value="<%= partner.name || '' %>" required>
          </div>

          <div class="field">
            <label for="partner_kana">カナ</label>
            <input type="text" id="partner_kana" name="kana" value="<%= partner.kana || '' %>">
          </div>

          <div class="field">
            <label for="partner_type">種別</label>
            <select id="partner_type" name="type" class="pulldown">
              <option value="">-- 任意 --</option>
              <option value="restaurant" <%= partner.type === 'restaurant' ? 'selected' : '' %>>飲食店</option>
              <option value="retailer" <%= partner.type === 'retailer' ? 'selected' : '' %>>小売</option>
              <option value="wholesale" <%= partner.type === 'wholesale' ? 'selected' : '' %>>卸</option>
              <option value="other" <%= partner.type === 'other' ? 'selected' : '' %>>その他</option>
            </select>
          </div>

          <div class="field">
            <label for="partner_email">メールアドレス</label>
            <input type="email" id="partner_email" name="email" value="<%= partner.email || '' %>">
          </div>

          <div class="field">
            <label for="partner_phone">電話番号</label>
            <input type="tel" id="partner_phone" name="phone" value="<%= partner.phone || '' %>">
          </div>

          <div class="field">
            <label for="partner_website">Webサイト</label>
            <input type="url" id="partner_website" name="website" value="<%= partner.website || '' %>" placeholder="https://example.com">
          </div>

          <div class="field">
            <label for="partner_tax_id">税ID</label>
            <input type="text" id="partner_tax_id" name="tax_id" value="<%= partner.tax_id || '' %>">
          </div>

          <div class="grid3">
            <div class="field">
              <label for="partner_postal_code">郵便番号</label>
              <input type="text" id="partner_postal_code" name="postal_code" value="<%= partner.postal_code || '' %>" class="p-postal-code">
            </div>
            <div class="field">
              <label for="partner_prefecture">都道府県</label>
              <input type="text" id="partner_prefecture" name="prefecture" value="<%= partner.prefecture || '' %>" class="p-region" readonly>
            </div>
            <div class="field">
              <label for="partner_city">市区町村</label>
              <input type="text" id="partner_city" name="city" value="<%= partner.city || '' %>" class="p-locality" readonly>
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label for="partner_address1">番地</label>
              <input type="text" id="partner_address1" name="address1" value="<%= partner.address1 || '' %>" class="p-street-address">
            </div>
            <div class="field">
              <label for="partner_address2">建物名・部屋</label>
              <input type="text" id="partner_address2" name="address2" value="<%= partner.address2 || '' %>" class="p-extended-address">
            </div>
          </div>

          <!-- 畑受け取り住所設定 -->
          <div class="field" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
            <label for="partner_pickup_address_id">畑受け取り住所</label>
            <p class="field-hint" style="font-size: 0.875rem; color: var(--muted); margin-bottom: 0.5rem;">
              畑で受け取りを選択した注文で使用する住所を設定します。未設定の場合は基本住所が使用されます。
            </p>
            <select id="partner_pickup_address_id" name="pickup_address_id" class="pulldown">
              <option value="">未設定（基本住所を使用）</option>
              <% if (typeof availableAddresses !== 'undefined' && availableAddresses && availableAddresses.length > 0) { %>
                <% availableAddresses.forEach(addr => { %>
                  <option value="<%= addr.id %>" <%= (partner.pickup_address_id && String(partner.pickup_address_id) === String(addr.id)) ? 'selected' : '' %>>
                    <%= addr.full_name %> - 〒<%= addr.postal_code %> <%= [addr.prefecture, addr.city, addr.address_line1].filter(Boolean).join(' ') %>
                    <% if (addr.is_default) { %>（デフォルト）<% } %>
                  </option>
                <% }) %>
              <% } %>
            </select>
            <% if (typeof availableAddresses !== 'undefined' && availableAddresses && availableAddresses.length === 0) { %>
              <p class="field-hint" style="font-size: 0.875rem; color: var(--muted); margin-top: 0.5rem;">
                この取引先に紐づくユーザーが登録した住所がありません。ユーザー管理ページから住所を登録してください。
              </p>
            <% } %>
          </div>

          <div class="field">
            <label for="partner_note">メモ</label>
            <textarea id="partner_note" name="note" rows="4"><%= partner.note || '' %></textarea>
          </div>

          <div class="row-right" style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;">
            <button type="button" class="btn btn--ghost" id="cancelEditBtn">キャンセル</button>
            <button type="submit" class="btn btn--toggle">保存</button>
          </div>
        </form>
      </div>
      <% } %>
    </article>

    <% if (user.roles.includes('seller') || user.roles.includes('admin')) { %>
    <!-- 配送方法（取引先全体） -->
    <article class="card">
      <div class="card__head">
        <h2 class="card__title">配送方法（取引先全体）</h2>
      </div>

      <form id="shipMethodForm" action="/admin/partners/<%= partner.id %>/shipmethods" method="POST" class="form">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>

        <!-- エラーメッセージ表示エリア -->
        <div id="shipMethodError" class="error" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;"></div>

        <div class="chips">
          <% if (typeof allShipMethods !== 'undefined' && allShipMethods && allShipMethods.length > 0) { %>
            <% allShipMethods.forEach(m => { %>
              <label class="chip">
                <input type="checkbox" name="methods" value="<%= m.value %>"
                      <%= (typeof shipMethods !== 'undefined' && shipMethods && shipMethods.includes(m.value)) ? 'checked' : '' %> >
                <span><%= m.label_ja %></span>
              </label>
            <% }) %>
          <% } else { %>
            <p class="muted small">配送方法の読み込み中...</p>
          <% } %>
        </div>

        <p class="muted small">
          購入者がチェックアウト時に選択できる配送方法を設定します。
          配送設定との整合性にご注意ください。
        </p>

        <div class="row-right">
          <button class="btn btn--toggle" type="submit">保存</button>
        </div>
      </form>
    </article>

    <article class="card card--availability">
      <div class="card__head">
        <h2 class="card__title">受け渡し可能日（概要）</h2>
        <a class="btn btn--ghost btn--sm" href="/admin/partners/<%= partner.id %>/availability">
          設定を編集
        </a>
      </div>

      <% if (!availabilitySummary || (!availabilitySummary.weekly_delivery_label && !availabilitySummary.weekly_pickup_label && (!availabilitySummary.preview || !availabilitySummary.preview.length))) { %>
        <p class="muted small">
          まだ受け渡し可能日が設定されていません。「設定を編集」から設定してください。
        </p>
      <% } else { %>
        <div class="pa-summary">
          <div class="pa-summary__row">
            <!-- 左：毎週パターン -->
            <div class="pa-summary__col">
              <h3 class="pa-summary__subtitle">毎週のパターン</h3>
              <dl class="kv kv--stack">
                <div>
                  <dt>配送</dt>
                  <dd><%= availabilitySummary.weekly_delivery_label || '未設定' %></dd>
                </div>
                <div>
                  <dt>畑受け渡し</dt>
                  <dd><%= availabilitySummary.weekly_pickup_label || '未設定' %></dd>
                </div>
              </dl>

              <% if (availabilitySummary.specials_label) { %>
                <p class="muted xsmall">
                  <%= availabilitySummary.specials_label %>
                </p>
              <% } %>
            </div>

            <!-- 右：直近の受け渡し可能日（ミニカレンダー的な一覧） -->
            <div class="pa-summary__col pa-summary__calendar">
              <h3 class="pa-summary__subtitle">直近の受け渡し可能日</h3>

              <% if (availabilitySummary.preview && availabilitySummary.preview.length) { %>
                <ul class="pa-summary__chips" aria-label="直近の受け渡し可能日">
                  <% availabilitySummary.preview.forEach(function(d) { %>
                    <li class="pa-summary__chip">
                      <div class="pa-summary__chip-date">
                        <span class="pa-summary__chip-week"><%= d.weekday + '曜' %></span>
                        <span class="pa-summary__chip-day"><%= d.month + '/' + d.day %></span>
                      </div>
                      <div class="pa-summary__chip-tags">
                        <% if (d.delivery) { %><span class="tag tag--delivery">配送</span><% } %>
                        <% if (d.pickup)  { %><span class="tag tag--pickup">畑</span><% } %>
                      </div>
                    </li>
                  <% }); %>
                </ul>
              <% } else { %>
                <p class="muted small">直近2週間で受け渡し可能日はありません。</p>
              <% } %>
            </div>
          </div>

          <p class="muted xsmall pa-summary__note">
            詳細なカレンダーや特定日の編集は「設定を編集」から行えます。
          </p>
        </div>
      <% } %>
    </article>

    <article class="card card--shipping">
      <div class="card__head">
        <h2 class="card__title">配送・送料設定（概要）</h2>
        <a class="btn btn--ghost btn--sm" href="/admin/partners/<%= partner.id %>/shipping">
          設定を編集
        </a>
      </div>

      <% if (!shippingSummary || !shippingSummary.hasAny) { %>
        <p class="muted small">
          まだ配送・送料設定が登録されていません。「設定を編集」から設定してください。
        </p>
      <% } else { %>
        <div class="ship-summary">
          <!-- 全国一律（デフォルト） -->
          <section class="ship-summary__global">
            <h3 class="ship-summary__subtitle">全国一律の設定</h3>
            <p class="ship-summary__global-label">
              <%= shippingSummary.globalLabel %>
            </p>
          </section>

          <!-- 地域別タブ -->
          <section class="ship-summary__regions">
            <div class="ship-tabs" role="tablist">
              <button type="button"
                      class="ship-tab is-active"
                      data-tab="pref"
                      role="tab"
                      aria-selected="true">
                都道府県ごとの設定
              </button>
              <button type="button"
                      class="ship-tab"
                      data-tab="city"
                      role="tab"
                      aria-selected="false">
                市区町村ごとの設定
              </button>
            </div>

            <div class="ship-panels">
              <!-- 都道府県タブ -->
              <div class="ship-panel is-active"
                   data-tab="pref"
                   role="tabpanel">
                <% if (!shippingSummary.prefectureRules || !shippingSummary.prefectureRules.length) { %>
                  <p class="muted xsmall">都道府県単位の個別設定はありません。</p>
                <% } else { %>
                  <ul class="ship-list">
                    <% shippingSummary.prefectureRules.forEach(function(r) { %>
                      <li class="ship-list__item">
                        <div class="ship-list__label">
                          <span class="ship-pill"><%= r.prefecture %></span>
                        </div>
                        <div class="ship-list__meta">
                          <% if (!r.can_ship) { %>
                            <span class="ship-tag ship-tag--ng">配送不可</span>
                          <% } else { %>
                            <span class="ship-tag ship-tag--ok">
                              <%= (r.shipping_fee != null) ? (r.shipping_fee + '円') : '送料未設定' %>
                            </span>
                          <% } %>
                        </div>
                      </li>
                    <% }); %>
                  </ul>
                <% } %>
              </div>

              <!-- 市区町村タブ -->
              <div class="ship-panel"
                   data-tab="city"
                   role="tabpanel">
                <% if (!shippingSummary.cityRules || !shippingSummary.cityRules.length) { %>
                  <p class="muted xsmall">市区町村単位の個別設定はありません。</p>
                <% } else { %>
                  <ul class="ship-list">
                    <% shippingSummary.cityRules.forEach(function(r) { %>
                      <li class="ship-list__item">
                        <div class="ship-list__label">
                          <span class="ship-pill"><%= r.prefecture %></span>
                          <span class="ship-pill ship-pill--sub"><%= r.city %></span>
                        </div>
                        <div class="ship-list__meta">
                          <% if (!r.can_ship) { %>
                            <span class="ship-tag ship-tag--ng">配送不可</span>
                          <% } else { %>
                            <span class="ship-tag ship-tag--ok">
                              <%= (r.shipping_fee != null) ? (r.shipping_fee + '円') : '送料未設定' %>
                            </span>
                          <% } %>
                        </div>
                      </li>
                    <% }); %>
                  </ul>
                <% } %>
              </div>
            </div>

            <p class="muted xsmall ship-summary__note">
              ここに表示されているのは概要です。詳しい地域と金額は「設定を編集」から確認・変更できます。
            </p>
          </section>
        </div>
      <% } %>
    </article>

    <article class="card">
      <div class="card__head">
        <h2 class="card__title">決済方法（取引先全体）</h2>
      </div>

      <form id="paymentMethodForm" action="/admin/partners/<%= partner.id %>/payments" method="POST" class="form">
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>

        <!-- エラーメッセージ表示エリア -->
        <div id="paymentMethodError" class="error" style="display: none; margin-bottom: 1rem; padding: 0.75rem; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33;"></div>

        <div class="chips">
          <% if (typeof allPaymentMethods !== 'undefined' && allPaymentMethods && allPaymentMethods.length > 0) { %>
            <% allPaymentMethods.forEach(m => { %>
              <label class="chip">
                <input type="checkbox" name="methods" value="<%= m.value %>"
                      <%= (typeof paymentMethods !== 'undefined' && paymentMethods && paymentMethods.includes(m.value)) ? 'checked' : '' %> >
                <span><%= m.label_ja %></span>
              </label>
            <% }) %>
          <% } else { %>
            <p class="muted small">決済方法の読み込み中...</p>
          <% } %>
        </div>

        <p class="muted small">
          保存すると、この取引先に所属する全ユーザーの「パートナー由来の決済方法」が同期されます。
          （ユーザー側で手動編集済みの設定は上書きされません）
        </p>

        <div class="row-right">
          <button class="btn btn--toggle" type="submit">保存</button>
        </div>
      </form>
    </article>
    <% } %>

    <!-- Stripe Connect 送金設定 -->
    <% if (user.roles.includes('admin')) { %>
    <article class="card">
      <div class="card__head">
        <h2 class="card__title">Stripe Connect 送金設定</h2>
        <% if (partner.stripe_account_id && partner.payouts_enabled) { %>
          <span class="badge badge--success">送金有効</span>
        <% } else if (partner.stripe_account_id) { %>
          <span class="badge badge--warning">送金停止中</span>
        <% } %>
      </div>

      <% if (!partner.stripe_account_id) { %>
        <!-- Stripe アカウント未接続 -->
        <div id="stripeConnectEmptyView">
          <p class="muted">
            Stripe Connectアカウントが接続されていません。<br>
            クレジットカード決済の売上を自動送金するには、Stripe アカウントとの連携が必要です。
          </p>
          <div class="row-right" style="margin-top: 1rem;">
            <button class="btn btn--toggle" id="stripeOnboardingBtn">
              Stripe アカウントを接続
            </button>
          </div>
        </div>
      <% } else { %>
        <!-- Stripe アカウント接続済み -->
        <div id="stripeConnectInfoView">
          <dl class="kv">
            <div>
              <dt>Stripe アカウントID</dt>
              <dd><code style="font-size: 0.875rem; background: #f5f5f5; padding: 2px 6px; border-radius: 3px;"><%= partner.stripe_account_id %></code></dd>
            </div>
            <div>
              <dt>アカウント種別</dt>
              <dd><%= partner.stripe_account_type || 'express' %></dd>
            </div>
            <div>
              <dt>本人確認</dt>
              <dd>
                <% if (partner.stripe_details_submitted) { %>
                  <span class="badge badge--success">完了</span>
                <% } else { %>
                  <span class="badge badge--warning">未完了</span>
                <% } %>
              </dd>
            </div>
            <div>
              <dt>決済受付</dt>
              <dd>
                <% if (partner.charges_enabled) { %>
                  <span class="badge badge--success">有効</span>
                <% } else { %>
                  <span class="badge badge--secondary">無効</span>
                <% } %>
              </dd>
            </div>
            <div>
              <dt>送金機能</dt>
              <dd>
                <% if (partner.payouts_enabled) { %>
                  <span class="badge badge--success">有効</span>
                <% } else { %>
                  <span class="badge badge--secondary">無効</span>
                  <% if (partner.stop_reason === 'debt_over_10000') { %>
                    <span class="muted small" style="margin-left: 8px;">（負債超過）</span>
                  <% } %>
                <% } %>
              </dd>
            </div>
            <% if (partner.debt_cents && partner.debt_cents > 0) { %>
            <div>
              <dt>負債額</dt>
              <dd>
                <span style="color: #c33; font-weight: bold;">¥<%= partner.debt_cents.toLocaleString() %></span>
                <% if (partner.debt_cents > 10000) { %>
                  <span class="badge badge--danger" style="margin-left: 8px;">送金停止中</span>
                <% } %>
              </dd>
            </div>
            <% } %>
            <% if (partner.requirements_due_by) { %>
            <div>
              <dt>要件期限</dt>
              <dd style="color: #c33;">
                <%= new Date(partner.requirements_due_by).toLocaleDateString('ja-JP') %>
                <span class="muted small">までに対応が必要です</span>
              </dd>
            </div>
            <% } %>
          </dl>

          <div class="row-right" style="margin-top: 1rem; display: flex; gap: 8px; justify-content: flex-end;">
            <% if (!partner.stripe_details_submitted) { %>
              <button class="btn btn--warning" id="stripeContinueBtn">
                本人確認を続ける
              </button>
            <% } else { %>
              <button class="btn btn--secondary" id="stripeDashboardBtn">
                Stripe ダッシュボードを開く
              </button>
            <% } %>
            <button class="btn btn--ghost" id="stripeSyncBtn">
              情報を同期
            </button>
            <a class="btn btn--ghost" href="/admin/partners/<%= partner.id %>/balance" target="_blank">
              残高・台帳を確認
            </a>
          </div>
        </div>
      <% } %>
    </article>

    <script>
    // オンボーディング完了後のリロード処理
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('onboarding') === 'success') {
      // クエリパラメータを削除してページをリロード
      window.history.replaceState({}, document.title, window.location.pathname);
      // 少し待ってからリロード（DBの同期を待つ）
      setTimeout(() => {
        window.location.reload();
      }, 1000);
    }

    // Stripe Connect オンボーディング開始
    const stripeOnboardingBtn = document.getElementById('stripeOnboardingBtn');
    console.log('[DEBUG] stripeOnboardingBtn element:', stripeOnboardingBtn);

    stripeOnboardingBtn?.addEventListener('click', async (event) => {
      console.log('[DEBUG] stripeOnboardingBtn clicked!');
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '接続中...';

      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        <% if (csrfToken) { %>
        headers['X-CSRF-Token'] = '<%= csrfToken %>';
        console.log('[DEBUG] CSRF token added to headers');
        <% } else { %>
        console.log('[DEBUG] No CSRF token available');
        <% } %>

        const url = '/admin/partners/<%= partner.id %>/stripe-onboarding';
        console.log('[DEBUG] Fetching:', url);
        console.log('[DEBUG] Headers:', headers);

        const response = await fetch(url, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            returnUrl: window.location.origin + '/admin/partners/<%= partner.id %>/stripe-return',
            refreshUrl: window.location.origin + '/admin/partners/<%= partner.id %>/stripe-refresh'
          })
        });

        console.log('[DEBUG] Response status:', response.status);
        console.log('[DEBUG] Response:', response);

        const data = await response.json();
        console.log('[DEBUG] Response data:', data);

        if (data.success && data.onboardingUrl) {
          console.log('[DEBUG] Redirecting to:', data.onboardingUrl);
          window.location.href = data.onboardingUrl;
        } else {
          console.error('[DEBUG] Error in response:', data.error);
          alert('エラー: ' + (data.error || '不明なエラーが発生しました'));
          btn.disabled = false;
          btn.textContent = 'Stripe アカウントを接続';
        }
      } catch (error) {
        console.error('[DEBUG] Fetch error:', error);
        alert('エラー: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Stripe アカウントを接続';
      }
    });

    // 本人確認を続ける
    const stripeContinueBtn = document.getElementById('stripeContinueBtn');
    console.log('[DEBUG] stripeContinueBtn element:', stripeContinueBtn);

    stripeContinueBtn?.addEventListener('click', async (event) => {
      console.log('[DEBUG] stripeContinueBtn clicked!');
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '処理中...';

      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        <% if (csrfToken) { %>
        headers['X-CSRF-Token'] = '<%= csrfToken %>';
        console.log('[DEBUG] CSRF token added to headers');
        <% } else { %>
        console.log('[DEBUG] No CSRF token available');
        <% } %>

        const url = '/admin/partners/<%= partner.id %>/stripe-onboarding';
        console.log('[DEBUG] Fetching:', url);
        console.log('[DEBUG] Headers:', headers);

        const response = await fetch(url, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            returnUrl: window.location.origin + '/admin/partners/<%= partner.id %>/stripe-return',
            refreshUrl: window.location.origin + '/admin/partners/<%= partner.id %>/stripe-refresh'
          })
        });

        console.log('[DEBUG] Response status:', response.status);
        console.log('[DEBUG] Response:', response);

        const data = await response.json();
        console.log('[DEBUG] Response data:', data);

        if (data.success && data.onboardingUrl) {
          console.log('[DEBUG] Redirecting to:', data.onboardingUrl);
          window.location.href = data.onboardingUrl;
        } else {
          console.error('[DEBUG] Error in response:', data.error);
          alert('エラー: ' + (data.error || '不明なエラーが発生しました'));
          btn.disabled = false;
          btn.textContent = '本人確認を続ける';
        }
      } catch (error) {
        console.error('[DEBUG] Fetch error:', error);
        alert('エラー: ' + error.message);
        btn.disabled = false;
        btn.textContent = '本人確認を続ける';
      }
    });

    // Stripe ダッシュボードを開く
    document.getElementById('stripeDashboardBtn')?.addEventListener('click', async (event) => {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '処理中...';

      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        <% if (csrfToken) { %>
        headers['X-CSRF-Token'] = '<%= csrfToken %>';
        <% } %>

        const response = await fetch('/admin/partners/<%= partner.id %>/stripe-dashboard-link', {
          method: 'POST',
          headers: headers
        });

        const data = await response.json();
        console.log('[DEBUG] Response data:', data);
        if (data.success && data.dashboardUrl) {
          window.open(data.dashboardUrl, '_blank');
          btn.disabled = false;
          btn.textContent = 'Stripe ダッシュボードを開く';
        } else {
          const errorMsg = data.error || '不明なエラーが発生しました';
          if (errorMsg.includes('not completed onboarding')) {
            alert('エラー: 本人確認が完了していません。先に「本人確認を続ける」ボタンからオンボーディングを完了してください。');
          } else {
            alert('エラー: ' + errorMsg);
          }
          btn.disabled = false;
          btn.textContent = 'Stripe ダッシュボードを開く';
        }
      } catch (error) {
        alert('エラー: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Stripe ダッシュボードを開く';
      }
    });

    // 情報を同期
    document.getElementById('stripeSyncBtn')?.addEventListener('click', async (event) => {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '同期中...';

      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        <% if (csrfToken) { %>
        headers['X-CSRF-Token'] = '<%= csrfToken %>';
        <% } %>

        const response = await fetch('/admin/partners/<%= partner.id %>/stripe-sync', {
          method: 'POST',
          headers: headers
        });

        const data = await response.json();

        if (data.success) {
          alert('同期が完了しました');
          window.location.reload();
        } else {
          alert('エラー: ' + (data.error || '不明なエラーが発生しました'));
          btn.disabled = false;
          btn.textContent = '情報を同期';
        }
      } catch (error) {
        alert('エラー: ' + error.message);
        btn.disabled = false;
        btn.textContent = '情報を同期';
      }
    });
    </script>
    <% } %>

    <!-- ユーザー一覧 -->
    <article class="card">
      <div class="card__head">
        <h2 class="card__title">所属ユーザー</h2>
        <span class="muted small"><%= users.length %>名</span>
      </div>

      <% if (!users.length) { %>
        <p class="muted">この取引先に紐づくユーザーはいません。</p>
      <% } else { %>
        <div class="table-wrap">
          <table class="tbl">
            <thead>
              <tr>
                <th>ユーザー</th>
                <th>メール</th>
                <% if (user.roles.includes('admin')) { %>
                <th>ロール</th>
                <% } %>
                <th>登録日</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% users.forEach(u => { %>
                <tr>
                  <td><strong><%= u.name %></strong></td>
                  <td><%= u.email %></td>
                  <% if (user.roles.includes('admin')) { %>
                  <td><%= (u.roles||[]).join(', ') %></td>
                  <% } %>
                  <td><%= new Date(u.created_at).toLocaleDateString('ja-JP') %></td>
                  <td class="ta-right">
                    <a class="btn" href="/admin/users/<%= u.id %>">詳細</a>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <div class="table-grid">
            <% users.forEach(u => { %>
                <div class="table-row">
                    <a class="table-info" href="/admin/users/<%= u.id %>">
                        <span>氏名　 ： <%= u.name %></span>
                        <% if (user.roles.includes('admin')) { %>
                        <span>ロール ： <%= (u.roles||[]).join(', ') %></span>
                        <% } %>
                        <span>メール ： <%= u.email %></span>
                        <span>登録日 ： <%= new Date(u.created_at).toLocaleDateString('ja-JP') %></span>
                    </a>
                  </td>
                </div>
            <% }) %>
        </div>
      <% } %>
    </article>
  </section>

  <!-- 与信管理セクション -->
  <% if (user && user.roles && user.roles.includes('admin')) { %>
  <section class="ps__section" id="credit">
    <article class="card">
      <div class="card__head"><h2>与信管理</h2></div>
      <div class="ps__form-grid" style="padding: 1rem;">
        <dl class="kv" style="margin-bottom: 1rem;">
          <div style="display:flex; gap:1rem; margin-bottom:0.5rem;">
            <dt style="min-width:120px; font-size:0.85rem; color:#6b7280;">与信限度額</dt>
            <dd style="font-size:0.95rem;">
              <% if (partner.credit_limit > 0) { %>
                <strong>&#165;<%= Number(partner.credit_limit || 0).toLocaleString() %></strong>
              <% } else { %>
                <span class="muted">未設定（無制限）</span>
              <% } %>
            </dd>
          </div>
          <div style="display:flex; gap:1rem; margin-bottom:0.5rem;">
            <dt style="min-width:120px; font-size:0.85rem; color:#6b7280;">利用中</dt>
            <dd style="font-size:0.95rem;">&#165;<%= Number(partner.credit_used || 0).toLocaleString() %></dd>
          </div>
          <div style="display:flex; gap:1rem; margin-bottom:0.5rem;">
            <dt style="min-width:120px; font-size:0.85rem; color:#6b7280;">残高</dt>
            <dd style="font-size:0.95rem;">
              <% if (partner.credit_limit > 0) { %>
                <strong>&#165;<%= Number((partner.credit_limit || 0) - (partner.credit_used || 0)).toLocaleString() %></strong>
              <% } else { %>
                <span class="muted">無制限</span>
              <% } %>
            </dd>
          </div>
          <div style="display:flex; gap:1rem;">
            <dt style="min-width:120px; font-size:0.85rem; color:#6b7280;">支払期限</dt>
            <dd style="font-size:0.95rem;"><%= partner.payment_terms_days || 30 %> 日</dd>
          </div>
        </dl>

        <form method="POST" action="/admin/partners/<%= partner.id %>/credit" style="display:flex; gap:0.75rem; flex-wrap:wrap; align-items:flex-end;">
          <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <% } %>
          <div class="field" style="flex:1; min-width:140px;">
            <label style="display:block; font-size:0.85rem; font-weight:600; margin-bottom:0.25rem;">与信限度額（円）</label>
            <input type="number" name="creditLimit" value="<%= partner.credit_limit || 0 %>" min="0" step="1000"
              style="width:100%; padding:0.5rem 0.75rem; border:1px solid var(--border, #e5e7eb); border-radius:8px; font-size:0.95rem;">
          </div>
          <div class="field" style="flex:0 0 auto;">
            <button type="submit" class="btn btn--primary">更新</button>
          </div>
        </form>
        <p style="font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">0 に設定すると与信チェックが無効（無制限）になります。</p>
      </div>
    </article>
  </section>
  <% } %>
</main>

<script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
<script src="/js/uploader-r2.js"></script>
<script src="/js/partner-show.js"></script>
<%- include('../../partials/footer') %>