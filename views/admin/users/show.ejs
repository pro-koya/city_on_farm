<%- include('../../partials/header', {
  title: (isSelf ? 'アカウント設定' : `ユーザー: ${user.name}`),
  extraCSS2: '',
  extraCSS: '/styles/user-show.css',
  extraJS: '/js/user-show.js'
}) %>

<main class="us">
  <!-- ページヘッダ -->
  <header class="us__head">
    <div class="us__title">
      <h1><%= user.name %></h1>
      <div class="us__meta">
        <span>登録: <%= new Date(user.created_at).toLocaleDateString('ja-JP') %></span>
      </div>
      <div class="us__meta">
        <span>更新: <%= new Date(user.updated_at).toLocaleDateString('ja-JP') %></span>
      </div>
    </div>
  </header>

  <section class="us__grid">
    <!-- ユーザー基本情報（表示→編集切替） -->
    <article class="card">
      <div class="card__head">
        <h2>ユーザー情報</h2>
      </div>

      <!-- 表示モード -->
      <dl class="kv" id="viewProfile">
        <div><dt>氏名</dt><dd><%= user.name %></dd></div>
        <div><dt>メール</dt><dd><%= user.email %></dd></div>
        <% if (!emailVerified) { %>
          <form method="POST" action="/auth/verify/resend" class="inline-form">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <button type="submit" class="btn btn--danger">
              メールアドレスを認証する
            </button>
          </form>
        <% } %>
        <% if (currentRoles.includes('admin')) { %>
        <div><dt>ロール</dt><dd><%= (user.roles||[]).join(', ') %></dd></div>
        <% } %>
        <!-- <% if (user.phone) { %><div><dt>電話</dt><dd><%= user.phone %></dd></div><% } %> -->
        <% if (emailError !== '') { %>
          <p class="error"><%= emailError; %></p>
        <% } %>
        <div class="us__actions">
          <button type="button" id="btnEdit" class="btn btn--primary">編集</button>
          <button type="button" id="btnCancel" class="btn btn--ghost" hidden>キャンセル</button>
          <button type="submit" form="profileForm" id="btnSave" class="btn btn--primary" hidden>保存</button>
        </div>
      </dl>

      <!-- 編集モード -->
      <form id="profileForm" class="form" action="/admin/users/<%= user.id %>" method="POST" hidden>
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <div class="grid2">
          <div class="field">
            <label for="name">氏名 *</label>
            <input id="name" name="name" type="text" required maxlength="60" value="<%= user.name %>">
          </div>
          <div class="field">
            <label for="email">メール *</label>
            <input id="email" name="email" type="email" required value="<%= user.email %>">
          </div>
        </div>
        <div class="grid2">
          <!-- <div class="field">
            <label for="phone">電話（任意）</label>
            <input id="phone" name="phone" type="tel" value="<%= user.phone || '' %>">
          </div> -->
          <% if (currentRoles.includes('admin')) { %>
          <div class="field">
            <label for="roles">ロール（管理用）</label>
            <input id="roles" name="roles" type="text" value="<%= (user.roles||[]).join(',') %>" <%= isSelf && !currentRoles.includes('admin') ? 'readonly' : '' %>>
            <p class="hint">カンマ区切り（例: buyer,seller）。本人は変更不可。</p>
          </div>
          <% } %>
        </div>
      </form>
    </article>

    <!-- パスワード変更（本人のみ / コンパクト） -->
    <% if (isSelf) { %>
    <article class="card card--tight">
      <div class="card__head">
        <h2>パスワード</h2>
      </div>
      <form id="pwForm" class="form-inline" action="/admin/users/<%= user.id %>/password" method="POST" novalidate>
        <% if (csrfToken) { %><input type="hidden" name="_csrf" value="<%= csrfToken %>"><% } %>
        <div class="field">
          <label for="curPw">現在のパスワード</label>
          <input id="curPw" name="current" type="password" required>
        </div>
        <div class="grid2">
          <div class="field">
            <label for="newPw">新しいパスワード</label>
            <input id="newPw" name="password" type="password" required minlength="8">
          </div>
          <div class="field">
            <label for="newPw2">確認</label>
            <input id="newPw2" name="passwordConfirm" type="password" required minlength="8">
          </div>
        </div>
        <div class="row-right">
          <button class="btn btn--primary" type="submit">変更</button>
        </div>
        <p class="error" id="pwErr" aria-live="polite"></p>
      </form>
    </article>

    <!-- セキュリティ設定（2FA） -->
    <article class="card" id="security">
      <div class="card__head">
        <h2>セキュリティ</h2>
      </div>
      <div class="card__body">
        <div style="margin-bottom: 24px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
            <div>
              <h3 style="font-size: 1rem; font-weight: 600; margin: 0 0 4px 0;">二要素認証（2FA）</h3>
              <p style="color: #666; font-size: 0.875rem; margin: 0; line-height: 1.5;">
                アカウントのセキュリティを強化するために、二要素認証を設定できます。<br>
                Google Authenticator、Authy、1Passwordなどの認証アプリを使用します。
              </p>
            </div>
          </div>

          <% if (user.two_factor_enabled) { %>
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #4caf50; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="color: #2e7d32;">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" fill="currentColor"/>
                </svg>
                <div>
                  <p style="margin: 0; color: #2e7d32; font-weight: 600; font-size: 0.95rem;">
                    二要素認証が有効になっています
                  </p>
                  <% if (user.two_factor_enabled_at) { %>
                    <p style="margin: 4px 0 0 0; color: #4caf50; font-size: 0.8rem;">
                      有効化日: <%= new Date(user.two_factor_enabled_at).toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                    </p>
                  <% } %>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <a href="/account/2fa/setup" class="btn btn--primary" style="text-decoration: none; flex: 1; min-width: 120px; text-align: center;">
                設定を変更
              </a>
              <!-- <button type="button" id="btnDisable2FA" class="btn btn--ghost" style="flex: 1; min-width: 120px;">
                2FAを無効化
              </button> -->
            </div>
          <% } else { %>
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <p style="margin: 0; color: #856404; font-size: 0.875rem; line-height: 1.5;">
                <strong>推奨:</strong> アカウントのセキュリティを強化するために、二要素認証の設定をお勧めします。
              </p>
            </div>
            <a href="/account/2fa/setup" class="btn btn--primary" style="display: inline-block; text-decoration: none;">
              🔒 2FAを設定する
            </a>
          <% } %>
        </div>

        <!-- 信頼済みデバイス（2FA有効時のみ表示） -->
        <% if (user.two_factor_enabled) { %>
          <!-- <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 20px;">
            <h3 style="font-size: 0.95rem; font-weight: 600; margin: 0 0 12px 0;">信頼済みデバイス</h3>
            <p style="color: #666; font-size: 0.875rem; margin: 0 0 12px 0;">
              「このデバイスを信頼する」を選択したデバイスは、30日間2FAをスキップできます。
            </p>
            <div id="trustedDevicesList" style="margin-bottom: 12px;">
              <p class="muted small" style="margin: 0;">読み込み中...</p>
            </div>
            <button type="button" id="btnRefreshDevices" class="btn btn--ghost small" style="font-size: 0.875rem;">
              更新
            </button>
          </div> -->
        <% } %>
      </div>
    </article>
    <% } %>

    <!-- 所属取引先（コンパクト＆視認性UP） -->
    <article class="card">
      <div class="card__head">
        <h2>所属取引先</h2>
      </div>

      <% if (!partner) { %>
        <p class="muted">個人アカウント</p>
        <% if (isSelf) { %>
          <button type="button" class="btn btn--primary" id="btnChangePartner">変更</button>
          <%- include('./_partner-modal', { csrfToken }) %>
        <% } %>
      <% } else { %>
        <div class="partner">
          <div class="partner__main">
            <div class="partner__name">
              <span class="partner__badge partner__badge--<%= partner.status %>">
                <%= partner.status==='active'?'有効':'無効' %>
              </span>
              <strong><%= partner.name %></strong>
              <span class="partner__type"><%= partner.type %></span>
            </div>
            <div class="partner__addr">
              〒<%= partner.postal_code || '—' %>　
              <%= [partner.prefecture, partner.city, partner.address1, partner.address2].filter(Boolean).join(' ') || '—' %>
            </div>
            <div class="partner__sub">
              <span>電話: <%= partner.phone || '—' %></span>
              <span class="sep">•</span>
              <span>請求: <%= partner.billing_email || '—' %></span>
            </div>
          </div>
          <div class="partner__action">
            <a class="btn btn--ghost" href="/admin/partners/<%= partner.id %>"><%= (currentRoles.includes('admin') || currentRoles.includes('seller')) ? '出品者情報(所属店舗)へ' : '所属店舗情報へ'; %></a>
            <% if (isSelf) { %>
              <button type="button" class="btn btn--primary" id="btnChangePartner">変更</button>
            <% } %>
          </div>
        </div>

        <!-- 取引先変更モーダル（検索→選択 or 新規作成）  -->
        <%- include('./_partner-modal', { csrfToken }) %>
      <% } %>
    </article>

    <!-- 住所（複数） -->
    <article class="card">
      <div class="card__head">
        <h2>住所</h2>
        <div class="row-gap">
          <button type="button" class="btn btn--primary" id="btnAddAddr">新しい住所</button>
          <button type="button" class="btn btn--ghost" id="btnAllAddr">すべての住所を見る</button>
        </div>
      </div>

      <% if (!addresses.length) { %>
        <p class="muted">住所はまだ登録されていません。</p>
      <% } else { %>
        <ul class="addr-list">
          <% addresses.slice(0,3).forEach(a => { %>
            <li class="addr">
              <div class="addr__head">
                <strong><%= a.full_name %></strong>
                <% if (a.is_default) { %><span class="pill">既定</span><% } %>
                <span class="muted"><%= a.address_type || 'shipping' %></span>
              </div>
              <div class="addr__body">
                〒<%= a.postal_code %>　
                <%= [a.prefecture, a.city, a.address_line1, a.address_line2].filter(Boolean).join(' ') %>　
                <span class="muted">TEL: <%= a.phone || '—' %></span>
              </div>
              <div class="addr__foot">
                <button class="link-btn" data-edit-addr="<%= a.id %>">編集</button>
                <button class="link-btn danger" data-del-addr="<%= a.id %>">削除</button>
              </div>
            </li>
          <% }) %>
        </ul>
        <% if (addresses.length > 3) { %>
          <p class="muted small">…他 <%= addresses.length - 3 %> 件</p>
        <% } %>
      <% } %>
    </article>
  </section>
</main>

<!-- 住所モーダル（新規/編集 共用） -->
<%- include('./_address-modal', { csrfToken }) %>

<script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>
<script src="/js/user-show.js"></script>
<%- include('../../partials/footer') %>