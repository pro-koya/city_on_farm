<%- include('../partials/header', { title: 'ç”Ÿä½“èªè¨¼ãƒ»ãƒ‘ã‚¹ã‚­ãƒ¼è¨­å®š', extraCSS: '', extraCSS2: '' }) %>

<style>
.webauthn-container {
  max-width: 800px;
  margin: 120px auto 64px;
  padding: 0 16px;
}

.webauthn-card {
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,.08);
  padding: 32px 28px;
  margin-bottom: 24px;
}

.webauthn-header {
  text-align: center;
  margin-bottom: 32px;
}

.webauthn-header h1 {
  margin: 0 0 8px;
  font-size: 1.8rem;
  color: #2B2B2B;
}

.webauthn-header p {
  color: #666;
  margin: 0;
  font-size: 0.95rem;
}

.feature-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 16px;
  margin: 24px 0;
}

.feature-item {
  display: flex;
  align-items: start;
  gap: 12px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.feature-icon {
  font-size: 24px;
  flex-shrink: 0;
}

.feature-content h3 {
  margin: 0 0 4px;
  font-size: 0.9rem;
  color: #2B2B2B;
}

.feature-content p {
  margin: 0;
  font-size: 0.8rem;
  color: #666;
  line-height: 1.4;
}

.device-list {
  margin: 24px 0;
}

.device-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  margin-bottom: 12px;
  transition: all 0.2s ease;
}

.device-item:hover {
  background: #f3f4f6;
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
}

.device-info {
  display: flex;
  align-items: center;
  gap: 16px;
  flex: 1;
}

.device-icon {
  font-size: 32px;
  color: #4C6B5C;
}

.device-details h3 {
  margin: 0 0 4px;
  font-size: 1rem;
  color: #2B2B2B;
}

.device-details p {
  margin: 0;
  font-size: 0.85rem;
  color: #666;
}

.device-actions {
  display: flex;
  gap: 8px;
}

.btn {
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: none;
  font-size: 0.9rem;
}

.btn-primary {
  background: #4C6B5C;
  color: #fff;
}

.btn-primary:hover {
  background: #3d5749;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(76, 107, 92, 0.3);
}

.btn-ghost {
  background: #fff;
  border: 1px solid #e5e7eb;
  color: #666;
}

.btn-ghost:hover {
  background: #f9fafb;
  border-color: #d1d5db;
}

.btn-danger {
  background: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.btn-danger:hover {
  background: #fecaca;
}

.btn-large {
  padding: 16px 32px;
  font-size: 1rem;
  width: 100%;
}

.info-box {
  background: #eff6ff;
  border: 1px solid #bfdbfe;
  border-radius: 12px;
  padding: 16px;
  margin: 24px 0;
}

.info-box-icon {
  font-size: 20px;
  margin-right: 8px;
}

.info-box p {
  margin: 0;
  color: #1e40af;
  font-size: 0.9rem;
  line-height: 1.6;
}

.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: #666;
}

.empty-state-icon {
  font-size: 64px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.empty-state h3 {
  margin: 0 0 8px;
  font-size: 1.1rem;
  color: #2B2B2B;
}

.empty-state p {
  margin: 0 0 24px;
  font-size: 0.9rem;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: #fff;
  border-radius: 16px;
  padding: 32px;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  margin-bottom: 24px;
}

.modal-header h2 {
  margin: 0 0 8px;
  font-size: 1.4rem;
}

.modal-header p {
  margin: 0;
  color: #666;
  font-size: 0.9rem;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  color: #2B2B2B;
}

.form-group input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #e5e7eb;
  border-radius: 10px;
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

.form-group input:focus {
  outline: none;
  border-color: #4C6B5C;
  box-shadow: 0 0 0 3px rgba(76, 107, 92, 0.1);
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
}

.modal-actions .btn {
  flex: 1;
}

.loading {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-left: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .feature-list {
    grid-template-columns: 1fr;
  }

  .device-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }

  .device-actions {
    width: 100%;
  }

  .device-actions .btn {
    flex: 1;
  }
}
</style>

<main class="webauthn-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="webauthn-card">
    <div class="webauthn-header">
      <h1>ğŸ” ç”Ÿä½“èªè¨¼ãƒ»ãƒ‘ã‚¹ã‚­ãƒ¼</h1>
      <p>FaceIDã€æŒ‡ç´‹èªè¨¼ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚­ãƒ¼ã§ãƒ¯ãƒ³ã‚¿ãƒƒãƒãƒ­ã‚°ã‚¤ãƒ³</p>
    </div>

    <!-- ç‰¹å¾´ç´¹ä»‹ -->
    <div class="feature-list">
      <div class="feature-item">
        <div class="feature-icon">âš¡</div>
        <div class="feature-content">
          <h3>é«˜é€Ÿèªè¨¼</h3>
          <p>ãƒ¯ãƒ³ã‚¿ãƒƒãƒã§æ•°ç§’ã§å®Œäº†</p>
        </div>
      </div>
      <div class="feature-item">
        <div class="feature-icon">ğŸ›¡ï¸</div>
        <div class="feature-content">
          <h3>é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
          <p>ãƒ•ã‚£ãƒƒã‚·ãƒ³ã‚°è€æ€§ã‚ã‚Š</p>
        </div>
      </div>
      <div class="feature-item">
        <div class="feature-icon">ğŸ“±</div>
        <div class="feature-content">
          <h3>ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ</h3>
          <p>iPhone/Android/PCå¯¾å¿œ</p>
        </div>
      </div>
    </div>

    <!-- æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ -->
    <div class="info-box">
      <p>
        <span class="info-box-icon">ğŸ’¡</span>
        <strong>ãƒ’ãƒ³ãƒˆ:</strong> è¤‡æ•°ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¦ãŠãã“ã¨ã§ã€ãƒ‡ãƒã‚¤ã‚¹ã‚’ç´›å¤±ã—ãŸéš›ã‚‚å®‰å¿ƒã§ã™ã€‚
      </p>
    </div>
  </div>

  <!-- ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ -->
  <div class="webauthn-card">
    <h2 style="margin: 0 0 20px; font-size: 1.2rem;">ç™»éŒ²æ¸ˆã¿ãƒ‡ãƒã‚¤ã‚¹</h2>

    <div id="deviceList" class="device-list">
      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
      <div id="deviceLoading" style="text-align: center; padding: 32px; color: #666;">
        <div class="loading" style="width: 32px; height: 32px; border-width: 3px; margin: 0 auto 16px;"></div>
        <p>ãƒ‡ãƒã‚¤ã‚¹ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>

    <button class="btn btn-primary btn-large" id="addDeviceButton">
      ï¼‹ æ–°ã—ã„ãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ 
    </button>
  </div>

  <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
  <div style="text-align: center; margin-top: 32px;">
    <a href="/account/2fa/setup" style="color: #4C6B5C; text-decoration: none; font-weight: 600;">
      â† ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®šã«æˆ»ã‚‹
    </a>
  </div>
</main>

<!-- ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="addDeviceModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>æ–°ã—ã„ãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ </h2>
      <p>ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã«åå‰ã‚’ä»˜ã‘ã¦ãã ã•ã„</p>
    </div>

    <form id="addDeviceForm">
      <div class="form-group">
        <label for="deviceName">ãƒ‡ãƒã‚¤ã‚¹å</label>
        <input
          type="text"
          id="deviceName"
          name="deviceName"
          placeholder="ä¾‹: iPhone 14, MacBook Pro"
          required
          maxlength="50"
        >
        <p style="color: #666; font-size: 0.8rem; margin: 6px 0 0;">
          è­˜åˆ¥ã—ã‚„ã™ã„åå‰ã‚’ä»˜ã‘ã¦ãã ã•ã„
        </p>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-ghost" id="cancelDeviceBtn">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="submit" class="btn btn-primary" id="addDeviceBtn">
          ç”Ÿä½“èªè¨¼ã§ç™»éŒ²
        </button>
      </div>
    </form>

    <div id="addDeviceError" style="display: none; background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 12px; margin-top: 16px;">
      <p style="color: #c33; margin: 0; font-size: 0.9rem;" id="addDeviceErrorText"></p>
    </div>
  </div>
</div>

<script type="module">
import { startRegistration } from 'https://unpkg.com/@simplewebauthn/browser@9.0.1/dist/bundle/index.js';

let credentials = [];
const csrfToken = '<%= csrfToken %>';

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’å–å¾—
async function loadDevices() {
  try {
    const response = await fetch('/api/webauthn/credentials', {
      credentials: 'same-origin'
    });
    const data = await response.json();

    if (data.success) {
      credentials = data.credentials;
      renderDeviceList();
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    console.error('Failed to load devices:', error);
    document.getElementById('deviceLoading').innerHTML = `
      <p style="color: #c33;">ãƒ‡ãƒã‚¤ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
    `;
  }
}

// ãƒ‡ãƒã‚¤ã‚¹ä¸€è¦§ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
function renderDeviceList() {
  const container = document.getElementById('deviceList');

  if (credentials.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ”</div>
        <h3>ãƒ‡ãƒã‚¤ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h3>
        <p>ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®ãƒ‡ãƒã‚¤ã‚¹ã‚’è¿½åŠ ã—ã¾ã—ã‚‡ã†</p>
      </div>
    `;
    return;
  }

  container.innerHTML = credentials.map((cred, index) => {
    const lastUsed = cred.last_used_at
      ? formatRelativeTime(new Date(cred.last_used_at))
      : 'æœªä½¿ç”¨';

    const deviceIcon = getDeviceIcon(cred.device_type);

    return `
      <div class="device-item">
        <div class="device-info">
          <div class="device-icon">${deviceIcon}</div>
          <div class="device-details">
            <h3>${escapeHtml(cred.device_name)}</h3>
            <p>æœ€çµ‚ä½¿ç”¨: ${lastUsed} â€¢ ç™»éŒ²æ—¥: ${formatDate(new Date(cred.created_at))}</p>
          </div>
        </div>
        <div class="device-actions">
          <button class="btn btn-ghost" data-action="rename" data-id="${cred.id}" data-name="${escapeHtml(cred.device_name)}">
            âœï¸ åå‰å¤‰æ›´
          </button>
          <button class="btn btn-danger" data-action="delete" data-id="${cred.id}" data-name="${escapeHtml(cred.device_name)}">
            ğŸ—‘ï¸ å‰Šé™¤
          </button>
        </div>
      </div>
    `;
  }).join('');

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼šãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  container.querySelectorAll('button[data-action]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const action = e.currentTarget.dataset.action;
      const id = e.currentTarget.dataset.id;
      const name = e.currentTarget.dataset.name;

      if (action === 'rename') {
        renameDevice(id, name);
      } else if (action === 'delete') {
        deleteDevice(id, name);
      }
    });
  });
}

// ãƒ‡ãƒã‚¤ã‚¹è¿½åŠ 
async function addDevice(event) {
  event.preventDefault();

  const deviceName = document.getElementById('deviceName').value.trim();
  const btn = document.getElementById('addDeviceBtn');
  const errorDiv = document.getElementById('addDeviceError');

  if (!deviceName) return;

  try {
    btn.disabled = true;
    btn.innerHTML = 'ç”Ÿä½“èªè¨¼ä¸­<span class="loading"></span>';
    errorDiv.style.display = 'none';

    // Step 1: ãƒãƒ£ãƒ¬ãƒ³ã‚¸å–å¾—
    const challengeResponse = await fetch('/api/webauthn/register/challenge', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    });
    const challengeData = await challengeResponse.json();

    if (!challengeData.success) {
      throw new Error(challengeData.error);
    }

    // Step 2: ãƒ–ãƒ©ã‚¦ã‚¶ã§ç”Ÿä½“èªè¨¼å®Ÿè¡Œ
    const credential = await startRegistration(challengeData.options);

    // Step 3: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ¤œè¨¼
    const verifyResponse = await fetch('/api/webauthn/register/verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin',
      body: JSON.stringify({
        response: credential,
        deviceName: deviceName
      })
    });
    const verifyData = await verifyResponse.json();

    if (!verifyData.success) {
      throw new Error(verifyData.error);
    }

    // æˆåŠŸ
    alert('âœ… ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼');
    closeAddDeviceModal();
    loadDevices();

  } catch (error) {
    console.error('Failed to add device:', error);
    errorDiv.style.display = 'block';
    document.getElementById('addDeviceErrorText').textContent =
      error.message || 'ãƒ‡ãƒã‚¤ã‚¹ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'ç”Ÿä½“èªè¨¼ã§ç™»éŒ²';
  }
}

// ãƒ‡ãƒã‚¤ã‚¹å‰Šé™¤
async function deleteDevice(credentialId, deviceName) {
  if (!confirm(`ã€Œ${deviceName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
    return;
  }

  try {
    const response = await fetch(`/api/webauthn/credentials/${credentialId}`, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin'
    });
    const data = await response.json();

    if (data.success) {
      alert('âœ… ãƒ‡ãƒã‚¤ã‚¹ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      loadDevices();
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    console.error('Failed to delete device:', error);
    alert('âŒ ãƒ‡ãƒã‚¤ã‚¹ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ‡ãƒã‚¤ã‚¹åå¤‰æ›´
async function renameDevice(credentialId, currentName) {
  const newName = prompt('æ–°ã—ã„ãƒ‡ãƒã‚¤ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', currentName);

  if (!newName || newName === currentName) return;

  try {
    const response = await fetch(`/api/webauthn/credentials/${credentialId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken
      },
      credentials: 'same-origin',
      body: JSON.stringify({ deviceName: newName })
    });
    const data = await response.json();

    if (data.success) {
      loadDevices();
    } else {
      throw new Error(data.error);
    }
  } catch (error) {
    console.error('Failed to rename device:', error);
    alert('âŒ åå‰ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰
function openAddDeviceModal() {
  document.getElementById('addDeviceModal').classList.add('active');
  document.getElementById('deviceName').value = '';
  document.getElementById('addDeviceError').style.display = 'none';
}

function closeAddDeviceModal() {
  document.getElementById('addDeviceModal').classList.remove('active');
}

// ãƒœã‚¿ãƒ³ã¨ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
document.getElementById('addDeviceButton').addEventListener('click', openAddDeviceModal);
document.getElementById('addDeviceForm').addEventListener('submit', addDevice);
document.getElementById('cancelDeviceBtn').addEventListener('click', closeAddDeviceModal);

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
document.getElementById('addDeviceModal').addEventListener('click', (e) => {
  if (e.target.id === 'addDeviceModal') {
    closeAddDeviceModal();
  }
});

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
function getDeviceIcon(deviceType) {
  const icons = {
    'mobile': 'ğŸ“±',
    'desktop': 'ğŸ’»',
    'tablet': 'ğŸ“±',
    'security_key': 'ğŸ”‘'
  };
  return icons[deviceType] || 'ğŸ”';
}

function formatRelativeTime(date) {
  const now = new Date();
  const diff = Math.floor((now - date) / 1000);

  if (diff < 60) return 'ãŸã£ãŸä»Š';
  if (diff < 3600) return `${Math.floor(diff / 60)}åˆ†å‰`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}æ™‚é–“å‰`;
  if (diff < 2592000) return `${Math.floor(diff / 86400)}æ—¥å‰`;
  return formatDate(date);
}

function formatDate(date) {
  return date.toLocaleDateString('ja-JP', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// åˆæœŸåŒ–
loadDevices();
</script>

<%- include('../partials/footer') %>
